<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Loove ‚Ä¢ Music App</title>
<style>
  :root{
    --bg:#0b0f14; --card:#121826; --muted:#9aa4b2; --text:#e6ecf2;
    --neon:#31e1ff; --accent:#ff2fb3;
    --amber:#ff9f1a; --amber-2:#ffb02e; --amber-3:#ff7a00;
    --ring:0 0 0 2px rgba(49,225,255,.35), 0 0 10px rgba(49,225,255,.35);
    --chip-bg:#0d1320;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:
      radial-gradient(1000px 600px at 10% -10%, rgba(49,225,255,.08), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, rgba(255,47,179,.07), transparent 60%),
      var(--bg); color:var(--text);
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    min-height:100dvh; padding-bottom:110px;
  }
  .wrap{width:100%; max-width:1060px; margin:0 auto; padding:16px}
  header{margin:4px 0 12px 0}
  .brand{display:flex; align-items:center; gap:10px}
  .brand .logo{font-weight:900; font-size:34px; letter-spacing:1px}
  .brand .logo .oo{
    background: linear-gradient(180deg,#111,#333);
    border-radius:50%; padding:4px 6px; box-shadow: inset 0 0 0 2px #000, 0 0 0 2px #222;
  }
  .tag{font-size:18px; font-weight:900; margin-top:6px}
  .tag span{background:linear-gradient(180deg,var(--amber-2),var(--amber-3));
    -webkit-background-clip:text; background-clip:text; color:transparent}
  .search{display:flex; gap:10px; align-items:center; margin:16px 0}
  .search input{
    flex:1; padding:16px 16px; border-radius:18px;
    border:1px solid rgba(255,255,255,.1); background:#0d1320; color:var(--text); font-size:16px;
  }
  .search input:focus{outline:none; box-shadow:var(--ring); border-color:transparent}
  .btn{appearance:none; border:1px solid rgba(255,255,255,.12); background:#121b2b;
    color:var(--text); padding:12px 16px; border-radius:14px; cursor:pointer; font-weight:700}
  .btn:hover{transform:translateY(-1px)}
  .btn-primary{border:none; background:linear-gradient(180deg,#ff8b24,#ff6a00); color:#0b0f14}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .chips{display:flex; gap:10px; flex-wrap:wrap; margin:6px 0 14px}

  /* PREMIUM: fundo do app, borda laranja, texto branco */
  .chip-premium{
    background:var(--chip-bg);
    color:var(--text);
    border:2px solid var(--amber-3);
    padding:10px 14px; border-radius:999px; font-weight:900; letter-spacing:.2px;
    box-shadow: 0 4px 16px rgba(255,140,0,.15);
  }
  .chip-premium:hover{ box-shadow: 0 0 0 2px rgba(255,140,0,.35), 0 8px 20px rgba(255,140,0,.25); transform:translateY(-1px) }

  .grid{display:grid; gap:12px; margin-top:10px}
  @media(min-width:1024px){ .grid{grid-template-columns: repeat(4, 1fr);} }
  @media(min-width:740px) and (max-width:1023px){ .grid{grid-template-columns: repeat(3, 1fr);} }
  @media(max-width:739px){ .grid{grid-template-columns: repeat(2, 1fr);} }

  .folderBtn{
    display:flex; align-items:center; justify-content:center; text-align:center;
    min-height:92px; padding:10px; border-radius:18px; cursor:pointer;
    background:linear-gradient(180deg, var(--amber-2), var(--amber-3));
    color:#0b0f14; font-weight:900; font-size:20px; text-transform:uppercase;
    border:2px solid #ffcc6b; box-shadow: 0 6px 20px rgba(255,140,0,.25);
    position:relative;
  }
  .folderBtn::after{ content:"‚Ä∫"; position:absolute; right:10px; top:8px; font-size:22px; font-weight:900; opacity:.9; }

  .muted{color:#9aa4b2}
  .card{background:linear-gradient(180deg,#121826,#0c111b); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px}

  .item{display:flex; align-items:center; gap:10px; background:#0f1726; border:1px solid rgba(255,255,255,.06); padding:12px; border-radius:12px}
  .iconbtn{border:1px solid rgba(255,255,255,.12); background:#0f1726; color:var(--text); width:36px;height:36px;border-radius:12px; display:grid;place-items:center; cursor:pointer}
  .iconbtn.play{background:linear-gradient(180deg,#ff8b24,#ff6a00); color:#0b0f14; border:none; font-weight:800}
  .like.active{color:var(--accent); box-shadow:0 0 0 2px rgba(255,47,179,.35),0 0 10px rgba(255,47,179,.35)}
  .title{font-weight:800}
  .spacer{flex:1}
  .pill{padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); color:#9aa4b2; font-size:12px}

  footer.player{
    position:fixed; left:0; right:0; bottom:0; z-index:10; background:rgba(11,15,20,.92); backdrop-filter: blur(12px);
    border-top:1px solid rgba(255,255,255,.08);
  }
  .wrapp{max-width:1060px;margin:0 auto;padding:12px}
  .trackname{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:55vw}
</style>
</head>
<body>
  <div class="wrap" id="app" style="display:none">
    <header>
      <div class="brand">
        <div class="logo">L<span class="oo">OO</span>VE <span class="muted" style="font-weight:700">music</span></div>
      </div>
      <div class="tag"><span>AQUI TODO MUNDO AMA M√öSICA</span></div>

      <div class="search">
        <input id="q" type="search" placeholder="üîé  Qual m√∫sica voc√™ quer ouvir?" />
        <button id="btnSearch" class="btn">Buscar</button>
        <button id="btnLogout" class="btn">Sair</button>
      </div>

      <!-- CHIPS PREMIUM -->
      <div class="chips" id="chipsPremium">
        <button class="chip-premium" data-p="top1000">TOP-1.000</button>
        <button class="chip-premium" data-p="summer">SUMMER ELETRO HITS</button>
        <button class="chip-premium" data-p="jovempan">JOVEM PAN</button>
        <button class="chip-premium" data-p="setsremix">SETS REMIX</button>
        <button class="chip-premium" data-p="secret">PLAYLIST SECRETA</button>
        <button class="chip-premium" data-p="flashbackgold">FLASHBACK GOLD</button>
        <button class="chip-premium" data-p="topmundogold">TOP - MUNDO GOLD</button>
      </div>

      <div class="row" style="gap:8px; margin:6px 0 8px">
        <span id="where" class="pill">Home</span>
        <button id="btnHome" class="btn">‚¨Ü Home</button>
        <button id="btnBack" class="btn">‚¨Ö Voltar pasta</button>
        <div class="spacer"></div>
        <button id="btnPlayAll" class="btn btn-primary">‚ñ∂ Tocar tudo da lista</button>
        <button id="btnMore" class="btn">Carregar mais</button>
      </div>
    </header>

    <!-- HOME -->
    <section id="viewHome">
      <div class="grid" id="foldersGrid"></div>
    </section>

    <!-- LISTA -->
    <section id="viewList" class="card" style="display:none">
      <div id="list"></div>
    </section>
  </div>

  <!-- LOGIN -->
  <section id="viewLogin" class="card" style="max-width:420px;margin:60px auto; display:none">
    <h2>Entrar</h2>
    <p class="muted">Digite seu PIN para acessar o app.</p>
    <form id="formLogin" class="row" onsubmit="return false;">
      <input id="pin" type="password" inputmode="numeric" minlength="3" maxlength="8" placeholder="Ex.: 2468" style="flex:1; padding:12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:#0d1320; color:#e6ecf2">
      <button id="btnLogin" class="btn btn-primary" type="submit">Entrar</button>
    </form>
    <div id="msg" class="muted" style="margin-top:8px"></div>
  </section>

  <!-- PLAYER -->
  <footer class="player">
    <div class="wrapp">
      <div class="row" style="gap:8px">
        <button id="btnPrev" class="btn">‚èÆ</button>
        <button id="btnMainPlay" class="btn btn-primary">‚ñ∂</button>
        <button id="btnNext" class="btn">‚è≠</button>
        <div class="spacer"></div>
        <div class="trackname" id="now">Nada tocando</div>
      </div>
      <audio id="audio" crossorigin="anonymous"></audio>
    </div>
  </footer>

<script>
  const TOKEN_KEY = "loove_token";
  const FAVORITES_KEY = "loove_favs_v1";
  const PREMIUM_PREFIX = "PREMIUM/"; // <<< IMPORTANT√çSSIMO: mai√∫sculas, igual ao Wasabi
  const el = id => document.getElementById(id);

  function show(id){ el(id).style.display = ""; }
  function hide(id){ el(id).style.display = "none"; }

  async function api(path, opts = {}) {
    const headers = Object.assign(
      { "Content-Type":"application/json" },
      opts.headers || {},
      localStorage.getItem(TOKEN_KEY) ? { Authorization: "Bearer " + localStorage.getItem(TOKEN_KEY) } : {}
    );
    const res = await fetch(path, Object.assign({}, opts, { headers }));
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw data || { error: "HTTP " + res.status };
    return data;
  }

  let currentPrefix = "";
  let nextToken = null;
  let items = [];
  let premiumFolders = [];

  // ===== Login =====
  async function ensureAuth(){
    try { await api("/api/me"); show("app"); hide("viewLogin"); }
    catch { hide("app"); show("viewLogin"); }
  }
  el("formLogin").addEventListener("submit", async ()=>{
    const pin = el("pin").value.trim();
    if(pin.length<3){ el("msg").textContent="Digite pelo menos 3 d√≠gitos."; return; }
    el("msg").textContent="Entrando...";
    try{
      const d = await api("/api/login",{ method:"POST", body: JSON.stringify({ pin }) });
      if(!d.token) throw d;
      localStorage.setItem(TOKEN_KEY, d.token);
      el("msg").textContent = "Login OK!";
      await boot();
    }catch(e){ el("msg").textContent = e?.error || "Falha no login"; }
  });
  el("btnLogout").onclick = ()=>{ localStorage.removeItem(TOKEN_KEY); location.reload(); };

  // ===== Home: pastas raiz =====
  async function loadRootFolders(){
    const g = el("foldersGrid"); g.innerHTML = "";
    const d = await api("/api/folders?prefix=");
    const folders = (d.folders || []);
    if(!folders.length){ g.innerHTML = `<div class="card">Nenhuma pasta encontrada na raiz do bucket.</div>`; return; }
    folders.forEach(f=>{
      const b = document.createElement("button");
      b.className = "folderBtn";
      b.textContent = (f.name || f.prefix || "pasta").replace(/\/$/,"");
      b.onclick = ()=> enterFolder(f.prefix);
      g.appendChild(b);
    });
  }

  // ===== Premium: carregar pastas reais e ligar chips (fuzzy) =====
  function slug(s){
    return (s||"")
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
  }
  function bestMatch(targetSlug, options){
    let hit = options.find(o => o.slug === targetSlug);
    if(hit) return hit;
    hit = options.find(o => o.slug.includes(targetSlug) || targetSlug.includes(o.slug));
    if(hit) return hit;
    let best=null, score=0;
    options.forEach(o=>{
      const common = o.slug.split("-").filter(p=> targetSlug.includes(p)).join("-");
      const sc = common.length;
      if(sc>score){ score=sc; best=o; }
    });
    return best;
  }

  async function loadPremiumFolders(){
    const d = await api("/api/folders?prefix="+encodeURIComponent(PREMIUM_PREFIX));
    premiumFolders = (d.folders || []).map(f=>{
      const name = (f.name||f.prefix).replace(new RegExp("^"+PREMIUM_PREFIX.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')), "").replace(/\/$/,"");
      return { prefix:f.prefix, name, slug: slug(name) };
    });

    const synonyms = {
      top1000: ["top-1000","top-1-000","top1000","top1k","top - mundo","top - brasil"], // ajuste conforme desejar
      summer: ["summer-eletro-hits","summer","eletro-hits","summer eletro hits"],
      jovempan: ["jovem-pan","jovempan","pan"],
      setsremix: ["sets-remix","sets","remix","dj-sets"],
      secret: ["playlist-secreta","secreta","secret"],
      flashbackgold: ["flashback-gold","flashback gold","flashback"],
      topmundogold: ["top - mundo gold","top-mundo-gold","top - mundo"]
    };

    document.querySelectorAll(".chip-premium").forEach(ch=>{
      ch.onclick = ()=>{
        const id = ch.getAttribute("data-p");
        const candidates = (synonyms[id]||[slug(ch.textContent)]);
        const want = candidates.map(slug);
        const options = premiumFolders;
        let match = null;
        for(const w of want){ match = bestMatch(w, options); if(match) break; }
        if(match){
          enterFolder(match.prefix);
        }else{
          alert("Playlist premium espec√≠fica n√£o encontrada. Abrindo a se√ß√£o premium para voc√™ escolher.");
          enterFolder(PREMIUM_PREFIX);
          console.log("Pastas premium:", premiumFolders.map(x=>x.name));
        }
      };
    });
  }

  // ===== Lista / navega√ß√£o =====
  function humanSize(bytes){
    if(!bytes && bytes!==0) return "";
    const u=["B","KB","MB","GB","TB"]; let i=0; let b=bytes;
    while(b>=1024 && i<u.length-1){ b/=1024; i++; }
    return b.toFixed(1)+" "+u[i];
  }
  function favs(){ try{ return JSON.parse(localStorage.getItem(FAVORITES_KEY)||"[]"); }catch{ return []; } }
  function setFavs(a){ localStorage.setItem(FAVORITES_KEY, JSON.stringify(a)); }
  function isFav(k){ return favs().includes(k); }
  function toggleFav(k){ const f=favs(); const i=f.indexOf(k); if(i>=0)f.splice(i,1); else f.push(k); setFavs(f); renderList(); }

  async function enterFolder(prefix){
    currentPrefix = prefix || "";
    nextToken = null; items = [];
    el("where").textContent = currentPrefix ? "Pasta: "+currentPrefix : "Home";
    hide("viewHome"); show("viewList");
    el("list").innerHTML = "";
    await loadMore();
  }
  async function loadMore(){
    const url = "/api/list?prefix="+encodeURIComponent(currentPrefix) + (nextToken ? "&token="+encodeURIComponent(nextToken) : "");
    const d = await api(url);
    nextToken = d.nextToken || null;
    (d.items||[]).forEach(it=> items.push(it));
    renderList();
    el("btnMore").disabled = !nextToken;
  }
  function renderList(){
    const L = el("list"); L.innerHTML = "";
    if(!items.length){ L.innerHTML = `<div class="card">Nenhuma m√∫sica nesta pasta.</div>`; return; }
    items.forEach(m=>{
      const row = document.createElement("div"); row.className="item";
      const like = document.createElement("button"); like.className="iconbtn like"+(isFav(m.key)?" active":""); like.textContent="‚ù§"; like.onclick=()=>toggleFav(m.key);
      const play = document.createElement("button"); play.className="iconbtn play"; play.textContent="‚ñ∂"; play.onclick=()=>playKey(m.key, m.name);
      const info = document.createElement("div"); info.style.minWidth="0";
      info.innerHTML = `<div class="title">${m.name}</div><div class="muted">${humanSize(m.size)}</div>`;
      row.appendChild(like); row.appendChild(play); row.appendChild(info); row.appendChild(document.createElement("div")).className="spacer";
      L.appendChild(row);
    });
  }

  // ===== Busca =====
  async function doSearch(){
    const q = el("q").value.trim();
    if(q.length<3){ alert("Digite pelo menos 3 letras."); return; }
    hide("viewHome"); show("viewList"); el("where").textContent = "Busca: "+q;
    const d = await api("/api/search?q="+encodeURIComponent(q)+"&prefix="+encodeURIComponent(currentPrefix||""));
    items = d.items || []; nextToken = null; renderList();
  }
  el("btnSearch").onclick = doSearch;
  el("q").addEventListener("keydown", e=>{ if(e.key==="Enter") doSearch(); });

  // ===== Player =====
  const audio = el("audio");
  function setNow(name){ el("now").textContent = name || "Nada tocando"; }
  async function playKey(key, name){
    const d = await api("/api/stream?key="+encodeURIComponent(key));
    audio.src = d.url; setNow(name || key.split("/").pop()); audio.play();
    el("btnMainPlay").textContent = "‚è∏";
  }
  el("btnMainPlay").onclick = ()=>{ if(!audio.src) return; if(audio.paused){ audio.play(); el("btnMainPlay").textContent="‚è∏"; } else { audio.pause(); el("btnMainPlay").textContent="‚ñ∂"; } };
  el("btnPrev").onclick = ()=> history.back?.();
  el("btnNext").onclick = ()=> {};
  audio.addEventListener("ended", ()=>{ el("btnMainPlay").textContent="‚ñ∂"; });

  // ===== Topo =====
  el("btnBack").onclick = ()=>{
    if(!currentPrefix) return;
    const p = currentPrefix.replace(/\/$/,"");
    const up = p.includes("/") ? p.split("/").slice(0,-1).join("/") + "/" : "";
    enterFolder(up);
  };
  el("btnHome").onclick = ()=>{ currentPrefix=""; nextToken=null; items=[]; el("where").textContent="Home"; show("viewHome"); hide("viewList"); };
  el("btnMore").onclick = loadMore;
  el("btnPlayAll").onclick = ()=>{ if(!items.length) return alert("Nada para tocar."); playKey(items[0].key, items[0].name); };

  // ===== Boot =====
  async function boot(){
    await ensureAuth();
    if(el("app").style.display!=="none"){
      await loadPremiumFolders();              // usa PREMIUM/
      await loadRootFolders();                 // raiz do bucket
      show("viewHome"); hide("viewList");
      el("where").textContent = "Home";
    }
  }
  boot();
</script>
</body>
</html>
