<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Loove ‚Ä¢ Music App</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121826; --muted:#9aa4b2; --text:#e6ecf2;
      --brand:#ff7a00; --neon:#31e1ff; --accent:#ff2fb3;
      --ring:0 0 0 2px rgba(49,225,255,.35), 0 0 10px rgba(49,225,255,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:radial-gradient(1000px 600px at 10% -10%, rgba(49,225,255,.08), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, rgba(255,47,179,.07), transparent 60%),
      var(--bg); color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:16px;
    }
    .wrap{width:100%; max-width:980px}
    header{display:flex; align-items:center; justify-content:space-between; margin-bottom:16px}
    h1{font-size:24px;margin:0;letter-spacing:.5px;display:flex;gap:10px;align-items:center}
    .badge{font-size:12px;color:var(--neon)}
    .card{
      background:linear-gradient(180deg,#121826,#0c111b);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px; padding:18px;
      box-shadow:0 10px 40px rgba(0,0,0,.25);
    }
    .grid{display:grid; gap:16px}
    .login{max-width:420px; margin:60px auto}
    label{font-size:14px; color:var(--muted)}
    input[type="password"], input[type="text"]{
      width:100%; padding:14px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.08);
      background:#0d1320; color:var(--text); outline:none; box-shadow:none; font-size:16px;
    }
    input:focus{box-shadow:var(--ring); border-color:transparent}
    .row{display:flex; gap:10px; align-items:center}
    .btn{
      appearance:none; border:1px solid rgba(255,255,255,.12); background:linear-gradient(180deg,#182235,#0f1726);
      color:var(--text); padding:12px 16px; border-radius:14px; cursor:pointer; transition:.2s; font-weight:600;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{border:none;background:linear-gradient(180deg,#ff8b24,#ff6a00); color:#0b0f14; font-weight:800}
    .muted{color:var(--muted); font-size:13px}
    .error{color:#ff6b6b; font-size:14px; margin-top:8px}
    .success{color:#7CFFA1; font-size:14px; margin-top:8px}
    .hidden{display:none}
    .topbar{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px}
    .iconbtn{
      border:1px solid rgba(255,255,255,.12); background:#0f1726; color:#0f1726;
      padding:10px 12px; border-radius:12px; cursor:pointer;
    }
    .pill{padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); color:var(--muted); font-size:12px}
    .list{display:grid; gap:8px}
    .item{display:flex; align-items:center; gap:10px; background:#0f1726; border:1px solid rgba(255,255,255,.06); padding:12px; border-radius:12px}
    .spacer{flex:1}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Loove <span class="badge">music</span></h1>
      <div id="authInfo" class="pill hidden"></div>
    </header>

    <!-- LOGIN -->
    <section id="viewLogin" class="login card">
      <h2 style="margin:0 0 6px 0;">Entrar</h2>
      <p class="muted" style="margin:0 0 14px 0;">Digite seu PIN para acessar o app.</p>

      <!-- usamos <form> para captar clique e Enter -->
      <form id="formLogin" class="grid" autocomplete="off">
        <div>
          <label for="pin">PIN</label>
          <div class="row">
            <input id="pin" name="pin" type="password" inputmode="numeric" minlength="3" maxlength="8" placeholder="Ex.: 2468" required />
            <button id="togglePin" type="button" class="iconbtn" title="Mostrar/ocultar">üëÅÔ∏è</button>
          </div>
        </div>
        <button id="btnLogin" type="submit" class="btn btn-primary">Entrar</button>
        <div id="msg" class="muted"></div>
      </form>
    </section>

    <!-- APP -->
    <section id="viewApp" class="card hidden">
      <div class="topbar">
        <div class="row" style="gap:8px">
          <span class="pill">Status: <b id="status">logado</b></span>
          <button id="btnCheck" class="btn">Testar sess√£o</button>
        </div>
        <button id="btnLogout" class="btn">Sair</button>
      </div>

      <div class="grid">
        <p class="muted">Voc√™ est√° logado. Clique em <b>Testar sess√£o</b> para validar o token.  
        Na pr√≥xima etapa vamos carregar pastas e m√∫sicas do Wasabi aqui dentro.</p>

        <div id="result" class="list"></div>
      </div>
    </section>
  </div>

  <script>
    const el = (id) => document.getElementById(id);
    const viewLogin = el("viewLogin");
    const viewApp = el("viewApp");
    const msg = el("msg");
    const authInfo = el("authInfo");
    const result = el("result");
    const formLogin = el("formLogin");
    const btnLogin = el("btnLogin");
    const inputPin = el("pin");
    const TOKEN_KEY = "loove_token";

    // util de fetch autenticado
    async function api(path, options = {}) {
      const token = localStorage.getItem(TOKEN_KEY);
      const headers = Object.assign(
        { "Content-Type": "application/json" },
        options.headers || {},
        token ? { Authorization: "Bearer " + token } : {}
      );
      const res = await fetch(path, Object.assign({}, options, { headers }));
      let data = {};
      try { data = await res.json(); } catch {}
      if (!res.ok) {
        throw data || { error: "Erro HTTP " + res.status };
      }
      return data;
    }

    function showLogin(){
      viewLogin.classList.remove("hidden");
      viewApp.classList.add("hidden");
      authInfo.classList.add("hidden");
      msg.textContent = "";
      inputPin.value = "";
      inputPin.focus();
    }
    function showApp(){
      viewLogin.classList.add("hidden");
      viewApp.classList.remove("hidden");
      authInfo.classList.remove("hidden");
      authInfo.textContent = "Logado ‚Ä¢ expira em 7 dias";
      el("status").textContent = "logado";
    }

    // inicia verificando sess√£o
    (async function init(){
      try { await api("/api/me"); showApp(); }
      catch { showLogin(); }
    })();

    // login (clique e Enter)
    async function doLogin(e){
      e?.preventDefault();
      const pin = inputPin.value.trim();
      if (pin.length < 3){
        msg.className="error";
        msg.textContent="Digite pelo menos 3 d√≠gitos.";
        return;
      }
      msg.className="muted";
      msg.textContent="Entrando...";
      btnLogin.disabled = true;
      console.log("[login] tentando...");

      try {
        const res = await fetch("/api/login", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ pin })
        });
        const data = await res.json().catch(()=> ({}));
        console.log("[login] resposta:", data);
        if (!res.ok || !data.token) throw data;
        localStorage.setItem(TOKEN_KEY, data.token);
        msg.className="success";
        msg.textContent="Login realizado!";
        showApp();
      } catch (e) {
        console.error("[login] erro:", e);
        msg.className="error";
        msg.textContent = e?.error || "Falha no login";
      } finally {
        btnLogin.disabled = false;
      }
    }
    formLogin.addEventListener("submit", doLogin);
    btnLogin.addEventListener("click", doLogin);

    // mostrar/ocultar PIN
    el("togglePin").addEventListener("click", () => {
      inputPin.type = inputPin.type === "password" ? "text" : "password";
      inputPin.focus();
    });

    // sair
    el("btnLogout").addEventListener("click", () => {
      localStorage.removeItem(TOKEN_KEY);
      result.innerHTML = "";
      showLogin();
    });

    // testar sess√£o
    el("btnCheck").addEventListener("click", async () => {
      result.innerHTML = "";
      try{
        const me = await api("/api/me");
        const div = document.createElement("div"); div.className="item";
        div.innerHTML = `<div>Usu√°rio logado ‚úÖ</div><div class="spacer"></div><code class="muted">${JSON.stringify(me.user)}</code>`;
        result.appendChild(div);
      }catch(e){
        const div = document.createElement("div"); div.className="item";
        div.innerHTML = `<div>Token inv√°lido ‚ùå</div><div class="spacer"></div><code class="error">${e?.error || "Erro"}</code>`;
        result.appendChild(div); el("status").textContent="deslogado";
      }
    });
  </script>
</body>
</html>
