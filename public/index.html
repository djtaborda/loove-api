<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Loove • Downloads offline</title>
<style>
  :root{
    --bg:#0b0f14;
    --card:#121826;
    --muted:#9aa4b2;
    --text:#e6ecf2;
    --accent:#ff2fb3;
    --amber:#ff9f1a;
    --amber-2:#ffb02e;
    --amber-3:#ff7a00;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:
      radial-gradient(1000px 600px at 10% -10%, rgba(49,225,255,.08), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, rgba(255,47,179,.07), transparent 60%),
      var(--bg); color:var(--text);
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    min-height:100dvh; padding-bottom:170px;
  }
  .wrap{width:100%; max-width:1060px; margin:0 auto; padding:16px}

  /* Header compacto, mantendo estética */
  header{display:flex; align-items:center; gap:10px; padding:12px 2px; margin-bottom:8px}
  .backbtn{appearance:none; border:none; background:transparent; color:#fff; cursor:pointer; width:40px; height:40px; border-radius:12px; display:grid; place-items:center}
  .backbtn:hover{filter:brightness(1.1)}
  .backbtn svg{width:26px; height:26px; stroke:#ffffff}
  h1{font-size:22px; margin:0; font-weight:900}
  .muted{color:var(--muted)}
  .card{background:linear-gradient(180deg,#121826,#0c111b); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px}

  /* Barra de status/uso */
  .status{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .pill{padding:8px 12px; border:1px solid rgba(255,255,255,.12); border-radius:999px; font-weight:800; background:#0d1320}
  .actions{margin-left:auto; display:flex; gap:8px}
  .btn{appearance:none; border:1px solid rgba(255,255,255,.12); background:#121b2b; color:#e6ecf2; padding:10px 14px; border-radius:14px; cursor:pointer; font-weight:800}
  .btn:hover{transform:translateY(-1px)}
  .btn-danger{background:linear-gradient(180deg,#ff5b5b,#cc2b2b); border:none; color:#fff}
  .btn-primary{border:none; background:linear-gradient(180deg,#ff8b24,#ff6a00); color:#0b0f14}

  /* Filtro local */
  .filter{display:flex; align-items:center; gap:10px; margin:10px 0}
  .filter input{flex:1; padding:12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:#0d1320; color:#e6ecf2}

  /* Lista de músicas */
  .list{margin:0; padding:0}
  .track{
    list-style:none; position:relative; display:flex; align-items:center; gap:10px;
    background:#0f1726; border:1px solid rgba(255,255,255,.06);
    border-radius:16px; padding:10px; margin:6px 0;
    box-shadow:0 3px 12px rgba(0,0,0,.14)
  }
  .t-left{display:grid; place-items:center}
  .t-play{
    width:40px; height:40px; border-radius:999px;
    background:linear-gradient(180deg,#ff9f1a,#ff6a00); border:none; color:#fff;
    display:grid; place-items:center; cursor:pointer; box-shadow:0 6px 18px rgba(255,140,0,.26); font-weight:900
  }
  .t-titleBox{min-width:0; display:flex; flex-direction:column; gap:2px}
  .t-title{font-weight:900; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .t-sub{font-size:11px; color:var(--muted)}
  .t-right{margin-left:auto; display:flex; align-items:center; gap:6px}
  .kebab{width:36px; height:36px; background:transparent; border:none; display:grid; place-items:center; cursor:pointer}
  .kebab svg{width:22px; height:22px; stroke:#ffffff}
  .t-menu{
    position:absolute; right:6px; top:52px; background:#0f1720; border:1px solid rgba(255,255,255,.12);
    padding:8px; border-radius:12px; display:none; min-width:220px; z-index:5; text-align:left;
  }
  .t-menu.open{display:block}
  .t-menu .menu-item{width:100%; text-align:left; padding:10px; border-radius:10px; color:#e6ecf2; background:transparent; border:1px solid transparent; cursor:pointer; font-weight:700}
  .t-menu .menu-item:hover{background:#141e2e; border-color:rgba(255,255,255,.06)}

  /* PLAYER fixo (igual identidade) */
  footer.player{position:fixed; left:0; right:0; bottom:0; z-index:20; background:transparent}
  .player-shell{max-width:980px; margin:0 auto 16px; padding:14px 16px; background:#0c1117; border:1px solid rgba(255,255,255,.08); border-radius:24px; box-shadow:0 24px 60px rgba(0,0,0,.55)}
  .p-top{display:flex; align-items:center; gap:10px; margin-bottom:8px}
  .track-title{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .track-right{margin-left:auto; display:flex; align-items:center; gap:8px}
  .kebab2{width:34px; height:34px; border-radius:10px; background:transparent; border:none; color:#e6ecf2; display:grid;place-items:center; cursor:pointer}
  .progress{width:100%; margin-bottom:10px}
  .seek{appearance:none; width:100%; height:6px; border-radius:999px; background:#2a3342; outline:none}
  .seek::-webkit-slider-thumb{appearance:none; width:18px; height:18px; border-radius:50%; background:#fff; border:2px solid #bbb}
  .seek::-moz-range-thumb{width:18px; height:18px; border-radius:50%; background:#fff; border:2px solid #bbb}
  .p-controls{display:flex; align-items:center; justify-content:space-between}
  .p-btn{width:44px; height:44px; border:none; background:transparent; color:#fff; display:grid; place-items:center; cursor:pointer; padding:0}
  .p-btn svg{width:28px; height:28px; stroke:#ffffff; opacity:.9}
  .p-btn:hover svg{opacity:1; filter:drop-shadow(0 0 4px rgba(255,255,255,.25))}
  .p-play{width:62px; height:62px; border-radius:999px; background:linear-gradient(180deg,#ff9f1a,#ff6a00); color:#0b0f14; border:none; display:grid; place-items:center; box-shadow:0 8px 30px rgba(255,140,0,.35)}
  .menu-pop{position:absolute; bottom:64px; right:54px; background:#0f1720; border:1px solid rgba(255,255,255,.12); padding:8px; border-radius:12px; display:none; min-width:240px}
  .menu-pop.open{display:block}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <button class="backbtn" id="goBack" title="Voltar para o app">
        <svg viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div>
        <h1>Downloads</h1>
        <div class="muted">Músicas salvas para tocar sem internet</div>
      </div>
    </header>

    <section class="card">
      <div class="status">
        <span class="pill" id="spaceUse">Uso: 0 MB / 500 MB</span>
        <span class="pill" id="countUse">Arquivos: 0</span>
        <div class="actions">
          <button class="btn" id="btnExport">Exportar lista</button>
          <button class="btn-danger" id="btnClearAll">Excluir tudo</button>
        </div>
      </div>

      <div class="filter">
        <input id="filter" type="search" placeholder="Filtrar por nome ou pasta..." />
        <button class="btn" id="btnSort">Ordenar por nome</button>
      </div>

      <ul id="list" class="list"></ul>
      <div id="empty" class="muted" style="display:none; margin-top:8px">Você ainda não baixou músicas.</div>
    </section>
  </div>

  <!-- PLAYER -->
  <footer class="player">
    <div class="player-shell">
      <div class="p-top">
        <div>
          <div class="track-title" id="nowTitle">Nada tocando</div>
          <div class="muted" id="nowFolder">—</div>
        </div>
        <div class="track-right">
          <div id="nowTime" class="muted">0:00 / 0:00</div>
          <button id="btnKebab" class="kebab2" title="Opções">⋯</button>
        </div>
      </div>
      <div class="progress"><input id="seek" class="seek" type="range" min="0" max="1000" value="0" /></div>
      <div class="p-controls">
        <button id="pPrev"   class="p-btn" title="Voltar">
          <svg viewBox='0 0 24 24' fill='none'><path d='M11 6l-7 6 7 6V6zM20 5v14' stroke-width='2.2' stroke-linejoin='round' stroke-linecap='round'/></svg>
        </button>
        <button id="pPlay"   class="p-play" title="Play/Pause">
          <svg viewBox='0 0 24 24' fill='none'><path d='M8 5l11 7-11 7V5z' stroke-width='2.2' stroke-linejoin='round' stroke='#ffffff'/></svg>
        </button>
        <button id="pNext"   class="p-btn" title="Avançar">
          <svg viewBox='0 0 24 24' fill='none'><path d='M13 6l7 6-7 6V6zM4 5v14' stroke-width='2.2' stroke-linejoin='round' stroke-linecap='round'/></svg>
        </button>
      </div>
      <div id="menuPop" class="menu-pop">
        <button class="btn" id="miShare" style="width:100%; text-align:left">Compartilhar</button>
      </div>
    </div>
    <audio id="audio" crossorigin="anonymous"></audio>
  </footer>

<script>
/* ===== Constantes iguais ao index (para manter compatibilidade) ===== */
const DOWNLOAD_INDEX_KEY = "loove_download_index_v1";
const LIMIT_BYTES = 500 * 1024 * 1024; // 500MB
const PLAYBACK_KEY = "loove_playback_v1";

const el = id => document.getElementById(id);
function formatTitle(filename=""){ let name = filename.replace(/\.[a-z0-9]{1,5}$/i,""); name = name.replace(/\s*[-–—]\s*/," – "); return name; }
function parentFolderFromKey(key=""){ const path = key.split("/"); path.pop(); return path.join("/") || "/"; }
function fmtTime(t){ if(!isFinite(t) || t<0) return "0:00"; const m=Math.floor(t/60); const s=Math.floor(t%60); return m+":"+(s<10?"0":"")+s; }

/* ===== IndexedDB (mesma base do index) ===== */
let dbPromise = null;
function idb(){
  if(dbPromise) return dbPromise;
  dbPromise = new Promise((resolve, reject)=>{
    const open = indexedDB.open("loove_downloads_db", 1);
    open.onupgradeneeded = ()=>{ open.result.createObjectStore("tracks"); };
    open.onsuccess = ()=> resolve(open.result);
    open.onerror = ()=> reject(open.error);
  });
  return dbPromise;
}
async function idbGet(key){
  const db = await idb(); return new Promise((res,rej)=>{
    const tx = db.transaction("tracks","readonly");
    const req = tx.objectStore("tracks").get(key);
    req.onsuccess = ()=> res(req.result||null);
    req.onerror = ()=> rej(req.error);
  });
}
async function idbDel(key){
  const db = await idb(); return new Promise((res,rej)=>{
    const tx = db.transaction("tracks","readwrite");
    tx.objectStore("tracks").delete(key);
    tx.oncomplete = ()=> res(true);
    tx.onerror = ()=> rej(tx.error);
  });
}

/* ===== Índice em localStorage ===== */
function loadIdx(){ try{ return JSON.parse(localStorage.getItem(DOWNLOAD_INDEX_KEY)||"{}"); }catch{ return {}; } }
function saveIdx(idx){ localStorage.setItem(DOWNLOAD_INDEX_KEY, JSON.stringify(idx||{})); }
function totalBytes(idx){ let s=0; for(const k in idx){ s+=Number(idx[k]?.size||0) } return s; }

/* ===== UI: lista e estado ===== */
let items = [];        // [{key, name, size, ts, folder}]
let view = [];         // resultado filtrado/ordenado
let curKey = null;     // key tocando
let objURL = null;     // URL.createObjectURL atual

const list = el("list");
const empty = el("empty");
const filterInput = el("filter");
const btnSort = el("btnSort");

function renderHeader(){
  const idx = loadIdx();
  const used = totalBytes(idx);
  const pct = Math.min(100, Math.round((used / LIMIT_BYTES)*100));
  el("spaceUse").textContent = `Uso: ${(used/1024/1024).toFixed(1)} MB / 500 MB (${pct}%)`;
  el("countUse").textContent = `Arquivos: ${Object.keys(idx).length}`;
}

function refreshData(){
  const idx = loadIdx();
  items = Object.keys(idx).map(k=>{
    const m = idx[k]||{};
    return { key:k, name:m.name||k.split("/").pop(), size:Number(m.size||0), ts:Number(m.ts||0), folder:m.folder||parentFolderFromKey(k) };
  }).sort((a,b)=> b.ts - a.ts); // mais recentes primeiro
  applyFilterSort();
}

let sortByName = false;
function applyFilterSort(){
  const q = (filterInput.value||"").toLowerCase();
  view = items.filter(it=>{
    const text = (it.name+" "+(it.folder||"")).toLowerCase();
    return !q || text.includes(q);
  });
  if(sortByName){ view.sort((a,b)=> a.name.localeCompare(b.name)); }
  renderList();
}

function renderList(){
  list.innerHTML = "";
  if(!view.length){
    empty.style.display = "";
    return;
  }
  empty.style.display = "none";

  view.forEach(it=>{
    const li = document.createElement("li");
    li.className = "track";
    li.setAttribute("data-key", it.key);

    const left = document.createElement("div");
    left.className = "t-left";
    const play = document.createElement("button");
    play.className = "t-play";
    play.innerHTML = "▶";
    play.title = "Tocar offline";
    play.onclick = ()=> playOffline(it.key, it.name);
    left.appendChild(play);

    const mid = document.createElement("div");
    mid.className="t-titleBox";
    const t1 = document.createElement("div");
    t1.className="t-title";
    t1.textContent = formatTitle(it.name);
    const t2 = document.createElement("div");
    t2.className="t-sub";
    const mb = (it.size/1024/1024).toFixed(1);
    const d = new Date(it.ts||Date.now());
    t2.textContent = `${it.folder} • ${mb} MB • ${d.toLocaleDateString()}`;
    mid.appendChild(t1); mid.appendChild(t2);

    const right = document.createElement("div");
    right.className="t-right";
    const keb = document.createElement("button");
    keb.className = "kebab";
    keb.innerHTML = `<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="5" r="2" stroke-width="2"/><circle cx="12" cy="12" r="2" stroke-width="2"/><circle cx="12" cy="19" r="2" stroke-width="2"/></svg>`;

    const menu = document.createElement("div");
    menu.className = "t-menu";
    menu.innerHTML = `
      <button class="menu-item miPlay">▶ Tocar</button>
      <button class="menu-item miDel">🗑️ Excluir download</button>
      <button class="menu-item miShare">🔗 Compartilhar</button>
      <button class="menu-item miInfo">ℹ️ Detalhes</button>
    `;

    keb.onclick = (e)=>{
      e.stopPropagation();
      document.querySelectorAll(".t-menu.open").forEach(m=>m.classList.remove("open"));
      menu.classList.toggle("open");
    };
    document.addEventListener("click",(ev)=>{ if(!li.contains(ev.target)) menu.classList.remove("open"); });

    menu.querySelector(".miPlay").onclick = ()=>{ menu.classList.remove("open"); playOffline(it.key, it.name); };
    menu.querySelector(".miDel").onclick = async ()=>{
      menu.classList.remove("open");
      if(!confirm("Excluir este download do dispositivo?")) return;
      await idbDel(it.key);
      const idx = loadIdx(); delete idx[it.key]; saveIdx(idx);
      if(curKey===it.key){ stopPlayback(); }
      renderHeader();
      refreshData();
    };
    menu.querySelector(".miShare").onclick = async ()=>{
      menu.classList.remove("open");
      try{
        if(navigator.share){ await navigator.share({ title: formatTitle(it.name), text:"Ouça no Loove (offline salvo no seu app).", url: location.origin }); }
        else{ await navigator.clipboard.writeText(location.origin); alert("Link copiado!"); }
      }catch{}
    };
    menu.querySelector(".miInfo").onclick = ()=>{
      menu.classList.remove("open");
      alert(`Arquivo: ${it.name}\nPasta: ${it.folder}\nTamanho: ${(it.size/1024/1024).toFixed(2)} MB\nSalvo em: ${new Date(it.ts).toLocaleString()}`);
    };

    right.appendChild(keb);

    li.appendChild(left);
    li.appendChild(mid);
    li.appendChild(right);
    li.appendChild(menu);
    list.appendChild(li);
  });
}

/* ===== Player offline simples ===== */
const audio = el("audio");
const seek  = el("seek");
const nowTitle  = el("nowTitle");
const nowFolder = el("nowFolder");
const nowTime   = el("nowTime");
const pPlay = el("pPlay");
const pPrev = el("pPrev");
const pNext = el("pNext");
const btnKebab = el("btnKebab");
const menuPop = el("menuPop");

function setPlayIcon(isPlaying){
  pPlay.innerHTML = isPlaying
   ? `<svg viewBox='0 0 24 24' fill='none'><path d='M8 5v14M16 5v14' stroke='#ffffff' stroke-width='2.6' stroke-linecap='round'/></svg>`
   : `<svg viewBox='0 0 24 24' fill='none'><path d='M8 5l11 7-11 7V5z' stroke-width='2.2' stroke-linejoin='round' stroke='#ffffff'/></svg>`;
}
function stopPlayback(){
  if(objURL){ URL.revokeObjectURL(objURL); objURL=null; }
  audio.removeAttribute("src");
  curKey=null;
  setPlayIcon(false);
  nowTitle.textContent="Nada tocando";
  nowFolder.textContent="—";
  nowTime.textContent="0:00 / 0:00";
  seek.value=0;
}
async function playOffline(key, name){
  try{
    const blob = await idbGet(key);
    if(!blob){ alert("Arquivo não encontrado no dispositivo."); return; }
    if(objURL){ URL.revokeObjectURL(objURL); objURL=null; }
    objURL = URL.createObjectURL(blob);
    audio.src = objURL;
    curKey = key;
    nowTitle.textContent = formatTitle(name||key.split("/").pop());
    nowFolder.textContent = parentFolderFromKey(key) || "—";
    await audio.play();
    setPlayIcon(true);
    // salva estado para retomada no app principal também
    try{
      const idx = loadIdx();
      const meta = idx[key]||{};
      localStorage.setItem(PLAYBACK_KEY, JSON.stringify({
        key, name: meta.name || name || key.split("/").pop(), pos: 0, playing: true
      }));
    }catch{}
  }catch(e){
    setPlayIcon(false);
    alert("Não foi possível tocar este arquivo agora.");
  }
}

audio.addEventListener("timeupdate", ()=>{
  const cur=audio.currentTime||0; const dur=audio.duration||0;
  nowTime.textContent = `${fmtTime(cur)} / ${fmtTime(dur)}`;
  seek.value = (dur>0&&!isNaN(dur)) ? Math.round((cur/dur)*1000) : 0;
});
audio.addEventListener("loadedmetadata", ()=>{
  const cur=audio.currentTime||0; const dur=audio.duration||0;
  nowTime.textContent = `${fmtTime(cur)} / ${fmtTime(dur)}`;
});
audio.addEventListener("ended", ()=> setPlayIcon(false));
seek.addEventListener("input", ()=>{
  const dur=audio.duration||0; if(dur<=0) return;
  audio.currentTime = (Number(seek.value)/1000)*dur;
});

pPlay.onclick = ()=>{ if(!audio.src) return; if(audio.paused){ audio.play(); setPlayIcon(true); } else { audio.pause(); setPlayIcon(false); } };
pPrev.onclick = ()=>{
  if(!view.length || !curKey) return;
  const i = view.findIndex(v=>v.key===curKey);
  if(i>0){ const n=view[i-1]; playOffline(n.key, n.name); }
};
pNext.onclick = ()=>{
  if(!view.length || !curKey) return;
  const i = view.findIndex(v=>v.key===curKey);
  if(i>=0 && i<view.length-1){ const n=view[i+1]; playOffline(n.key, n.name); }
};
btnKebab.onclick = (e)=>{ e.stopPropagation(); menuPop.classList.toggle("open"); };
document.addEventListener("click",(e)=>{ if(!menuPop.contains(e.target) && !btnKebab.contains(e.target)) menuPop.classList.remove("open"); });
el("miShare").onclick = async ()=>{
  try{
    if(navigator.share){ await navigator.share({ title: nowTitle.textContent, text: "Ouça no Loove", url: location.origin }); }
    else{ await navigator.clipboard.writeText(location.origin); alert("Link copiado!"); }
  }catch{}
};

/* ===== Controles: filtro, ordenação, excluir tudo, exportar ===== */
filterInput.addEventListener("input", applyFilterSort);
btnSort.addEventListener("click", ()=>{
  sortByName = !sortByName;
  btnSort.textContent = sortByName ? "Ordenar por data" : "Ordenar por nome";
  applyFilterSort();
});
el("btnClearAll").onclick = async ()=>{
  if(!confirm("Excluir TODOS os downloads do dispositivo?")) return;
  const idx = loadIdx();
  const keys = Object.keys(idx);
  for(const k of keys){ await idbDel(k); }
  localStorage.removeItem(DOWNLOAD_INDEX_KEY);
  stopPlayback();
  renderHeader();
  refreshData();
  alert("Downloads apagados.");
};
el("btnExport").onclick = ()=>{
  const idx = loadIdx();
  const arr = Object.keys(idx).map(k=>({
    key: k,
    name: idx[k]?.name||k.split("/").pop(),
    folder: idx[k]?.folder||"",
    size: idx[k]?.size||0,
    savedAt: new Date(idx[k]?.ts||Date.now()).toISOString()
  }));
  const blob = new Blob([JSON.stringify(arr,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "downloads_loove.json"; a.click();
  URL.revokeObjectURL(url);
};

/* ===== Navegação ===== */
el("goBack").onclick = ()=>{ location.href = "/"; };

/* ===== Boot ===== */
renderHeader();
refreshData();
</script>
</body>
</html>
