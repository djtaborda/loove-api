<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Loove music</title>
<link rel="icon" href="/favicon.ico">
<style>
:root{
  --bg: #0b101a;
  --bg-2: #0f1624;
  --card: #0e1522;
  --muted: #a9b6c7;
  --txt: #e8eef5;
  --brand: #ff8a00;
  --brand-2:#ff6a00;
  --stroke: rgba(255,255,255,.10);
  --soft: rgba(255,255,255,.06);
  --btn-bg: #121b2b;
  --green:#10d092;
  --red:#ff5a69;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background: radial-gradient(1200px 700px at 50% -10%, #1a2134 0%, #0b101a 60%);
  color:var(--txt); font: 500 16px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
}

/* ---------------- Header ---------------- */
.app{
  max-width: 1200px; margin: 0 auto; padding: clamp(14px, 2vw, 24px);
}
.header{
  display:flex; align-items:center; justify-content:center; position:relative;
  padding: 10px 0 2px;
}
.logo{
  display:flex; align-items:center; justify-content:center; gap:12px; text-align:center;
  flex-direction:column; width:100%;
}
.logo img{
  width: min(680px, 88vw); height:auto; display:block; object-fit:contain;
  filter: drop-shadow(0 10px 28px rgba(0,0,0,.35));
}
.logo .slogan{ margin-top:4px; font-weight:900; letter-spacing:.5px; color:#fff; text-transform:uppercase; opacity:.95; }

/* avatar canto superior direito */
.userbox{
  position:absolute; right:0; top:6px; display:flex; align-items:center; gap:8px; cursor:pointer;
}
.avatar{
  width:44px; height:44px; border-radius:50%;
  background: radial-gradient(circle at 30% 30%, #1f2a41, #0b101a 62%);
  border:1px solid var(--soft); display:grid; place-items:center;
}
.avatar svg{ width:24px; height:24px; stroke:#fff; }

/* ---------------- Search ---------------- */
.search{
  margin: 8px auto 18px; width: min(880px, 96%); position:relative;
  display:flex; gap:10px; align-items:center;
}
.input{
  flex:1; display:flex; align-items:center; gap:10px;
  background:linear-gradient(180deg, #0f1624, #0d1321);
  border:1px solid var(--stroke); border-radius:16px; padding:12px 14px 12px 14px;
  box-shadow: inset 0 -6px 18px rgba(0,0,0,.2);
}
.input svg{ width:22px; height:22px; stroke:#fff; opacity:.9 }
.input input{
  width:100%; outline:none; border:0; color:#eef3fa;
  background:transparent; font-weight:700;
}
.input input::placeholder{ color:#cdd6e3; opacity:.75; font-weight:800 }

.btn{
  background: linear-gradient(180deg, var(--btn-bg), #0e1522);
  color:#e6ecf2; border:1px solid var(--soft); border-radius:16px; padding:12px 16px;
  font-weight:800; cursor:pointer;
}
.btn:disabled{opacity:.55; cursor:not-allowed}
.btn.brand{
  background: linear-gradient(180deg, var(--brand), var(--brand-2));
  color:#111; border:0; box-shadow: 0 10px 30px rgba(255,138,0,.25);
}

/* ---------------- Premium chips ---------------- */
.premium{
  display:flex; flex-wrap:wrap; gap:12px; margin: 8px auto 14px; width:min(980px, 98%);
  justify-content:center;
}
.pill{
  padding:10px 16px; border-radius:999px;
  border:1px solid #ff8a00; color:#fff; background:transparent; font-weight:900; letter-spacing:.2px;
}
.pill:hover{ box-shadow: 0 0 0 1px #ff8a00; }

/* ---------------- Listagem ---------------- */
section#viewList{ width:min(1020px, 98%); margin: 6px auto 80px }
.list{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:12px }
.li{
  background: linear-gradient(180deg, #0f1624, #0b101a);
  border:1px solid var(--stroke); border-radius:18px; padding:12px 14px;
  display:grid; grid-template-columns: 44px 1fr auto; gap:10px; align-items:center;
}
.li .play{
  width:44px; height:44px; border-radius:22px; display:grid; place-items:center;
  background: linear-gradient(180deg, var(--brand), var(--brand-2));
  box-shadow: 0 10px 26px rgba(255,138,0,.25); border:0; cursor:pointer;
}
.li .play svg{ width:18px; height:18px; stroke:#111; }
.li .meta{ display:flex; flex-direction:column; gap:6px; min-width:0 }
.li .ttl{ font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.li .sub{ color:var(--muted); font-size:13px; display:flex; gap:12px; align-items:center }
.li .right{ display:flex; align-items:center; gap:10px }
.li .right .dur{ color:#b9c4d3; width:58px; text-align:right; font-weight:800 }
.iconbtn{
  width:44px; height:44px; border-radius:14px; background:transparent;
  border:1px solid var(--soft); display:grid; place-items:center; cursor:pointer
}
.iconbtn svg{ width:22px; height:22px; stroke:#fff; }
.kebab{ width:40px; height:40px; border-radius:12px; border:1px solid var(--soft); display:grid; place-items:center; cursor:pointer }
.kebab svg{ width:18px; height:18px; stroke:#fff }

/* menu por faixa */
.track-menu{
  position:fixed; inset:auto 8px 8px auto; width: min(92vw, 340px);
  background:linear-gradient(180deg,#0f1624,#0b101a); border:1px solid var(--stroke); border-radius:18px;
  z-index:55; box-shadow:0 12px 36px rgba(0,0,0,.45); padding:8px; display:none;
}
.track-menu.open{ display:block }
.track-menu .mi{
  width:100%; display:flex; gap:12px; align-items:center; padding:12px;
  background:transparent; border-radius:12px; border:1px solid transparent; color:#e6ecf2; font-weight:800
}
.track-menu .mi:hover{ background:#121b2b; border-color:var(--soft) }
.track-menu .mi svg{ width:22px; height:22px; stroke:#fff }

/* "Carregar mais" central no fim */
#loadMoreWrap{ margin-top:8px }
#btnMore{ border-radius:14px }

/* ---------------- Player ---------------- */
.player{
  position:fixed; left:0; right:0; bottom:0; z-index:40; padding: 10px 12px 12px;
  background: linear-gradient(180deg, #0b101a, #090e16); border-top:1px solid var(--stroke);
}
.player .row1{
  width:min(1100px, 97%); margin: 0 auto 8px; display:flex; align-items:center; gap:10px; justify-content:space-between
}
.now{ display:flex; gap:12px; align-items:center; min-width:0 }
.now .title{ font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: min(60vw, 900px) }
.now .folder{ color:var(--muted); font-size:12px; font-weight:800 }
.now .time{ font-weight:900; width:70px; text-align:right }

.bar{ width:min(1100px, 97%); margin: 2px auto 10px; display:flex; align-items:center; gap:12px }
.progress{
  position:relative; flex:1; height:8px; border-radius:8px;
  background: linear-gradient(90deg, #2b3448 0%, #3a4255 100%);
}
.progress .fill{
  position:absolute; inset:0 auto 0 0; width:0; background: linear-gradient(180deg,var(--brand), var(--brand-2));
  border-radius:8px;
}
.progress .knob{
  position:absolute; top:50%; left:0; transform: translate(-50%, -50%);
  width:18px; height:18px; border-radius:50%; background:#fff; box-shadow: 0 6px 16px rgba(0,0,0,.4); cursor:pointer
}

.controls{
  width:min(1100px, 97%); margin: 0 auto; display:grid; grid-template-columns: repeat(8, 1fr); gap:10px
}
.ctrl{
  height:48px; border-radius:16px; border:1px solid var(--soft); background:transparent; display:grid; place-items:center; cursor:pointer
}
.ctrl svg{ width:22px; height:22px; stroke:#fff }
.ctrl.brand{
  background: linear-gradient(180deg, var(--brand), var(--brand-2)); border:0;
  box-shadow: 0 12px 30px rgba(255,138,0,.25)
}
.ctrl.brand svg{ stroke:#111 }
.ctrl.on{ box-shadow: inset 0 0 0 2px rgba(255,255,255,.18) }

/* volume pop */
.volwrap{ position:relative }
.volpop{
  position:absolute; bottom:58px; left:50%; transform:translateX(-50%);
  background:#0f1624; border:1px solid var(--soft); border-radius:12px; padding:10px; display:none
}
.volpop input{ width:160px }

/* ---------------- Drawer menu ---------------- */
.backdrop{ position:fixed; inset:0; background:#0008; z-index:49 }
.backdrop[hidden]{ display:none }
.menu{
  position:fixed; top:0; right:0; height:100dvh; width:min(88vw, 320px);
  transform: translateX(100%); transition: transform .25s ease;
  background:linear-gradient(180deg,#0f1624,#0b101a);
  border-left:1px solid var(--stroke);
  box-shadow:-24px 0 60px rgba(0,0,0,.5);
  z-index:50; padding:12px 10px 16px;
}
.menu.open{ transform: translateX(0); }
.menu-list{display:flex; flex-direction:column; gap:6px}
.menu .mi{
  display:flex; align-items:center; gap:12px; width:100%;
  padding:12px 12px; border-radius:14px; border:1px solid transparent;
  background:transparent; color:#e6ecf2; font-weight:800; cursor:pointer;
}
.menu .mi:hover{ background:#121b2b; border-color:rgba(255,255,255,.06) }
.menu .mi .ico svg{ width:26px; height:26px; stroke:#ffffff; opacity:.95 }
.menu .sep{height:1px; background:rgba(255,255,255,.10); margin:8px 6px}

/* ---------------- Responsivo ---------------- */
@media (max-width: 560px){
  .logo img{ width: min(420px, 84vw) } /* menor no celular */
  .now .title{ max-width: 60vw }
  .controls{ grid-template-columns: repeat(8, 1fr) }
}
</style>
</head>
<body>
  <div class="app">

    <!-- Header / Logo -->
    <header class="header">
      <div class="logo">
        <picture>
          <source type="image/webp" srcset="/logolove.webp"/>
          <img src="/loove-logo.png" alt="Loove music"/>
        </picture>
        <div class="slogan">AQUI TODO MUNDO AMA MÚSICA</div>
      </div>

      <!-- Avatar (apenas ícone) -->
      <div class="userbox" id="userBtn" title="Abrir menu">
        <div class="avatar" id="avatarIcon"></div>
      </div>
    </header>

    <!-- Busca -->
    <div class="search">
      <div class="input">
        <span id="icoSearch"></span>
        <input id="q" placeholder="Qual música você quer ouvir?" autocomplete="off"/>
      </div>
      <button class="btn" id="btnSearch">Buscar</button>
    </div>

    <!-- Chips / Premium -->
    <div class="premium" id="rowPremium">
      <button class="pill" data-prem="TOP-1.000">TOP-1.000</button>
      <button class="pill" data-prem="SUMMER ELETRO HITS">SUMMER ELETRO HITS</button>
      <button class="pill" data-prem="JOVEM PAN">JOVEM PAN</button>
      <button class="pill" data-prem="SETS REMIX">SETS REMIX</button>
      <button class="pill" data-prem="PLAYLIST SECRETA">PLAYLIST SECRETA</button>
      <button class="pill" data-prem="FLASHBACK GOLD">FLASHBACK GOLD</button>
      <button class="pill" data-prem="TOP - MUNDO GOLD">TOP - MUNDO GOLD</button>
    </div>

    <!-- Lista -->
    <section id="viewList">
      <ul id="list" class="list"></ul>

      <!-- "Carregar mais" centralizado -->
      <div id="loadMoreWrap" style="display:flex; justify-content:center; margin:6px 0 4px;">
        <button id="btnMore" class="btn">Carregar mais</button>
      </div>
    </section>

  </div><!-- .app -->

  <!-- Menu por faixa -->
  <div class="track-menu" id="trackMenu">
    <button class="mi" data-act="share"><span class="ico" id="miShare"></span><span>Compartilhar</span></button>
    <button class="mi" data-act="fav"><span class="ico" id="miFav"></span><span>Favoritar</span></button>
    <button class="mi" data-act="dl"><span class="ico" id="miDl"></span><span>Baixar (Premium)</span></button>
    <button class="mi" data-act="mkpl"><span class="ico" id="miMkPl"></span><span>Criar playlist (Premium)</span></button>
    <button class="mi" data-act="addpl"><span class="ico" id="miAddPl"></span><span>Adicionar na playlist (Premium)</span></button>
  </div>

  <!-- Drawer / menu lateral -->
  <div class="menu" id="userMenu" aria-hidden="true">
    <nav class="menu-list">
      <button class="mi" data-act="home"       data-ico="home"><span class="ico"></span><span>Início</span></button>
      <button class="mi" data-act="account"    data-ico="user"><span class="ico"></span><span>Conta</span></button>
      <button class="mi" data-act="search"     data-ico="search"><span class="ico"></span><span>Buscar</span></button>
      <button class="mi" data-act="playlists"  data-ico="playlist"><span class="ico"></span><span>Playlists</span></button>
      <button class="mi" data-act="downloads"  data-ico="download"><span class="ico"></span><span>Downloads</span></button>
      <button class="mi" data-act="favs"       data-ico="star"><span class="ico"></span><span>Favoritos</span></button>
      <button class="mi" data-act="billing"    data-ico="card"><span class="ico"></span><span>Assinatura</span></button>
      <button class="mi" data-act="settings"   data-ico="settings"><span class="ico"></span><span>Configurações</span></button>
      <button class="mi" data-act="notify"     data-ico="bell"><span class="ico"></span><span>Notificações</span></button>
      <button class="mi" data-act="help"       data-ico="help"><span class="ico"></span><span>Ajuda</span></button>
      <div class="sep"></div>
      <button class="mi" data-act="logout"     data-ico="logout"><span class="ico"></span><span>Sair</span></button>
    </nav>
  </div>
  <div id="menuBackdrop" class="backdrop" hidden></div>

  <!-- Player -->
  <div class="player" id="playerBox">
    <div class="row1">
      <div class="now">
        <div class="title" id="nowTitle">—</div>
        <div class="folder" id="nowFolder">‎</div>
      </div>
      <div class="time" id="nowTime">00:00</div>
    </div>

    <div class="bar" id="seekBar">
      <div class="progress" id="progress">
        <div class="fill" id="fill"></div>
        <div class="knob" id="knob"></div>
      </div>
    </div>

    <div class="controls">
      <button class="ctrl" id="cHome"   title="Início"></button>
      <button class="ctrl" id="cFind"   title="Buscar"></button>
      <button class="ctrl" id="cPrev"   title="Voltar"></button>
      <button class="ctrl brand" id="cPlay" title="Play/Pause"></button>
      <button class="ctrl" id="cNext"   title="Avançar"></button>
      <button class="ctrl" id="cShuffle" title="Shuffle"></button>
      <button class="ctrl" id="cRepeat"  title="Repeat"></button>
      <div class="volwrap">
        <button class="ctrl" id="cVol" title="Volume"></button>
        <div class="volpop" id="volPop"><input id="volRange" type="range" min="0" max="1" step="0.01"></div>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   ÍCONES (flat, brancos); play/pause ficam laranja via .brand
   ========================================================= */
function icoSearch(){return `<svg viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke-width="2.2"/><path d="M20 20l-3.5-3.5" stroke-width="2.2" stroke-linecap="round"/></svg>`}
function icoHome(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M3 11.5 12 4l9 7.5" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 10.5V20h14v-9.5" stroke-width="2.2" stroke-linecap="round"/></svg>`}
function icoUser(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Z" stroke-width="2.2"/><path d="M4 21a8 8 0 0 1 16 0" stroke-width="2.2" stroke-linecap="round"/></svg>`}
function icoPrev(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M6 5v14" stroke-width="2.2" stroke-linecap="round"/><path d="M18 6l-8 6 8 6V6Z" stroke-width="2.2" stroke-linejoin="round"/></svg>`}
function icoPlay(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M7 5v14l12-7-12-7Z" stroke-width="2.2" stroke-linejoin="round"/></svg>`}
function icoPause(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M8 5v14M16 5v14" stroke-width="2.2" stroke-linecap="round"/></svg>`}
function icoNext(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M18 19V5" stroke-width="2.2" stroke-linecap="round"/><path d="M6 18l8-6-8-6v12Z" stroke-width="2.2" stroke-linejoin="round"/></svg>`}
function icoShuffle(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M16 3h5v5" stroke-width="2.2" stroke-linecap="round"/><path d="M3 7h7c2 0 3 2 4 4s2 4 4 4h3" stroke-width="2.2"/><path d="M21 16v5h-5" stroke-width="2.2" stroke-linecap="round"/><path d="M3 17h5c2 0 3-2 4-4" stroke-width="2.2"/></svg>`}
function icoRepeat(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M7 7h10a4 4 0 0 1 0 8H8" stroke-width="2.2"/><path d="M7 7 9 5M7 7l2 2" stroke-width="2.2" stroke-linecap="round"/><path d="M17 17H7a4 4 0 0 1 0-8h9" stroke-width="2.2"/><path d="M17 17l-2 2m2-2-2-2" stroke-width="2.2" stroke-linecap="round"/></svg>`}
function icoVol(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M4 10h4l6-4v12l-6-4H4z" stroke-width="2.2" stroke-linejoin="round"/><path d="M17 9a4 4 0 0 1 0 6" stroke-width="2.2"/></svg>`}
function icoHeart(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M12 21s-7-4.6-9-8.5A5.3 5.3 0 0 1 12 6a5.3 5.3 0 0 1 9 6.5C19 16.4 12 21 12 21Z" stroke-width="2.2" stroke-linejoin="round"/></svg>`}
function icoDots(){return `<svg viewBox="0 0 24 24" fill="none"><circle cx="5" cy="12" r="2" stroke-width="2"/><circle cx="12" cy="12" r="2" stroke-width="2"/><circle cx="19" cy="12" r="2" stroke-width="2"/></svg>`}
function icoShare(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7" stroke-width="2.2"/><path d="M12 3v12M7 8l5-5 5 5" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>`}
function icoFavSolid(){return `<svg viewBox="0 0 24 24" fill="none"><path d="m12 3 2.9 6 6.1.9-4.5 4.4 1.1 6.2L12 17l-5.6 3 1.1-6.2L3 9.9 9.1 9 12 3Z" stroke-width="2.2" fill="#fff" stroke="#fff"/></svg>`}
function icoDownload(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M12 3v12M8 11l4 4 4-4" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 21h16" stroke-width="2.2" stroke-linecap="round"/></svg>`}
function icoPlaylist(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M3 6h14M3 12h10M3 18h10" stroke-width="2.2" stroke-linecap="round"/><path d="M18 7v10a3 3 0 1 0 2-2V7h-2Z" stroke-width="2.2"/></svg>`}
function icoAdd(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke-width="2.2" stroke-linecap="round"/></svg>`}
function icoBell(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M6 8a6 6 0 1 1 12 0v6l2 2H4l2-2V8Z" stroke-width="2.2"/><path d="M9 20a3 3 0 0 0 6 0" stroke-width="2.2"/></svg>`}
function icoSettings(){return `<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="3" stroke-width="2.2"/><path d="M19.4 15a1.7 1.7 0 0 0 .3 1.8l.1.1-1.9 3.3- .2-.1a1.7 1.7 0 0 0-1.7-.4l-.2.1a1.7 1.7 0 0 0-1 1.4v.2H9.2v-.2a1.7 1.7 0 0 0-1-1.4l-.2-.1a1.7 1.7 0 0 0-1.7.4l-.2.1L4 16.9l.1-.1a1.7 1.7 0 0 0 .3-1.8l-.1-.2a1.7 1.7 0 0 0-1.4-1l-.3-.1V10.2l.3-.1c.6-.1 1.1-.5 1.4-1l.1-.2a1.7 1.7 0 0 0-.3-1.8l-.1-.1L6.1 3.7l.2.1c.5.2 1.1.2 1.7-.4l.2-.1a1.7 1.7 0 0 0 1-1.4V2.5h5.6v.2a1.7 1.7 0 0 0 1 1.4l.2.1c.5.2 1.1.2 1.7-.4l.2-.1 1.9 3.3-.1.1a1.7 1.7 0 0 0-.3 1.8l.1.2c.2.5.7.9 1.3 1l.3.1v3.3l-.3.1c-.6.1-1.1.5-1.3 1l-.1.2Z" stroke-width="1.1"/></svg>`}
function icoHelp(){return `<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke-width="2.2"/><path d="M9.5 9a3 3 0 1 1 5 2.2c-.7.6-1.3 1-1.3 2M12 17v.2" stroke-width="2.2" stroke-linecap="round"/></svg>`}
function icoLogout(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M9 21H6a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3" stroke-width="2.2"/><path d="M16 17l5-5-5-5M21 12H9" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>`}

/* aplica ícones nos lugares */
function setFlatIcons(){
  el("icoSearch").innerHTML = icoSearch();
  el("avatarIcon").innerHTML = icoUser();
  // player
  el("cHome").innerHTML = icoHome();
  el("cFind").innerHTML = icoSearch();
  el("cPrev").innerHTML = icoPrev();
  el("cPlay").innerHTML = icoPlay();
  el("cNext").innerHTML = icoNext();
  el("cShuffle").innerHTML = icoShuffle();
  el("cRepeat").innerHTML = icoRepeat();
  el("cVol").innerHTML = icoVol();
  // menu faixa
  el("miShare").innerHTML = icoShare();
  el("miFav").innerHTML   = icoHeart();
  el("miDl").innerHTML    = icoDownload();
  el("miMkPl").innerHTML  = icoPlaylist();
  el("miAddPl").innerHTML = icoAdd();
}
function setMenuIcons(){
  const map = {
    home: icoHome, user: icoUser, search: icoSearch, playlist: icoPlaylist,
    download: icoDownload, star: icoFavSolid, card: icoDownload, settings: icoSettings,
    bell: icoBell, help: icoHelp, logout: icoLogout
  };
  document.querySelectorAll('#userMenu .mi').forEach(btn=>{
    const k = btn.getAttribute('data-ico');
    const elIco = btn.querySelector('.ico');
    if(map[k] && elIco) elIco.innerHTML = map[k]();
  });
}

/* =========================================================
   Helpers
   ========================================================= */
const $ = (sel, p=document)=>p.querySelector(sel);
const el = id => document.getElementById(id);
function fmt(sec){ if(!isFinite(sec)||sec<=0) return "00:00"; const m=Math.floor(sec/60), s=Math.floor(sec%60); return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}` }
function fileTitle(name){
  // remove extensão e normaliza "Artista – Música" (hífen ou travessão)
  let base = name.replace(/\.[a-z0-9]{2,4}$/i,'');
  return base.replace(/\s*[-–—]\s*/,' – ');
}

/* =========================================================
   API
   ========================================================= */
const API = {
  async json(path, opt={}){
    const headers = {'Content-Type':'application/json'};
    const token = localStorage.getItem('loove_token');
    if(token) headers.Authorization = 'Bearer '+token;
    const r = await fetch(path,{...opt, headers: {...headers, ...(opt.headers||{})}});
    if(r.status===401) throw new Error('unauth');
    if(r.headers.get('content-type')?.includes('application/json')) return r.json();
    return r.text();
  },
  me(){ return this.json('/api/me') },
  login(pin){ return this.json('/api/login',{method:'POST', body: JSON.stringify({pin})}) },
  folders(prefix=''){ return this.json('/api/folders?prefix=' + encodeURIComponent(prefix)) },
  list(prefix='', token=null){ 
    const qs = new URLSearchParams({prefix}); if(token) qs.set('token', token);
    return this.json('/api/list?' + qs.toString());
  },
  stream(key){ return this.json('/api/stream?key='+encodeURIComponent(key)) }
}

/* =========================================================
   Estado da UI
   ========================================================= */
let currentPrefix = "";        // pasta atual
let nextToken = null;          // paginação
let queue = []; let idx = -1;  // fila de reprodução
const durationCache = new Map();
let favSet = new Set(JSON.parse(localStorage.getItem('favs')||'[]'));

/* =========================================================
   Boot
   ========================================================= */
(async function boot(){
  try{
    // se não tiver token, tenta logar com ACCESS_PIN do server (rota já trata)
    const me = await API.me().catch(async e=>{
      const {token} = await API.login(localStorage.getItem('last_pin')||'2468');
      localStorage.setItem('loove_token', token);
      return API.me();
    });
    // ok
  }catch(e){ console.warn('auth falhou', e); }

  // Ícones
  setFlatIcons(); setMenuIcons();

  // Eventos
  bindEvents();

  // carrega raiz
  loadPrefix("");
})();

/* =========================================================
   Eventos / Busca / Drawer
   ========================================================= */
function bindEvents(){
  el("btnSearch").addEventListener('click', ()=>doSearch());
  el("q").addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch() });

  el("btnMore").addEventListener('click', ()=>loadMore());

  // drawer
  const userBtn = el("userBtn"), userMenu = el("userMenu"), menuBackdrop = el("menuBackdrop");
  function closeMenu(){ userMenu.classList.remove("open"); menuBackdrop.hidden = true; }
  function openMenu(){ userMenu.classList.add("open"); menuBackdrop.hidden = false; }
  userBtn.addEventListener("click", (e)=>{ e.stopPropagation(); userMenu.classList.contains("open") ? closeMenu() : openMenu(); });
  menuBackdrop.addEventListener("click", closeMenu);
  document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeMenu(); });

  // premium chips
  $("#rowPremium").addEventListener('click', e=>{
    const b = e.target.closest('.pill'); if(!b) return;
    const folder = b.getAttribute('data-prem');  // ex: "FLASHBACK GOLD"
    loadPrefix('premium/'+folder+'/');
  });

  // player controls
  el("cHome").addEventListener('click', ()=>loadPrefix(""));
  el("cFind").addEventListener('click', ()=>el("q").focus());
  el("cPrev").addEventListener('click', prevTrack);
  el("cNext").addEventListener('click', nextTrack);
  el("cPlay").addEventListener('click', togglePlay);
  el("cShuffle").addEventListener('click', ()=>{ shuffleOn=!shuffleOn; el("cShuffle").classList.toggle('on', shuffleOn) });
  el("cRepeat").addEventListener('click', ()=>{ repeatOn=!repeatOn; el("cRepeat").classList.toggle('on', repeatOn) });
  el("cVol").addEventListener('click', ()=>{
    const p=el("volPop"); p.style.display = p.style.display==='block'?'none':'block';
  });
  el("volRange").addEventListener('input', e=>{ audio.volume = +e.target.value });

  // progress drag
  const prog = el("progress"), fill = el("fill"), knob = el("knob");
  function pctFromEvent(ev){
    const r = prog.getBoundingClientRect(); let x = (ev.clientX||ev.touches?.[0].clientX) - r.left; x=Math.max(0,Math.min(r.width,x)); return x/r.width;
  }
  function seekTo(p){ if(!isFinite(audio.duration)) return; audio.currentTime = p*audio.duration; }
  prog.addEventListener('click', e=>seekTo(pctFromEvent(e)));
  let dragging=false;
  const drag=(e)=>{ if(!dragging) return; const p=pctFromEvent(e); fill.style.width=(p*100)+'%'; knob.style.left=(p*100)+'%'; }
  knob.addEventListener('mousedown', ()=>dragging=true);
  document.addEventListener('mouseup', ()=>{ if(dragging){ dragging=false; seekTo(parseFloat(fill.style.width)/100 }});
  document.addEventListener('mousemove', drag);
  knob.addEventListener('touchstart', ()=>dragging=true, {passive:true});
  document.addEventListener('touchend', ()=>{ if(dragging){ dragging=false; seekTo(parseFloat(fill.style.width)/100 }} , {passive:true});
  document.addEventListener('touchmove', drag, {passive:false});
}

/* =========================================================
   Listagem
   ========================================================= */
async function loadPrefix(prefix=""){
  currentPrefix = prefix;
  nextToken = null; queue = []; idx = -1;
  el("list").innerHTML = "";
  await loadMore();
}
async function loadMore(){
  el("btnMore").disabled = true;
  const data = await API.list(currentPrefix, nextToken);
  nextToken = data.nextToken || null;
  renderItems(data.items||[]);
  el("btnMore").disabled = !nextToken ? true : false;
}
function renderItems(items){
  const ul = el("list");
  for(const it of items){
    if(!it.name?.toLowerCase().match(/\.(mp3|m4a|wav|flac|ogg)$/)) continue;
    const li = document.createElement('li');
    li.className = 'li';
    li.dataset.key = it.key;
    li.dataset.folder = currentPrefix || (it.key.includes('/') ? it.key.split('/').slice(0,-1).join('/')+'/' : '');
    li.innerHTML = `
      <button class="play" title="Tocar">${icoPlay()}</button>
      <div class="meta">
        <div class="ttl">${fileTitle(it.name)}</div>
        <div class="sub"><span>${li.dataset.folder || '—'}</span></div>
      </div>
      <div class="right">
        <div class="dur">--:--</div>
        <button class="iconbtn fav" title="Favoritar">${icoHeart()}</button>
        <button class="kebab" title="Opções">${icoDots()}</button>
      </div>`;
    ul.appendChild(li);

    // duração lazy
    fetchDurationLazy(it.key, li.querySelector('.dur'));

    // eventos
    li.querySelector('.play').addEventListener('click', ()=>playThis(it.key, fileTitle(it.name), li.dataset.folder));
    li.querySelector('.fav').addEventListener('click', e=>{
      e.stopPropagation();
      toggleFav(it.key, e.currentTarget);
    });
    li.querySelector('.kebab').addEventListener('click', e=>{
      e.stopPropagation();
      openTrackMenu(it.key, fileTitle(it.name));
    });

    queue.push({key: it.key, title: fileTitle(it.name), folder: li.dataset.folder});
  }
}
async function fetchDurationLazy(key, span){
  if(durationCache.has(key)){ span.textContent = fmt(durationCache.get(key)); return; }
  span.textContent = "—:—";
  try{
    const d = await API.stream(key);
    const a = new Audio();
    a.crossOrigin = "anonymous";
    a.preload = "metadata";
    a.src = d.url;
    const done = ()=>{
      const sec = isFinite(a.duration) ? a.duration : 0;
      durationCache.set(key, sec);
      span.textContent = fmt(sec);
      a.src = "";
    };
    a.addEventListener("loadedmetadata", done, { once:true });
    a.addEventListener("error", ()=>{ span.textContent="--:--"; }, { once:true });
  }catch{ span.textContent="--:--"; }
}

/* =========================================================
   Player
   ========================================================= */
const audio = new Audio(); audio.crossOrigin = "anonymous"; audio.preload = "none";
let repeatOn=false, shuffleOn=false;

function updateNow(title, folder){
  el("nowTitle").textContent = title||'—';
  el("nowFolder").textContent = folder||'';
}
async function playThis(key, title, folder){
  try{
    const d = await API.stream(key);
    audio.src = d.url; audio.play();
    idx = queue.findIndex(x=>x.key===key);
    updateNow(title, folder);
    el("cPlay").innerHTML = icoPause();
  }catch(e){ console.error(e); }
}
function togglePlay(){
  if(audio.paused){ audio.play(); el("cPlay").innerHTML = icoPause(); }
  else { audio.pause(); el("cPlay").innerHTML = icoPlay(); }
}
function nextTrack(){
  if(shuffleOn){
    idx = Math.floor(Math.random()*queue.length);
  }else{
    idx = (idx+1)%queue.length;
  }
  const it = queue[idx]; if(it) playThis(it.key, it.title, it.folder);
}
function prevTrack(){
  if(audio.currentTime>3){ audio.currentTime=0; return; }
  idx = (idx-1+queue.length)%queue.length;
  const it = queue[idx]; if(it) playThis(it.key, it.title, it.folder);
}
audio.addEventListener('timeupdate', ()=>{
  const p = isFinite(audio.duration) && audio.duration>0 ? audio.currentTime / audio.duration : 0;
  el("fill").style.width = (p*100)+'%';
  el("knob").style.left = (p*100)+'%';
  el("nowTime").textContent = fmt(audio.currentTime);
});
audio.addEventListener('ended', ()=>{
  if(repeatOn){ audio.currentTime = 0; audio.play(); return; }
  nextTrack();
});

/* =========================================================
   Favs + menu faixa
   ========================================================= */
function toggleFav(key, btn){
  if(favSet.has(key)){ favSet.delete(key) } else { favSet.add(key) }
  localStorage.setItem('favs', JSON.stringify([...favSet]));
  btn.innerHTML = favSet.has(key) ? icoFavSolid() : icoHeart();
}
let lastTrackKey = null;
function openTrackMenu(key, title){
  lastTrackKey = key;
  const m = el("trackMenu");
  m.classList.add('open');
  // simples posicionamento: perto do rodapé (evita cobrir)
  m.style.right = '8px'; m.style.bottom = '76px';
}
document.addEventListener('click', e=>{
  const m = el("trackMenu");
  if(m.classList.contains('open') && !m.contains(e.target)) m.classList.remove('open');
});
el("trackMenu").addEventListener('click', e=>{
  const b = e.target.closest('.mi'); if(!b) return;
  const act = b.getAttribute('data-act');
  if(act==='share'){ navigator.clipboard.writeText(location.origin + '/api/stream?key='+encodeURIComponent(lastTrackKey)); alert('Link copiado!'); }
  else if(act==='fav'){ toggleFav(lastTrackKey, document.querySelector(`.li[data-key="${CSS.escape(lastTrackKey)}"] .fav`)); }
  else { alert('Recurso premium em breve 😉'); }
  el("trackMenu").classList.remove('open');
});

/* =========================================================
   Busca
   ========================================================= */
async function doSearch(){
  const q = el("q").value.trim();
  if(!q){ el("q").focus(); return; }
  // estratégia simples: procurar dentro da pasta atual
  currentPrefix = currentPrefix || "";
  const res = await API.json('/api/search?q='+encodeURIComponent(q)+'&prefix='+encodeURIComponent(currentPrefix));
  el("list").innerHTML = ""; queue=[]; idx=-1; nextToken=null;
  renderItems(res.items||[]);
}

/* util */
</script>
</body>
</html>
