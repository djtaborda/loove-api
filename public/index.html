<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Loove ‚Ä¢ Music App</title>
<style>
  :root{
    --bg:#0b0f14; --card:#121826; --muted:#9aa4b2; --text:#e6ecf2;
    --neon:#31e1ff; --accent:#ff2fb3;
    --amber:#ff9f1a; --amber-2:#ffb02e; --amber-3:#ff7a00;
    --ring:0 0 0 2px rgba(49,225,255,.35), 0 0 10px rgba(49,225,255,.35);
    --chip-bg:#0d1320;
    --player-bg:#0d1218;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:
      radial-gradient(1000px 600px at 10% -10%, rgba(49,225,255,.08), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, rgba(255,47,179,.07), transparent 60%),
      var(--bg); color:var(--text);
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    min-height:100dvh; padding-bottom:160px; /* espa√ßo para o player */
  }
  .wrap{width:100%; max-width:1060px; margin:0 auto; padding:16px}

  /* ======= HEADER ======= */
  header{position:relative; padding-top:12px; margin-bottom:12px}
  .userbox{
    position:absolute; top:10px; right:10px; display:flex; align-items:center; gap:10px;
    cursor:pointer; user-select:none;
  }
  .userbox .name{font-weight:800; color:#e6ecf2; text-shadow:0 1px 0 #0008}
  .avatar{
    width:42px; height:42px; border-radius:50%;
    display:grid; place-items:center; color:#0b0f14; font-weight:900;
    background:linear-gradient(180deg,#fff,#d9d9d9);
    border:2px solid rgba(255,255,255,.25); box-shadow:0 2px 10px #0006;
  }
  .menu{
    position:absolute; top:56px; right:10px; width:260px;
    background:linear-gradient(180deg,#0f1624,#0b101a);
    border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:8px;
    box-shadow:0 20px 60px rgba(0,0,0,.5); display:none; z-index:50;
  }
  .menu.open{display:block}
  .menu h4{margin:6px 8px 8px; font-size:13px; color:#9aa4b2; font-weight:700}
  .menu .mi{
    width:100%; text-align:left; padding:12px 12px; border-radius:12px;
    background:transparent; border:1px solid transparent; color:#e6ecf2; font-weight:700;
    display:flex; align-items:center; gap:10px; cursor:pointer;
  }
  .menu .mi:hover{background:#121b2b; border-color:rgba(255,255,255,.06)}
  .menu .sep{height:1px; background:rgba(255,255,255,.08); margin:6px 4px}

  /* logo central */
  .logo-wrap{display:flex; align-items:center; justify-content:center; margin-top:20px}
  .logo{
    width:min(680px, 88%); height:auto; display:block; filter:drop-shadow(0 6px 24px rgba(0,0,0,.45));
  }
  .tagline{
    margin-top:8px; text-align:center; font-weight:900; letter-spacing:.4px;
    color:#fff; font-size:clamp(18px, 4.5vw, 28px);
  }

  /* busca (somente input) */
  .search{display:flex; gap:10px; align-items:center; margin:16px auto 8px; max-width:820px}
  .search input{
    flex:1; padding:16px 16px; border-radius:18px;
    border:1px solid rgba(255,255,255,.1); background:#0d1320; color:var(--text); font-size:16px;
  }
  .search input:focus{outline:none; box-shadow:var(--ring); border-color:transparent}

  /* chips premium */
  .chips{display:flex; gap:10px; flex-wrap:wrap; margin:10px auto 14px; justify-content:center}
  .chip-premium{
    background:var(--chip-bg); color:var(--text);
    border:2px solid var(--amber-3);
    padding:10px 14px; border-radius:999px; font-weight:900; letter-spacing:.2px;
    box-shadow: 0 4px 16px rgba(255,140,0,.15);
  }
  .chip-premium:hover{ box-shadow: 0 0 0 2px rgba(255,140,0,.35), 0 8px 20px rgba(255,140,0,.25); transform:translateY(-1px) }

  /* util bar */
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .btn{appearance:none; border:1px solid rgba(255,255,255,.12); background:#121b2b;
    color:var(--text); padding:12px 16px; border-radius:14px; cursor:pointer; font-weight:700}
  .btn:hover{transform:translateY(-1px)}
  .btn-primary{border:none; background:linear-gradient(180deg,#ff8b24,#ff6a00); color:#0b0f14}
  .pill{padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); color:#9aa4b2; font-size:12px}
  .spacer{flex:1}

  /* grid de pastas */
  .grid{display:grid; gap:12px; margin-top:10px}
  @media(min-width:1024px){ .grid{grid-template-columns: repeat(4, 1fr);} }
  @media(min-width:740px) and (max-width:1023px){ .grid{grid-template-columns: repeat(3, 1fr);} }
  @media(max-width:739px){ .grid{grid-template-columns: repeat(2, 1fr);} }
  .folderBtn{
    display:flex; align-items:center; justify-content:center; text-align:center;
    min-height:92px; padding:10px; border-radius:18px; cursor:pointer;
    background:linear-gradient(180deg, var(--amber-2), var(--amber-3));
    color:#0b0f14; font-weight:900; font-size:20px; text-transform:uppercase;
    border:2px solid #ffcc6b; box-shadow: 0 6px 20px rgba(255,140,0,.25);
    position:relative;
  }
  .folderBtn::after{ content:"‚Ä∫"; position:absolute; right:10px; top:8px; font-size:22px; font-weight:900; opacity:.9; }

  .muted{color:#9aa4b2}
  .card{background:linear-gradient(180deg,#121826,#0c111b); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px}
  .item{display:flex; align-items:center; gap:10px; background:#0f1726; border:1px solid rgba(255,255,255,.06); padding:12px; border-radius:12px}
  .iconbtn{border:1px solid rgba(255,255,255,.12); background:#0f1726; color:var(--text); width:36px;height:36px;border-radius:12px; display:grid;place-items:center; cursor:pointer}
  .iconbtn.play{background:linear-gradient(180deg,#ff8b24,#ff6a00); color:#0b0f14; border:none; font-weight:800}
  .like.active{color:var(--accent); box-shadow:0 0 0 2px rgba(255,47,179,.35),0 0 10px rgba(255,47,179,.35)}
  .title{font-weight:800}

  /* =================== PLAYER NOVO =================== */
  footer.player{
    position:fixed; left:0; right:0; bottom:0; z-index:20;
    background:transparent;
  }
  .player-shell{
    max-width:980px; margin:0 auto 16px; padding:14px 16px;
    background:#0c1117; border:1px solid rgba(255,255,255,.08);
    border-radius:24px; box-shadow:0 24px 60px rgba(0,0,0,.55);
  }
  .p-top{display:flex; align-items:center; gap:10px; margin-bottom:10px}
  .track-title{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .track-right{margin-left:auto; display:flex; align-items:center; gap:8px}
  .kebab{width:34px; height:34px; border-radius:10px; background:#0f1720; border:1px solid rgba(255,255,255,.12); color:#e6ecf2; display:grid;place-items:center; cursor:pointer}
  .kebab:hover{background:#141e2e}
  .track-sub{font-size:12px; color:#9aa4b2; margin-top:-2px}

  .progress{width:100%; margin-bottom:10px}
  .seek{appearance:none; width:100%; height:6px; border-radius:999px; background:#2a3342; outline:none}
  .seek::-webkit-slider-thumb{appearance:none; width:18px; height:18px; border-radius:50%; background:#fff; border:2px solid #bbb}
  .seek::-moz-range-thumb{width:18px; height:18px; border-radius:50%; background:#fff; border:2px solid #bbb}

  .p-controls{display:flex; align-items:center; justify-content:space-between}
  .p-btn{width:40px; height:40px; border-radius:12px; display:grid; place-items:center;
         background:#0f1720; border:1px solid rgba(255,255,255,.12); color:#fff; cursor:pointer}
  .p-btn:hover{background:#141e2e}
  .p-btn.active{box-shadow:0 0 0 2px rgba(49,225,255,.35)}
  .p-play{
    width:56px; height:56px; border-radius:999px; background:linear-gradient(180deg,#ff9f1a,#ff6a00);
    color:#0b0f14; border:none; font-size:18px; font-weight:900; box-shadow:0 8px 30px rgba(255,140,0,.35)
  }
  .vol-pop{position:absolute; bottom:64px; right:16px; background:#0f1720; border:1px solid rgba(255,255,255,.12); padding:8px; border-radius:12px; display:none}
  .vol-pop.open{display:block}
  .vol-range{appearance:none; width:160px; height:6px; border-radius:999px; background:#2a3342}
  .vol-range::-webkit-slider-thumb{appearance:none; width:14px; height:14px; border-radius:50%; background:#fff; border:2px solid #bbb}
  .vol-range::-moz-range-thumb{width:14px; height:14px; border-radius:50%; background:#fff; border:2px solid #bbb}

  .menu-pop{
    position:absolute; bottom:64px; right:54px; background:#0f1720;
    border:1px solid rgba(255,255,255,.12); padding:8px; border-radius:12px; display:none; min-width:240px
  }
  .menu-pop.open{display:block}
  .menu-item{width:100%; text-align:left; padding:10px 10px; border-radius:10px; color:#e6ecf2; background:transparent; border:1px solid transparent; cursor:pointer}
  .menu-item:hover{background:#141e2e; border-color:rgba(255,255,255,.06)}
</style>
</head>
<body>
  <div class="wrap" id="app" style="display:none">
    <header>
      <div class="userbox" id="userBtn" title="Abrir menu">
        <div class="name" id="userName">Usu√°rio</div>
        <div class="avatar">üë§</div>
        <div class="menu" id="userMenu" aria-hidden="true">
          <h4>MENU</h4>
          <button class="mi" data-act="home">üè† In√≠cio</button>
          <button class="mi" data-act="account">üë§ Conta</button>
          <button class="mi" data-act="search">üîé Buscar</button>
          <button class="mi" data-act="playlists">üéµ Playlists</button>
          <button class="mi" data-act="downloads">‚¨áÔ∏è Downloads</button>
          <button class="mi" data-act="favs">‚≠ê Favoritos</button>
          <button class="mi" data-act="billing">üí≥ Assinatura</button>
          <button class="mi" data-act="settings">‚öôÔ∏è Configura√ß√µes</button>
          <button class="mi" data-act="notify">üîî Notifica√ß√µes</button>
          <div class="sep"></div>
          <button class="mi" data-act="help">‚ùì Ajuda</button>
          <div class="sep"></div>
          <button class="mi" data-act="logout">üö™ Sair</button>
        </div>
      </div>

      <div class="logo-wrap">
        <picture>
          <source srcset="/logolove.webp" type="image/webp">
          <img class="logo" src="/loove-logo.png" alt="Loove music">
        </picture>
      </div>
      <div class="tagline">AQUI TODO MUNDO AMA M√öSICA</div>

      <div class="search">
        <input id="q" type="search" placeholder="Qual m√∫sica voc√™ quer ouvir? (aperte Enter)" />
      </div>

      <div class="chips" id="chipsPremium">
        <button class="chip-premium" data-p="top1000">TOP-1.000</button>
        <button class="chip-premium" data-p="summer">SUMMER ELETRO HITS</button>
        <button class="chip-premium" data-p="jovempan">JOVEM PAN</button>
        <button class="chip-premium" data-p="setsremix">SETS REMIX</button>
        <button class="chip-premium" data-p="secret">PLAYLIST SECRETA</button>
        <button class="chip-premium" data-p="flashbackgold">FLASHBACK GOLD</button>
        <button class="chip-premium" data-p="topmundogold">TOP - MUNDO GOLD</button>
      </div>

      <div class="row" style="gap:8px; margin:6px 0 8px">
        <span id="where" class="pill">Home</span>
        <button id="btnHome" class="btn">‚¨Ü Home</button>
        <button id="btnBack" class="btn">‚¨Ö Voltar pasta</button>
        <div class="spacer"></div>
        <button id="btnPlayAll" class="btn btn-primary">‚ñ∂ Tocar tudo da lista</button>
        <button id="btnMore" class="btn">Carregar mais</button>
      </div>
    </header>

    <!-- HOME -->
    <section id="viewHome">
      <div class="grid" id="foldersGrid"></div>
    </section>

    <!-- LISTA -->
    <section id="viewList" class="card" style="display:none">
      <div id="list"></div>
    </section>

    <!-- FAVORITOS -->
    <section id="viewFavs" class="card" style="display:none">
      <h3>Favoritos</h3>
      <div id="favList"></div>
    </section>
  </div>

  <!-- LOGIN -->
  <section id="viewLogin" class="card" style="max-width:420px;margin:60px auto; display:none">
    <h2>Entrar</h2>
    <p class="muted">Digite seu PIN para acessar o app.</p>
    <form id="formLogin" class="row" onsubmit="return false;">
      <input id="pin" type="password" inputmode="numeric" minlength="3" maxlength="8" placeholder="Ex.: 2468" style="flex:1; padding:12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:#0d1320; color:#e6ecf2">
      <button id="btnLogin" class="btn btn-primary" type="submit">Entrar</button>
    </form>
    <div id="msg" class="muted" style="margin-top:8px"></div>
  </section>

  <!-- =================== PLAYER NOVO =================== -->
  <footer class="player">
    <div class="player-shell">
      <!-- linha do t√≠tulo + tempo + ‚ãØ -->
      <div class="p-top">
        <div>
          <div class="track-title" id="nowTitle">Nada tocando</div>
          <div class="track-sub" id="nowFolder">‚Äî</div>
        </div>
        <div class="track-right">
          <div id="nowTime" class="muted">0:00 / 0:00</div>
          <button id="btnKebab" class="kebab" title="Op√ß√µes">‚ãØ</button>
        </div>
      </div>

      <!-- barra de progresso -->
      <div class="progress">
        <input id="seek" class="seek" type="range" min="0" max="1000" value="0" />
      </div>

      <!-- controles: In√≠cio, Buscar, Voltar, Play/Pause, Avan√ßar, Shuffle, Repeat, Volume -->
      <div class="p-controls">
        <button id="pHome"   class="p-btn" title="In√≠cio">‚åÇ</button>
        <button id="pSearch" class="p-btn" title="Buscar">üîé</button>
        <button id="pPrev"   class="p-btn" title="Voltar">‚èÆ</button>

        <button id="pPlay"   class="p-play" title="Play/Pause">‚ñ∂</button>

        <button id="pNext"   class="p-btn" title="Avan√ßar">‚è≠</button>
        <button id="pShuffle" class="p-btn" title="Shuffle">üîÄ</button>
        <button id="pRepeat"  class="p-btn" title="Repeat">üîÅ</button>

        <div style="position:relative">
          <button id="pVolume"  class="p-btn" title="Volume">üîä</button>
          <div id="volPop" class="vol-pop">
            <input id="volRange" class="vol-range" type="range" min="0" max="1" step="0.01" value="1" />
          </div>
        </div>
      </div>

      <!-- menu ‚ãØ -->
      <div id="menuPop" class="menu-pop">
        <button class="menu-item" id="miShare">Compartilhar</button>
        <button class="menu-item" id="miFav">Favoritar</button>
        <button class="menu-item" id="miDown">Baixar (Premium)</button>
        <button class="menu-item" id="miCreatePl">Criar playlist (Premium)</button>
        <button class="menu-item" id="miSavePl">Salvar playlist (Premium)</button>
      </div>
    </div>
    <audio id="audio" crossorigin="anonymous"></audio>
  </footer>

<script>
  const TOKEN_KEY = "loove_token";
  const FAVORITES_KEY = "loove_favs_v1";
  const PREMIUM_PREFIX = "PREMIUM/"; // mai√∫sculas
  const el = id => document.getElementById(id);

  function show(id){ el(id).style.display = ""; }
  function hide(id){ el(id).style.display = "none"; }

  async function api(path, opts = {}) {
    const headers = Object.assign(
      { "Content-Type":"application/json" },
      opts.headers || {},
      localStorage.getItem(TOKEN_KEY) ? { Authorization: "Bearer " + localStorage.getItem(TOKEN_KEY) } : {}
    );
    const res = await fetch(path, Object.assign({}, opts, { headers }));
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw data || { error: "HTTP " + res.status };
    return data;
  }

  /* ========== STATE ========== */
  let currentPrefix = "";
  let nextToken = null;
  let items = [];
  let premiumFolders = [];

  /* ========== LOGIN ========== */
  async function ensureAuth(){
    try {
      const me = await api("/api/me");
      const name = me?.user?.name || me?.user?.role || "Usu√°rio";
      el("userName").textContent = name;
      show("app"); hide("viewLogin");
    } catch {
      hide("app"); show("viewLogin");
    }
  }
  el("formLogin").addEventListener("submit", async ()=>{
    const pin = el("pin").value.trim();
    if(pin.length<3){ el("msg").textContent="Digite pelo menos 3 d√≠gitos."; return; }
    el("msg").textContent="Entrando...";
    try{
      const d = await api("/api/login",{ method:"POST", body: JSON.stringify({ pin }) });
      if(!d.token) throw d;
      localStorage.setItem(TOKEN_KEY, d.token);
      el("msg").textContent = "Login OK!";
      await boot();
    }catch(e){ el("msg").textContent = e?.error || "Falha no login"; }
  });

  /* ========== HOME: PASTAS ========== */
  async function loadRootFolders(){
    const g = el("foldersGrid"); g.innerHTML = "";
    const d = await api("/api/folders?prefix=");
    const folders = (d.folders || []);
    if(!folders.length){ g.innerHTML = `<div class="card">Nenhuma pasta encontrada na raiz do bucket.</div>`; return; }
    folders.forEach(f=>{
      const b = document.createElement("button");
      b.className = "folderBtn";
      b.textContent = (f.name || f.prefix || "pasta").replace(/\/$/,"");
      b.onclick = ()=> enterFolder(f.prefix);
      g.appendChild(b);
    });
  }

  function slug(s){
    return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
  }
  function bestMatch(targetSlug, options){
    let hit = options.find(o => o.slug === targetSlug);
    if(hit) return hit;
    hit = options.find(o => o.slug.includes(targetSlug) || targetSlug.includes(o.slug));
    if(hit) return hit;
    let best=null, score=0;
    options.forEach(o=>{
      const common = o.slug.split("-").filter(p=> targetSlug.includes(p)).join("-");
      const sc = common.length;
      if(sc>score){ score=sc; best=o; }
    });
    return best;
  }

  async function loadPremiumFolders(){
    const d = await api("/api/folders?prefix="+encodeURIComponent(PREMIUM_PREFIX));
    premiumFolders = (d.folders || []).map(f=>{
      const name = (f.name||f.prefix).replace(new RegExp("^"+PREMIUM_PREFIX.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')), "").replace(/\/$/,"");
      return { prefix:f.prefix, name, slug: slug(name) };
    });

    const synonyms = {
      top1000: ["top-1000","top-1-000","top1000","top1k","top - brasil","top - mundo"],
      summer: ["summer-eletro-hits","summer","eletro-hits","summer eletro hits"],
      jovempan: ["jovem-pan","jovempan","pan"],
      setsremix: ["sets-remix","sets","remix","dj-sets"],
      secret: ["playlist-secreta","secreta","secret"],
      flashbackgold: ["flashback-gold","flashback gold","flashback"],
      topmundogold: ["top - mundo gold","top-mundo-gold","top - mundo"]
    };

    document.querySelectorAll(".chip-premium").forEach(ch=>{
      ch.onclick = ()=>{
        const id = ch.getAttribute("data-p");
        const candidates = (synonyms[id]||[slug(ch.textContent)]);
        const want = candidates.map(slug);
        const options = premiumFolders;
        let match = null;
        for(const w of want){ match = bestMatch(w, options); if(match) break; }
        if(match){
          enterFolder(match.prefix);
        }else{
          alert("Playlist premium espec√≠fica n√£o encontrada. Abrindo a se√ß√£o premium para voc√™ escolher.");
          enterFolder(PREMIUM_PREFIX);
          console.log("Pastas premium:", premiumFolders.map(x=>x.name));
        }
      };
    });
  }

  /* ========== LISTA / NAVEGA√á√ÉO ========== */
  function humanSize(bytes){
    if(!bytes && bytes!==0) return "";
    const u=["B","KB","MB","GB","TB"]; let i=0; let b=bytes;
    while(b>=1024 && i<u.length-1){ b/=1024; i++; }
    return b.toFixed(1)+" "+u[i];
  }
  function favs(){ try{ return JSON.parse(localStorage.getItem(FAVORITES_KEY)||"[]"); }catch{ return []; } }
  function setFavs(a){ localStorage.setItem(FAVORITES_KEY, JSON.stringify(a)); }
  function isFav(k){ return favs().includes(k); }
  function toggleFav(k){ const f=favs(); const i=f.indexOf(k); if(i>=0)f.splice(i,1); else f.push(k); setFavs(f); renderList(); }

  async function enterFolder(prefix){
    currentPrefix = prefix || "";
    nextToken = null; items = [];
    el("where").textContent = currentPrefix ? "Pasta: "+currentPrefix : "Home";
    hide("viewHome"); hide("viewFavs"); show("viewList");
    el("list").innerHTML = "";
    await loadMore();
  }
  async function loadMore(){
    const url = "/api/list?prefix="+encodeURIComponent(currentPrefix) + (nextToken ? "&token="+encodeURIComponent(nextToken) : "");
    const d = await api(url);
    nextToken = d.nextToken || null;
    (d.items||[]).forEach(it=> items.push(it));
    renderList();
    el("btnMore").disabled = !nextToken;
  }
  function renderList(){
    const L = el("list"); L.innerHTML = "";
    if(!items.length){ L.innerHTML = `<div class="card">Nenhuma m√∫sica nesta pasta.</div>`; return; }
    items.forEach(m=>{
      const row = document.createElement("div"); row.className="item";
      const favB = document.createElement("button"); favB.className="iconbtn like"+(isFav(m.key)?" active":""); favB.textContent="‚ù§"; favB.onclick=()=>toggleFav(m.key);
      const play = document.createElement("button"); play.className="iconbtn play"; play.textContent="‚ñ∂"; play.onclick=()=>playKey(m.key, m.name);
      const info = document.createElement("div"); info.style.minWidth="0";
      info.innerHTML = `<div class="title">${formatTitle(m.name)}</div><div class="muted">${humanSize(m.size)}</div>`;
      row.appendChild(favB); row.appendChild(play); row.appendChild(info); row.appendChild(document.createElement("div")).className="spacer";
      L.appendChild(row);
    });
  }

  /* ========== BUSCA ========== */
  async function doSearch(){
    const q = el("q").value.trim();
    if(q.length<3){ alert("Digite pelo menos 3 letras."); return; }
    hide("viewHome"); hide("viewFavs"); show("viewList"); el("where").textContent = "Busca: "+q;
    const d = await api("/api/search?q="+encodeURIComponent(q)+"&prefix="+encodeURIComponent(currentPrefix||""));
    items = d.items || []; nextToken = null; renderList();
  }
  el("q").addEventListener("keydown", e=>{ if(e.key==="Enter") doSearch(); });

  /* ========== FORMATA T√çTULO ========== */
  function formatTitle(filename = ""){
    // remove extens√£o
    let name = filename.replace(/\.[a-z0-9]{1,5}$/i,"");
    // normaliza tra√ßo (‚Äì, -, ‚Äî)
    name = name.replace(/\s*[-‚Äì‚Äî]\s*/," ‚Äì ");
    return name;
  }
  function parentFolderFromKey(key=""){
    const path = key.split("/"); path.pop();
    return path.join("/") || "/";
  }

  /* ========== PLAYER ========== */
  const audio = el("audio");
  const seek = el("seek");
  const nowTitle = el("nowTitle");
  const nowFolder = el("nowFolder");
  const nowTime = el("nowTime");
  const pPlay = el("pPlay");
  const pPrev = el("pPrev");
  const pNext = el("pNext");
  const pHome = el("pHome");
  const pSearch = el("pSearch");
  const volPop = el("volPop");
  const volRange = el("volRange");
  const pVolume = el("pVolume");
  const pShuffle = el("pShuffle");
  const pRepeat = el("pRepeat");
  const btnKebab = el("btnKebab");
  const menuPop = el("menuPop");

  // estado do player
  let currentKey = null;
  let currentName = null;
  let shuffleOn = false;
  let repeatOn = false;

  function setNow(name, key){
    nowTitle.textContent = formatTitle(name || "");
    nowFolder.textContent = parentFolderFromKey(key || "") || "‚Äî";
  }
  function fmt(t){
    if(!isFinite(t) || t<0) return "0:00";
    const m = Math.floor(t/60); const s = Math.floor(t%60);
    return m+":"+(s<10?"0":"")+s;
  }
  function updateTimeUI(){
    const cur = audio.currentTime||0;
    const dur = audio.duration||0;
    nowTime.textContent = `${fmt(cur)} / ${fmt(dur)}`;
    if(dur>0 && !isNaN(dur)){
      seek.value = Math.round((cur/dur)*1000);
    }else{
      seek.value = 0;
    }
  }
  audio.addEventListener("timeupdate", updateTimeUI);
  audio.addEventListener("loadedmetadata", updateTimeUI);
  audio.addEventListener("ended", ()=>{
    pPlay.textContent = "‚ñ∂";
    if(repeatOn){ audio.currentTime=0; audio.play(); pPlay.textContent="‚è∏"; return; }
    // avan√ßar simples (ou aleat√≥rio)
    if(items.length){
      let idx = items.findIndex(it => it.key===currentKey);
      if(idx<0) idx=0;
      if(shuffleOn){
        const r = Math.floor(Math.random()*items.length);
        playKey(items[r].key, items[r].name);
      }else if(idx < items.length-1){
        playKey(items[idx+1].key, items[idx+1].name);
      }
    }
  });

  seek.addEventListener("input", ()=>{
    const dur = audio.duration||0; if(dur<=0) return;
    const val = Number(seek.value)/1000;
    audio.currentTime = val*dur;
    updateTimeUI();
  });

  pPlay.onclick = ()=>{
    if(!audio.src) return; 
    if(audio.paused){ audio.play(); pPlay.textContent="‚è∏"; } else { audio.pause(); pPlay.textContent="‚ñ∂"; }
  };
  pPrev.onclick = ()=>{
    if(items.length){
      let idx = items.findIndex(it => it.key===currentKey);
      if(idx>0) playKey(items[idx-1].key, items[idx-1].name);
    }
  };
  pNext.onclick = ()=>{
    if(items.length){
      let idx = items.findIndex(it => it.key===currentKey);
      if(idx < items.length-1) playKey(items[idx+1].key, items[idx+1].name);
    }
  };
  pHome.onclick = ()=> el("btnHome").click();
  pSearch.onclick = ()=> el("q").focus();

  pShuffle.onclick = ()=>{ shuffleOn = !shuffleOn; pShuffle.classList.toggle("active", shuffleOn); };
  pRepeat.onclick = ()=>{ repeatOn = !repeatOn; pRepeat.classList.toggle("active", repeatOn); audio.loop = repeatOn; };

  pVolume.onclick = (e)=>{ e.stopPropagation(); volPop.classList.toggle("open"); menuPop.classList.remove("open"); };
  volRange.addEventListener("input", ()=>{ audio.volume = Number(volRange.value); });
  document.addEventListener("click", (ev)=>{
    if(!volPop.contains(ev.target) && !pVolume.contains(ev.target)) volPop.classList.remove("open");
    if(!menuPop.contains(ev.target) && !btnKebab.contains(ev.target)) menuPop.classList.remove("open");
  });

  btnKebab.onclick = (e)=>{ e.stopPropagation(); menuPop.classList.toggle("open"); volPop.classList.remove("open"); };

  // Itens do menu ‚ãØ
  el("miShare").onclick = async ()=>{
    try{
      if(navigator.share){
        await navigator.share({ title: nowTitle.textContent, text: "Ou√ßa no Loove", url: location.href });
      }else{
        await navigator.clipboard.writeText(location.href);
        alert("Link copiado!");
      }
    }catch{}
  };
  el("miFav").onclick = ()=>{
    if(currentKey) toggleFav(currentKey);
    alert("Favorito atualizado.");
  };
  el("miDown").onclick = ()=> alert("Recurso Premium.");
  el("miCreatePl").onclick = ()=> alert("Recurso Premium.");
  el("miSavePl").onclick = ()=> alert("Recurso Premium.");

  async function playKey(key, name){
    const d = await api("/api/stream?key="+encodeURIComponent(key));
    audio.src = d.url;
    currentKey = key; currentName = name;
    setNow(name, key);
    audio.play(); pPlay.textContent = "‚è∏";
  }

  /* ATALHOS EXTRA */
  el("btnBack").onclick = ()=>{
    if(!currentPrefix) return;
    const p = currentPrefix.replace(/\/$/,"");
    const up = p.includes("/") ? p.split("/").slice(0,-1).join("/") + "/" : "";
    enterFolder(up);
  };
  el("btnHome").onclick = ()=>{ currentPrefix=""; nextToken=null; items=[]; el("where").textContent="Home"; show("viewHome"); hide("viewList"); hide("viewFavs"); };
  el("btnMore").onclick = loadMore;
  el("btnPlayAll").onclick = ()=>{ if(!items.length) return alert("Nada para tocar."); playKey(items[0].key, items[0].name); };

  function renderFavs(){
    const cont = el("favList");
    cont.innerHTML = "";
    const f = favs();
    if(!f.length){ cont.innerHTML = `<div class="muted">Voc√™ ainda n√£o marcou favoritos.</div>`; return; }
    f.forEach(k=>{
      const row = document.createElement("div"); row.className="item";
      const nm = k.split("/").pop();
      const like = document.createElement("button"); like.className="iconbtn like active"; like.textContent="‚ù§"; like.onclick=()=>{ toggleFav(k); renderFavs(); };
      const play = document.createElement("button"); play.className="iconbtn play"; play.textContent="‚ñ∂"; play.onclick=()=>playKey(k, nm);
      const info = document.createElement("div"); info.style.minWidth="0";
      info.innerHTML = `<div class="title">${formatTitle(nm)}</div><div class="muted">${k}</div>`;
      row.appendChild(like); row.appendChild(play); row.appendChild(info); row.appendChild(document.createElement("div")).className="spacer";
      cont.appendChild(row);
    });
  }

  /* MENU DO USU√ÅRIO */
  const userBtn = el("userBtn");
  const userMenu = el("userMenu");
  function closeMenu(){ userMenu.classList.remove("open"); userMenu.setAttribute("aria-hidden","true"); }
  function openMenu(){ userMenu.classList.add("open"); userMenu.setAttribute("aria-hidden","false"); }
  userBtn.addEventListener("click", (e)=>{
    e.stopPropagation();
    if(userMenu.classList.contains("open")) closeMenu(); else openMenu();
  });
  document.addEventListener("click", (ev)=>{
    if(!userMenu.contains(ev.target) && !userBtn.contains(ev.target)) closeMenu();
  });
  userMenu.addEventListener("click", (e)=>{
    if(!(e.target instanceof HTMLElement)) return;
    const act = e.target.getAttribute("data-act");
    if(!act) return;
    closeMenu();
    switch(act){
      case "home": el("btnHome").click(); break;
      case "account": alert("Conta: em breve."); break;
      case "search": el("q").focus(); break;
      case "playlists": enterFolder(PREMIUM_PREFIX); break;
      case "downloads": alert("Downloads: em breve."); break;
      case "favs": renderFavs(); hide("viewHome"); hide("viewList"); show("viewFavs"); el("where").textContent="Favoritos"; break;
      case "billing": alert("Assinatura: em breve."); break;
      case "settings": alert("Configura√ß√µes: em breve."); break;
      case "notify": alert("Notifica√ß√µes: em breve."); break;
      case "help": alert("Ajuda: suporte@loove.app"); break;
      case "logout": localStorage.removeItem(TOKEN_KEY); location.reload(); break;
    }
  });

  /* BOOT */
  async function boot(){
    await ensureAuth();
    if(el("app").style.display!=="none"){
      await loadPremiumFolders();
      await loadRootFolders();
      show("viewHome"); hide("viewList"); hide("viewFavs");
      el("where").textContent = "Home";
    }
  }
  boot();
</script>
</body>
</html>
