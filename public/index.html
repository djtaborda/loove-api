<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Loove • Music App</title>
<style>
  :root{
    --bg:#0b0f14; --card:#121826; --muted:#9aa4b2; --text:#e6ecf2;
    --accent:#ff2fb3;
    --amber:#ff9f1a; --amber-2:#ffb02e; --amber-3:#ff7a00;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:
      radial-gradient(1000px 600px at 10% -10%, rgba(49,225,255,.08), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, rgba(255,47,179,.07), transparent 60%),
      var(--bg); color:var(--text);
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    min-height:100dvh; padding-bottom:170px;
  }
  .wrap{width:100%; max-width:1060px; margin:0 auto; padding:16px}

  /* ======= HEADER ======= */
  header{position:relative; padding-top:12px; margin-bottom:12px}
  .userbox{position:absolute; top:10px; right:10px; display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none}
  .userbox .name{display:none} /* não mostrar texto do usuário */
  .avatar{width:44px; height:44px; display:grid; place-items:center; border-radius:50%}
  .avatar svg{width:30px; height:30px; stroke:#ffffff; opacity:.95}

  /* ===== Drawer lateral ===== */
  .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; z-index:60}
  .backdrop.open{display:block}
  .menu{position:fixed; top:0; right:0; height:100%; width:320px; background:linear-gradient(180deg,#0f1624,#0b101a);
        border-left:1px solid rgba(255,255,255,.1); box-shadow:0 20px 60px rgba(0,0,0,.6);
        padding:14px; transform:translateX(110%); transition:.25s ease; z-index:70}
  .menu.open{transform:translateX(0)}
  .menu h4{margin:4px 6px 10px; font-size:13px; color:#9aa4b2; font-weight:700}
  .menu .mi{width:100%; text-align:left; padding:12px 12px; border-radius:14px; background:#0c1117; border:1px solid rgba(255,255,255,.08);
            color:#e6ecf2; font-weight:800; display:flex; align-items:center; gap:10px; cursor:pointer}
  .menu .mi:hover{filter:brightness(1.1); box-shadow:0 6px 18px rgba(0,0,0,.35)}
  .menu .mi svg{width:22px; height:22px; stroke:#ffffff; opacity:.95}
  .menu .sep{height:1px; background:rgba(255,255,255,.08); margin:10px 6px}

  /* logo */
  .logo-wrap{display:flex; align-items:center; justify-content:center; margin-top:20px}
  .logo{width:min(680px, 88%); filter:drop-shadow(0 6px 24px rgba(0,0,0,.45))}
  @media(max-width:600px){ .logo{ width:min(420px, 68vw); } }
  .tagline{margin-top:8px; text-align:center; font-weight:900; letter-spacing:.4px; color:#fff; font-size:clamp(18px, 4.5vw, 28px)}

  /* busca */
  .search{display:flex; gap:10px; align-items:center; margin:16px auto 8px; max-width:820px}
  .search input{flex:1; padding:16px 16px; border-radius:18px; border:1px solid rgba(255,255,255,.1); background:#0d1320; color:var(--text); font-size:16px}
  .search input:focus{outline:none; box-shadow:0 0 0 2px rgba(49,225,255,.35)}

  /* chips premium */
  .chips{display:flex; gap:10px; flex-wrap:wrap; margin:10px auto 14px; justify-content:center}
  .chip-premium{background:#0d1320; color:var(--text); border:2px solid var(--amber-3); padding:10px 14px; border-radius:999px; font-weight:900; letter-spacing:.2px; box-shadow: 0 4px 16px rgba(255,140,0,.15)}
  .chip-premium:hover{ box-shadow: 0 0 0 2px rgba(255,140,0,.35), 0 8px 20px rgba(255,140,0,.25); transform:translateY(-1px) }

  .muted{color:#9aa4b2}
  .card{background:linear-gradient(180deg,#121826,#0c111b); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px}

  /* grid de pastas */
  .grid{display:grid; gap:12px; margin-top:10px}
  @media(min-width:1024px){ .grid{grid-template-columns: repeat(4, 1fr);} }
  @media(min-width:740px) and (max-width:1023px){ .grid{grid-template-columns: repeat(3, 1fr);} }
  @media(max-width:739px){ .grid{grid-template-columns: repeat(2, 1fr);} }
  .folderBtn{display:flex; align-items:center; justify-content:center; text-align:center; min-height:92px; padding:10px; border-radius:18px; cursor:pointer; background:linear-gradient(180deg, var(--amber-2), var(--amber-3)); color:#0b0f14; font-weight:900; font-size:20px; text-transform:uppercase; border:2px solid #ffcc6b; box-shadow: 0 6px 20px rgba(255,140,0,.25); position:relative}
  .folderBtn::after{ content:"›"; position:absolute; right:10px; top:8px; font-size:22px; font-weight:900; opacity:.9; }

  /* ===== LISTA ===== */
  .list{margin:0; padding:0}
  .track{list-style:none; position:relative; display:flex; align-items:center; gap:12px;
         background:#0f1726; border:1px solid rgba(255,255,255,.06);
         border-radius:18px; padding:14px; margin:12px 0; box-shadow:0 4px 16px rgba(0,0,0,.15)}
  .t-left{display:grid; place-items:center}
  .t-play{
    width:48px; height:48px; border-radius:999px;
    background:linear-gradient(180deg,#ff9f1a,#ff6a00); border:none; color:#fff;
    display:grid; place-items:center; cursor:pointer; box-shadow:0 6px 22px rgba(255,140,0,.28)
  }
  .t-titleBox{min-width:0; display:flex; flex-direction:column}
  .t-title{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .t-sub{font-size:12px; color:var(--muted); margin-top:2px}
  .t-right{margin-left:auto; display:flex; align-items:center; gap:6px}
  .t-like{width:42px; height:42px; background:transparent; border:none; display:grid; place-items:center; cursor:pointer}
  .t-like svg{width:26px; height:26px; stroke:#ffffff; fill:none; opacity:.95}
  .t-like.active svg{stroke:var(--accent); filter:drop-shadow(0 0 4px rgba(255,47,179,.35))}
  .t-kebab{width:42px; height:42px; background:transparent; border:none; display:grid; place-items:center; cursor:pointer}
  .t-kebab svg{width:24px; height:24px; stroke:#ffffff; opacity:.95}

  /* Menu do item (⋯) alinhado à direita */
  .t-menu{
    position:absolute; right:6px; top:54px; background:#0f1720; border:1px solid rgba(255,255,255,.12);
    padding:10px; border-radius:12px; display:none; min-width:260px; z-index:5; text-align:right;
  }
  .t-menu.open{display:block}
  .t-menu .menu-item{
    width:100%; text-align:right; padding:10px 12px; border-radius:10px; color:#e6ecf2;
    background:transparent; border:1px solid transparent; cursor:pointer; font-weight:700; display:block;
  }
  .t-menu .menu-item:hover{background:#141e2e; border-color:rgba(255,255,255,.06)}
  .t-menu .menu-item.premium{
    background:linear-gradient(180deg,#ff9f1a,#ff6a00); color:#0b0f14; border:none; font-weight:900;
    width:88%; margin:10px 6px 0 auto; padding:12px 16px; border-radius:12px;
    box-shadow:0 6px 18px rgba(255,140,0,.35); text-align:right; display:block;
  }
  .t-menu .menu-item.premium:hover{filter:brightness(1.05)}

  /* Botão "Carregar mais" central no fim da lista */
  .loadmore-wrap{display:flex; justify-content:center; margin:14px 0 4px}
  .btn{appearance:none; border:1px solid rgba(255,255,255,.12); background:#121b2b; color:var(--text); padding:12px 16px; border-radius:14px; cursor:pointer; font-weight:700}
  .btn:hover{transform:translateY(-1px)}
  .btn-primary{border:none; background:linear-gradient(180deg,#ff8b24,#ff6a00); color:#0b0f14}

  /* =================== PLAYER =================== */
  footer.player{position:fixed; left:0; right:0; bottom:0; z-index:20; background:transparent}
  .player-shell{max-width:980px; margin:0 auto 16px; padding:14px 16px; background:#0c1117; border:1px solid rgba(255,255,255,.08); border-radius:24px; box-shadow:0 24px 60px rgba(0,0,0,.55)}
  .p-top{display:flex; align-items:center; gap:10px; margin-bottom:10px}
  .track-title{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .track-right{margin-left:auto; display:flex; align-items:center; gap:8px}
  .kebab{width:34px; height:34px; border-radius:10px; background:transparent; border:none; color:#e6ecf2; display:grid;place-items:center; cursor:pointer}
  .track-sub{font-size:12px; color:#9aa4b2; margin-top:-2px}
  .progress{width:100%; margin-bottom:10px}
  .seek{appearance:none; width:100%; height:6px; border-radius:999px; background:#2a3342; outline:none}
  .seek::-webkit-slider-thumb{appearance:none; width:18px; height:18px; border-radius:50%; background:#fff; border:2px solid #bbb}
  .seek::-moz-range-thumb{width:18px; height:18px; border-radius:50%; background:#fff; border:2px solid #bbb}

  .p-controls{display:flex; align-items:center; justify-content:space-between}
  .p-btn{width:44px; height:44px; border:none; background:transparent; color:#fff; display:grid; place-items:center; cursor:pointer; padding:0}
  .p-btn svg{width:28px; height:28px; stroke:#ffffff; opacity:.9}
  .p-btn:hover svg{opacity:1; filter:drop-shadow(0 0 4px rgba(255,255,255,.25))}
  .p-btn.active svg{stroke:#31e1ff}
  .p-play{width:62px; height:62px; border-radius:999px; background:linear-gradient(180deg,#ff9f1a,#ff6a00); color:#0b0f14; border:none; display:grid; place-items:center; box-shadow:0 8px 30px rgba(255,140,0,.35)}
  .p-play svg{width:28px; height:28px; stroke:#ffffff}

  .vol-pop{position:absolute; bottom:64px; right:16px; background:#0f1720; border:1px solid rgba(255,255,255,.12); padding:8px; border-radius:12px; display:none}
  .vol-pop.open{display:block}
  .vol-range{appearance:none; width:160px; height:6px; border-radius:999px; background:#2a3342}
  .vol-range::-webkit-slider-thumb{appearance:none; width:14px; height:14px; border-radius:50%; background:#fff; border:2px solid #bbb}
  .vol-range::-moz-range-thumb{width:14px; height:14px; border-radius:50%; background:#fff; border:2px solid #bbb}

  .menu-pop{position:absolute; bottom:64px; right:54px; background:#0f1720; border:1px solid rgba(255,255,255,.12); padding:8px; border-radius:12px; display:none; min-width:240px}
  .menu-pop.open{display:block}
  .menu-pop .menu-item{width:100%; text-align:left; padding:10px 10px; border-radius:10px; color:#e6ecf2; background:transparent; border:1px solid transparent; cursor:pointer}
  .menu-pop .menu-item:hover{background:#141e2e; border-color:rgba(255,255,255,.06)}
</style>
</head>
<body>
  <div class="wrap" id="app" style="display:none">
    <header>
      <div class="userbox" id="userBtn" title="Abrir menu">
        <div class="avatar" id="avatarIcon"></div>
      </div>

      <!-- Drawer lateral e backdrop -->
      <div id="menuBackdrop" class="backdrop"></div>
      <div class="menu" id="userMenu" aria-hidden="true">
        <h4>MENU</h4>
        <button class="mi" data-act="home"      id="miHome"></button>
        <button class="mi" data-act="account"   id="miAccount"></button>
        <button class="mi" data-act="search"    id="miSearch"></button>
        <button class="mi" data-act="playlists" id="miPlaylists"></button>
        <button class="mi" data-act="downloads" id="miDowns"></button>
        <button class="mi" data-act="favs"      id="miFavs"></button>
        <button class="mi" data-act="billing"   id="miBilling"></button>
        <button class="mi" data-act="settings"  id="miSettings"></button>
        <button class="mi" data-act="notify"    id="miNotify"></button>
        <div class="sep"></div>
        <button class="mi" data-act="help"      id="miHelp"></button>
        <div class="sep"></div>
        <button class="mi" data-act="logout"    id="miLogout"></button>
      </div>

      <div class="logo-wrap">
        <picture>
          <source srcset="/logolove.webp" type="image/webp">
          <img class="logo" src="/loove-logo.png" alt="Loove music">
        </picture>
      </div>
      <div class="tagline">AQUI TODO MUNDO AMA MÚSICA</div>

      <div class="search">
        <input id="q" type="search" placeholder="Qual música você quer ouvir?" />
      </div>

      <div class="chips" id="chipsPremium">
        <button class="chip-premium" data-p="top1000">TOP-1.000</button>
        <button class="chip-premium" data-p="summer">SUMMER ELETRO HITS</button>
        <button class="chip-premium" data-p="jovempan">JOVEM PAN</button>
        <button class="chip-premium" data-p="setsremix">SETS REMIX</button>
        <button class="chip-premium" data-p="secret">PLAYLIST SECRETA</button>
        <button class="chip-premium" data-p="flashbackgold">FLASHBACK GOLD</button>
        <button class="chip-premium" data-p="topmundogold">TOP - MUNDO GOLD</button>
      </div>
    </header>

    <!-- HOME -->
    <section id="viewHome">
      <div class="grid" id="foldersGrid"></div>
    </section>

    <!-- LISTA -->
    <section id="viewList" class="card" style="display:none">
      <ul id="list" class="list"></ul>
      <div class="loadmore-wrap">
        <button id="btnMore" class="btn">Carregar mais</button>
      </div>
    </section>

    <!-- FAVORITOS -->
    <section id="viewFavs" class="card" style="display:none">
      <h3>Favoritos</h3>
      <div id="favList"></div>
    </section>
  </div>

  <!-- LOGIN -->
  <section id="viewLogin" class="card" style="max-width:420px;margin:60px auto; display:none">
    <h2>Entrar</h2>
    <p class="muted">Digite seu PIN para acessar o app.</p>
    <form id="formLogin" class="row" onsubmit="return false;">
      <input id="pin" type="password" inputmode="numeric" minlength="3" maxlength="8" placeholder="Ex.: 2468" style="flex:1; padding:12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:#0d1320; color:#e6ecf2">
      <button id="btnLogin" class="btn btn-primary" type="submit">Entrar</button>
    </form>
    <div id="msg" class="muted" style="margin-top:8px"></div>
  </section>

  <!-- =================== PLAYER =================== -->
  <footer class="player">
    <div class="player-shell">
      <div class="p-top">
        <div>
          <div class="track-title" id="nowTitle">Nada tocando</div>
          <div class="track-sub" id="nowFolder">—</div>
        </div>
        <div class="track-right">
          <div id="nowTime" class="muted">0:00 / 0:00</div>
          <button id="btnKebab" class="kebab" title="Opções">⋯</button>
        </div>
      </div>
      <div class="progress"><input id="seek" class="seek" type="range" min="0" max="1000" value="0" /></div>
      <div class="p-controls">
        <button id="pHome"   class="p-btn" title="Início"></button>
        <button id="pSearch" class="p-btn" title="Buscar"></button>
        <button id="pPrev"   class="p-btn" title="Voltar"></button>
        <button id="pPlay"   class="p-play" title="Play/Pause"></button>
        <button id="pNext"   class="p-btn" title="Avançar"></button>
        <button id="pShuffle" class="p-btn" title="Shuffle"></button>
        <button id="pRepeat"  class="p-btn" title="Repeat"></button>
        <div style="position:relative">
          <button id="pVolume"  class="p-btn" title="Volume"></button>
          <div id="volPop" class="vol-pop">
            <input id="volRange" class="vol-range" type="range" min="0" max="1" step="0.01" value="1" />
          </div>
        </div>
      </div>
      <div id="menuPop" class="menu-pop">
        <button class="menu-item" id="miShare">Compartilhar</button>
        <button class="menu-item" id="miFav">Favoritar</button>
        <button class="menu-item" id="miDown">Baixar (Premium)</button>
        <button class="menu-item" id="miCreatePl">Criar playlist (Premium)</button>
        <button class="menu-item" id="miSavePl">Salvar playlist (Premium)</button>
      </div>
    </div>
    <audio id="audio" crossorigin="anonymous"></audio>
  </footer>

<script>
  const TOKEN_KEY = "loove_token";
  const FAVORITES_KEY = "loove_favs_v1";
  const PREMIUM_PREFIX = "PREMIUM/";
  const PREMIUM_URL = "/assinaturas.html";
  const el = id => document.getElementById(id);
  const goPremium = ()=> location.href = PREMIUM_URL;

  /* ===== SVGs ===== */
  function icoHome(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M3 10.5 12 3l9 7.5M5 9.5v11h5v-6h4v6h5v-11" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.2"/></svg>`}
  function icoSearch(){return `<svg viewBox='0 0 24 24' fill='none'><circle cx='11' cy='11' r='7' stroke-width='2.2'/><path d='M20 20l-3.5-3.5' stroke-width='2.2' stroke-linecap='round'/></svg>`}
  function icoPrev(){return `<svg viewBox='0 0 24 24' fill='none'><path d='M11 6l-7 6 7 6V6zM20 5v14' stroke-width='2.2' stroke-linejoin='round' stroke-linecap='round'/></svg>`}
  function icoNext(){return `<svg viewBox='0 0 24 24' fill='none'><path d='M13 6l7 6-7 6V6zM4 5v14' stroke-width='2.2' stroke-linejoin='round' stroke-linecap='round'/></svg>`}
  function icoPlay(){return `<svg viewBox='0 0 24 24' fill='none'><path d='M8 5l11 7-11 7V5z' stroke-width='2.2' stroke-linejoin='round' stroke='#ffffff'/></svg>`}
  function icoPause(){return `<svg viewBox='0 0 24 24' fill='none'><path d='M8 5v14M16 5v14' stroke='#ffffff' stroke-width='2.6' stroke-linecap='round'/></svg>`}
  function icoShuffle(){return `<svg viewBox='0 0 24 24' fill='none'><path d='M16 3h5v5M3 17h6c3 0 6-4 6-4' stroke-width='2.2' stroke-linecap='round' stroke-linejoin='round'/><path d='M21 21v-5h-5M3 7h6c2 0 3 2 4 3' stroke-width='2.2' stroke-linecap='round' stroke-linejoin='round'/></svg>`}
  function icoRepeat(){return `<svg viewBox='0 0 24 24' fill='none'><path d='M17 1l3 3-3 3' stroke-width='2.2' stroke-linecap='round' stroke-linejoin='round'/><path d='M4 11V8a3 3 0 0 1 3-3h13' stroke-width='2.2' stroke-linecap='round'/><path d='M7 23l-3-3 3-3' stroke-width='2.2' stroke-linecap='round' stroke-linejoin='round'/><path d='M20 13v3a3 3 0 0 1-3 3H4' stroke-width='2.2' stroke-linecap='round'/></svg>`}
  function icoVolume(){return `<svg viewBox='0 0 24 24' fill='none'><path d='M4 10v4h4l6 5V5l-6 5H4z' stroke-width='2.2' stroke-linejoin='round' stroke-linecap='round'/><path d='M18 9a3 3 0 0 1 0 6M20 7a6 6 0 0 1 0 10' stroke-width='2.2' stroke-linecap='round'/></svg>`}
  function icoHeart(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M12 21s-7-4.7-9.5-8A5.6 5.6 0 0 1 12 6a5.6 5.6 0 0 1 9.5 7c-2.5 3.3-9.5 8-9.5 8Z" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>`}
  function icoKebab(){return `<svg viewBox="0 0 24 24" fill="none"><circle cx="5" cy="12" r="2" stroke-width="2"/><circle cx="12" cy="12" r="2" stroke-width="2"/><circle cx="19" cy="12" r="2" stroke-width="2"/></svg>`}
  function icoUser(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Z" stroke-width="2.2"/><path d="M4 21a8 8 0 0 1 16 0" stroke-width="2.2" stroke-linecap="round"/></svg>`}
  function icoAccount(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Z" stroke-width="2"/><path d="M4 21a8 8 0 0 1 16 0" stroke-width="2" stroke-linecap="round"/></svg>`}
  function icoBell(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M6 8a6 6 0 1 1 12 0v5l2 3H4l2-3Z" stroke-width="2"/><path d="M10 19a2 2 0 0 0 4 0" stroke-width="2"/></svg>`}
  function icoSettings(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8Z" stroke-width="2"/><path d="M19 12h3M2 12h3M12 2v3M12 19v3M4.6 4.6l2.1 2.1M17.3 17.3l2.1 2.1M19.4 4.6l-2.1 2.1M6.7 17.3l-2.1 2.1" stroke-width="2" stroke-linecap="round"/></svg>`}
  function icoHelp(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M9 9a3 3 0 0 1 6 0c0 2-3 2-3 4" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="12" r="9" stroke-width="2"/><path d="M12 17h0" stroke-width="2" stroke-linecap="round"/></svg>`}
  function icoLogout(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M9 21H6a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3" stroke-width="2"/><path d="M16 17l5-5-5-5" stroke-width="2" stroke-linecap="round"/><path d="M21 12H9" stroke-width="2"/></svg>`}
  function icoPlaylist(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M3 6h14M3 10h14M3 14h9" stroke-width="2" stroke-linecap="round"/><path d="M18 14v6l3-2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`}
  function icoDownload(){return `<svg viewBox="0 0 24 24" fill="none"><path d="M12 3v12" stroke-width="2" stroke-linecap="round"/><path d="M7 10l5 5 5-5" stroke-width="2" stroke-linecap="round"/><path d="M5 21h14" stroke-width="2" stroke-linecap="round"/></svg>`}
  function icoStar(){return `<svg viewBox="0 0 24 24" fill="none"><path d="m12 3 2.8 5.7 6.2.9-4.5 4.4 1.1 6.2L12 17l-5.6 3 1.1-6.2L3 9.6l6.2-.9L12 3Z" stroke-width="2" stroke-linejoin="round"/></svg>`}
  function icoCard(){return `<svg viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="2" stroke-width="2"/><path d="M3 10h18" stroke-width="2"/></svg>`}

  function setFlatIcons(){
    el("pHome").innerHTML = icoHome();
    el("pSearch").innerHTML = icoSearch();
    el("pPrev").innerHTML = icoPrev();
    el("pNext").innerHTML = icoNext();
    el("pShuffle").innerHTML = icoShuffle();
    el("pRepeat").innerHTML = icoRepeat();
    el("pVolume").innerHTML = icoVolume();
    el("pPlay").innerHTML = icoPlay();
    const av = document.getElementById("avatarIcon");
    if(av) av.innerHTML = icoUser();

    el("miHome").innerHTML      = icoHome()     + ' Início';
    el("miAccount").innerHTML   = icoAccount()  + ' Conta';
    el("miSearch").innerHTML    = icoSearch()   + ' Buscar';
    el("miPlaylists").innerHTML = icoPlaylist() + ' Playlists';
    el("miDowns").innerHTML     = icoDownload() + ' Downloads';
    el("miFavs").innerHTML      = icoStar()     + ' Favoritos';
    el("miBilling").innerHTML   = icoCard()     + ' Assinatura';
    el("miSettings").innerHTML  = icoSettings() + ' Configurações';
    el("miNotify").innerHTML    = icoBell()     + ' Notificações';
    el("miHelp").innerHTML      = icoHelp()     + ' Ajuda';
    el("miLogout").innerHTML    = icoLogout()   + ' Sair';
  }

  /* ===== infra ===== */
  function show(id){ el(id).style.display = ""; }
  function hide(id){ el(id).style.display = "none"; }
  async function api(path, opts = {}) {
    const headers = Object.assign(
      { "Content-Type":"application/json" },
      opts.headers || {},
      localStorage.getItem(TOKEN_KEY) ? { Authorization: "Bearer " + localStorage.getItem(TOKEN_KEY) } : {}
    );
    const res = await fetch(path, Object.assign({}, opts, { headers }));
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw data || { error: "HTTP " + res.status };
    return data;
  }

  let currentPrefix = "", nextToken = null, items = [];
  let premiumFolders = [];

  async function ensureAuth(){
    try { await api("/api/me"); show("app"); hide("viewLogin"); }
    catch { hide("app"); show("viewLogin"); }
  }
  el("formLogin").addEventListener("submit", async ()=>{
    const pin = el("pin").value.trim();
    if(pin.length<3){ el("msg").textContent="Digite pelo menos 3 dígitos."; return; }
    el("msg").textContent="Entrando...";
    try{
      const d = await api("/api/login",{ method:"POST", body: JSON.stringify({ pin }) });
      if(!d.token) throw d;
      localStorage.setItem(TOKEN_KEY, d.token);
      el("msg").textContent = "Login OK!";
      await boot();
    }catch(e){ el("msg").textContent = e?.error || "Falha no login"; }
  });

  async function loadRootFolders(){
    const g = el("foldersGrid"); g.innerHTML = "";
    const d = await api("/api/folders?prefix=");
    const folders = (d.folders || []);
    if(!folders.length){ g.innerHTML = `<div class="card">Nenhuma pasta encontrada na raiz do bucket.</div>`; return; }
    folders.forEach(f=>{
      const b = document.createElement("button");
      b.className = "folderBtn";
      b.textContent = (f.name || f.prefix || "pasta").replace(/\/$/,"");
      b.onclick = ()=> enterFolder(f.prefix);
      g.appendChild(b);
    });
  }
  function slug(s){ return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""); }
  function bestMatch(targetSlug, options){
    let hit = options.find(o => o.slug === targetSlug);
    if(hit) return hit;
    hit = options.find(o => o.slug.includes(targetSlug) || targetSlug.includes(o.slug));
    if(hit) return hit;
    let best=null, score=0;
    options.forEach(o=>{
      const common = o.slug.split("-").filter(p=> targetSlug.includes(p)).join("-");
      const sc = common.length;
      if(sc>score){ score=sc; best=o; }
    });
    return best;
  }
  async function loadPremiumFolders(){
    const d = await api("/api/folders?prefix="+encodeURIComponent(PREMIUM_PREFIX));
    premiumFolders = (d.folders || []).map(f=>{
      const name = (f.name||f.prefix).replace(new RegExp("^"+PREMIUM_PREFIX.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')), "").replace(/\/$/,"");
      return { prefix:f.prefix, name, slug: slug(name) };
    });
    const synonyms = {
      top1000: ["top-1000","top-1-000","top1000","top1k","top - brasil","top - mundo"],
      summer: ["summer-eletro-hits","summer","eletro-hits","summer eletro hits"],
      jovempan: ["jovem-pan","jovempan","pan"],
      setsremix: ["sets-remix","sets","remix","dj-sets"],
      secret: ["playlist-secreta","secreta","secret"],
      flashbackgold: ["flashback-gold","flashback gold","flashback"],
      topmundogold: ["top - mundo gold","top-mundo-gold","top - mundo"]
    };
    document.querySelectorAll(".chip-premium").forEach(ch=>{
      ch.onclick = ()=>{
        const id = ch.getAttribute("data-p");
        const candidates = (synonyms[id]||[slug(ch.textContent)]);
        const want = candidates.map(slug);
        const options = premiumFolders;
        let match = null;
        for(const w of want){ match = bestMatch(w, options); if(match) break; }
        if(match){ enterFolder(match.prefix); }
        else{
          alert("Playlist premium específica não encontrada. Abrindo a seção premium para você escolher.");
          enterFolder(PREMIUM_PREFIX);
        }
      };
    });
  }

  function favs(){ try{ return JSON.parse(localStorage.getItem(FAVORITES_KEY)||"[]"); }catch{ return []; } }
  function setFavs(a){ localStorage.setItem(FAVORITES_KEY, JSON.stringify(a)); }
  function isFav(k){ return favs().includes(k); }

  async function enterFolder(prefix){
    currentPrefix = prefix || ""; nextToken = null; items = [];
    hide("viewHome"); hide("viewFavs"); show("viewList");
    el("list").innerHTML = "";
    if(currentPrefix && currentPrefix.startsWith(PREMIUM_PREFIX)){ goPremium(); return; }
    await loadMore();
  }
  async function loadMore(){
    const url = "/api/list?prefix="+encodeURIComponent(currentPrefix) + (nextToken ? "&token="+encodeURIComponent(nextToken) : "");
    const d = await api(url);
    nextToken = d.nextToken || null;
    (d.items||[]).forEach(it=> items.push(it));
    renderList();
    el("btnMore").disabled = !nextToken;
  }

  function formatTitle(filename=""){ let name = filename.replace(/\.[a-z0-9]{1,5}$/i,""); name = name.replace(/\s*[-–—]\s*/," – "); return name; }
  function parentFolderFromKey(key=""){ const path = key.split("/"); path.pop(); return path.join("/") || "/"; }
  function fmt(t){ if(!isFinite(t) || t<0) return "0:00"; const m=Math.floor(t/60); const s=Math.floor(t%60); return m+":"+(s<10?"0":"")+s; }

  /* duração lazy (corrigido) */
  const durationCache = new Map();
  const visObs = new IntersectionObserver((entries)=>{
    entries.forEach(en=>{
      if(!en.isIntersecting) return;
      const row = en.target; visObs.unobserve(row);
      const key = row.getAttribute("data-key");
      const span = row.querySelector(".t-sub .dur");
      if(!key || !span) return;
      fetchDurationLazy(key, span);
    });
  }, { root: null, threshold: .1 });

  async function fetchDurationLazy(key, span){
    if(durationCache.has(key)){ span.textContent = fmt(durationCache.get(key)); return; }
    span.textContent = "—:—";
    try{
      const d = await api("/api/stream?key="+encodeURIComponent(key));
      const a = new Audio();
      a.preload = "metadata";
      a.crossOrigin = "anonymous";
      a.src = d.url;
      a.addEventListener("loadedmetadata", ()=>{
        const sec = a.duration || 0;
        durationCache.set(key, sec);
        span.textContent = fmt(sec);
        a.src = "";
      }, { once:true });
      a.addEventListener("error", ()=>{ span.textContent="--:--"; }, { once:true });
      a.load();
    }catch{ span.textContent="--:--"; }
  }

  /* ===== renderização da lista ===== */
  function renderList(){
    const UL = el("list"); UL.innerHTML = "";
    if(!items.length){ UL.innerHTML = `<li class="muted" style="list-style:none;padding:8px 2px">Nenhuma música nesta pasta.</li>`; return; }
    items.forEach(m=>{
      const LI = document.createElement("li"); LI.className = "track"; LI.setAttribute("data-key", m.key);

      const left = document.createElement("div"); left.className = "t-left";
      const btPlay = document.createElement("button"); btPlay.className = "t-play"; btPlay.innerHTML = "▶";
      btPlay.onclick = ()=> playKey(m.key, m.name);
      left.appendChild(btPlay);

      const mid = document.createElement("div"); mid.className="t-titleBox";
      const t1 = document.createElement("div"); t1.className="t-title"; t1.textContent = formatTitle(m.name);
      const t2 = document.createElement("div"); t2.className="t-sub";
      t2.innerHTML = `<span class="dur">—:—</span> · <span class="folder">${parentFolderFromKey(m.key)}</span>`;
      mid.appendChild(t1); mid.appendChild(t2);

      const right = document.createElement("div"); right.className="t-right";
      const like = document.createElement("button"); like.className="t-like"; like.innerHTML = icoHeart();
      if(isFav(m.key)) like.classList.add("active");
      like.onclick = ()=> { toggleFav(m.key); like.classList.toggle("active"); };

      const keb = document.createElement("button"); keb.className="t-kebab"; keb.innerHTML = icoKebab();
      const menu = document.createElement("div"); menu.className="t-menu";
      menu.innerHTML = `
        <button class="menu-item miShare">Compartilhar</button>
        <button class="menu-item miFav">${isFav(m.key)?"Remover dos favoritos":"Favoritar"}</button>
        <button class="menu-item premium miDown">Baixar (Premium)</button>
        <button class="menu-item premium miCreatePl">Criar Playlist (Premium)</button>
        <button class="menu-item premium miAddPl">Adicionar na Playlist (Premium)</button>
      `;
      keb.onclick = (e)=>{ e.stopPropagation(); closeAllItemMenus(); menu.classList.toggle("open"); };
      document.addEventListener("click",(ev)=>{ if(!menu.contains(ev.target) && !keb.contains(ev.target)) menu.classList.remove("open"); });

      menu.querySelector(".miShare").onclick = async ()=>{
        try{
          if(navigator.share){ await navigator.share({ title: formatTitle(m.name), text:"Ouça no Loove", url: location.href }); }
          else { await navigator.clipboard.writeText(location.href); alert("Link copiado!"); }
        }catch{}
        menu.classList.remove("open");
      };
      menu.querySelector(".miFav").onclick = ()=>{
        toggleFav(m.key);
        like.classList.toggle("active");
        menu.classList.remove("open");
      };
      menu.querySelectorAll(".premium").forEach(btn=>{
        btn.addEventListener("click", ()=>{ menu.classList.remove("open"); goPremium(); });
      });

      right.appendChild(like);
      right.appendChild(keb);

      LI.appendChild(left); LI.appendChild(mid); LI.appendChild(right);
      LI.appendChild(menu);
      UL.appendChild(LI);

      visObs.observe(LI);
    });
  }

  function closeAllItemMenus(){ document.querySelectorAll(".t-menu.open").forEach(m=>m.classList.remove("open")); }

  function toggleFav(k){
    const f = favs(); const i=f.indexOf(k);
    if(i>=0) f.splice(i,1); else f.push(k);
    setFavs(f);
  }

  /* ===== BUSCA ===== */
  async function doSearch(){
    const q = el("q").value.trim();
    if(q.length<3){ alert("Digite pelo menos 3 letras."); return; }
    hide("viewHome"); hide("viewFavs"); show("viewList");
    const d = await api("/api/search?q="+encodeURIComponent(q)+"&prefix="+encodeURIComponent(currentPrefix||""));
    items = d.items || []; nextToken = null; renderList();
  }
  el("q").addEventListener("keydown", e=>{ if(e.key==="Enter") doSearch(); });

  /* ===== PLAYER ===== */
  const audio = el("audio"); const seek = el("seek"); const nowTitle = el("nowTitle"); const nowFolder = el("nowFolder"); const nowTime = el("nowTime");
  const pPlay = el("pPlay"); const pPrev = el("pPrev"); const pNext = el("pNext"); const pHome = el("pHome"); const pSearch = el("pSearch");
  const volPop = el("volPop"); const volRange = el("volRange"); const pVolume = el("pVolume"); const pShuffle = el("pShuffle"); const pRepeat = el("pRepeat");
  const btnKebab = el("btnKebab"); const menuPop = el("menuPop");

  let currentKey = null, currentName = null, shuffleOn=false, repeatOn=false;

  function setNow(name,key){ nowTitle.textContent = formatTitle(name||""); nowFolder.textContent = (key? parentFolderFromKey(key):"") || "—"; }
  function updateTimeUI(){ const cur=audio.currentTime||0; const dur=audio.duration||0; nowTime.textContent = `${fmt(cur)} / ${fmt(dur)}`; seek.value = (dur>0&&!isNaN(dur)) ? Math.round((cur/dur)*1000) : 0; }
  audio.addEventListener("timeupdate", updateTimeUI);
  audio.addEventListener("loadedmetadata", updateTimeUI);
  audio.addEventListener("ended", ()=>{
    setPlayIcon(false);
    if(repeatOn){ audio.currentTime=0; audio.play(); setPlayIcon(true); return; }
    if(items.length){
      let idx = items.findIndex(it => it.key===currentKey); if(idx<0) idx=0;
      if(shuffleOn){ const r = Math.floor(Math.random()*items.length); playKey(items[r].key, items[r].name); }
      else if(idx < items.length-1){ playKey(items[idx+1].key, items[idx+1].name); }
    }
  });
  seek.addEventListener("input", ()=>{ const dur=audio.duration||0; if(dur<=0) return; audio.currentTime = (Number(seek.value)/1000)*dur; updateTimeUI(); });

  function setPlayIcon(isPlaying){ el("pPlay").innerHTML = isPlaying ? icoPause() : icoPlay(); }
  pPlay.onclick = ()=>{ if(!audio.src) return; if(audio.paused){ audio.play(); setPlayIcon(true); } else { audio.pause(); setPlayIcon(false); } };
  pPrev.onclick = ()=>{ if(items.length){ let idx=items.findIndex(it=>it.key===currentKey); if(idx>0) playKey(items[idx-1].key, items[idx-1].name); } };
  pNext.onclick = ()=>{ if(items.length){ let idx=items.findIndex(it=>it.key===currentKey); if(idx<items.length-1) playKey(items[idx+1].key, items[idx+1].name); } };
  pHome.onclick = ()=> enterFolder("");
  pSearch.onclick = ()=> el("q").focus();
  pShuffle.onclick = ()=>{ shuffleOn=!shuffleOn; pShuffle.classList.toggle("active", shuffleOn); };
  pRepeat.onclick  = ()=>{ repeatOn =!repeatOn; pRepeat.classList.toggle("active", repeatOn); audio.loop = repeatOn; };

  pVolume.onclick = (e)=>{ e.stopPropagation(); menuPop.classList.remove("open"); volPop.classList.toggle("open"); };
  volRange.addEventListener("input", ()=>{ audio.volume = Number(volRange.value); });
  document.addEventListener("click", (ev)=>{
    if(!volPop.contains(ev.target) && !pVolume.contains(ev.target)) volPop.classList.remove("open");
    if(!menuPop.contains(ev.target) && !btnKebab.contains(ev.target)) menuPop.classList.remove("open");
  });
  btnKebab.onclick = (e)=>{ e.stopPropagation(); menuPop.classList.toggle("open"); volPop.classList.remove("open"); };

  el("miShare").onclick = async ()=>{ try{ if(navigator.share){ await navigator.share({ title: nowTitle.textContent, text: "Ouça no Loove", url: location.href }); } else { await navigator.clipboard.writeText(location.href); alert("Link copiado!"); } }catch{} };
  el("miFav").onclick = ()=>{ if(currentKey) { toggleFav(currentKey); alert("Favorito atualizado."); } };
  el("miDown").onclick = goPremium;
  el("miCreatePl").onclick = goPremium;
  el("miSavePl").onclick = goPremium;

  async function playKey(key,name){
    const d = await api("/api/stream?key="+encodeURIComponent(key));
    audio.src = d.url; currentKey = key; currentName = name; setNow(name,key);
    audio.play(); setPlayIcon(true);
  }

  /* ===== Drawer do usuário ===== */
  const userBtn = el("userBtn"), userMenu = el("userMenu"), backdrop = el("menuBackdrop");
  function closeMenu(){ userMenu.classList.remove("open"); userMenu.setAttribute("aria-hidden","true"); backdrop.classList.remove("open"); }
  function openMenu(){ userMenu.classList.add("open"); userMenu.setAttribute("aria-hidden","false"); backdrop.classList.add("open"); }
  userBtn.addEventListener("click", (e)=>{ e.stopPropagation(); userMenu.classList.contains("open") ? closeMenu() : openMenu(); });
  backdrop.addEventListener("click", closeMenu);
  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeMenu(); });

  userMenu.addEventListener("click", (e)=>{
    if(!(e.target instanceof HTMLElement)) return;
    const act = e.target.getAttribute("data-act") || e.target.parentElement?.getAttribute("data-act");
    if(!act) return;
    closeMenu();
    switch(act){
      case "home": enterFolder(""); break;
      case "account": location.href = "/conta.html"; break;           // ALTERADO
      case "search": el("q").focus(); break;
      case "playlists": location.href = "/playlists.html"; break;     // ALTERADO
      case "downloads": location.href = "/downloads.html"; break;     // ALTERADO
      case "favs": renderFavs(); hide("viewHome"); hide("viewList"); show("viewFavs"); break;
      case "billing": goPremium(); break;
      case "settings": location.href = "/configuracoes.html"; break;
      case "notify":   location.href = "/notificacoes.html"; break;
      case "help": location.href = "/ajuda.html"; break;              // ALTERADO
      case "logout": localStorage.removeItem(TOKEN_KEY); location.reload(); break;
    }
  });

  /* ===== Navegação ===== */
  el("btnMore").onclick = loadMore;

  function renderFavs(){
    const cont = el("favList"); cont.innerHTML = "";
    const f = favs(); if(!f.length){ cont.innerHTML = `<div class="muted">Você ainda não marcou favoritos.</div>`; return; }
    f.forEach(k=>{
      const row = document.createElement("div"); row.className="track"; row.style.padding="12px 14px";
      const play = document.createElement("button"); play.className="t-play"; play.innerHTML="▶"; play.onclick=async()=>{ const nm=k.split("/").pop(); playKey(k,nm); };
      const info = document.createElement("div"); info.className="t-titleBox"; info.innerHTML = `<div class="t-title">${formatTitle(k.split("/").pop())}</div><div class="t-sub">${k}</div>`;
      row.appendChild(play); row.appendChild(info);
      cont.appendChild(row);
    });
  }

  async function ensureAuthAndLoad(){
    await ensureAuth();
    if(el("app").style.display!=="none"){
      setFlatIcons();
      await loadPremiumFolders();
      await loadRootFolders();
      hide("viewList"); hide("viewFavs"); show("viewHome");
    }
  }
  ensureAuthAndLoad();
  async function boot(){ await ensureAuthAndLoad(); }

  /* ===== Estatística de uso local (Admin demo) ===== */
  (function trackUsage(){
    const KEY="loove_usage_stats";
    let start=Date.now();
    function save(){
      const sec=(Date.now()-start)/1000;
      const d=new Date().toISOString().slice(0,10);
      let st={firstAt:d, secondsTotal:0, days:0, byDay:{}};
      try{ st=Object.assign(st, JSON.parse(localStorage.getItem(KEY)||"{}")); }catch{}
      st.secondsTotal = (st.secondsTotal||0) + sec;
      st.byDay[d] = (st.byDay?.[d]||0) + sec;
      st.days = Object.keys(st.byDay||{}).length;
      localStorage.setItem(KEY, JSON.stringify(st));
      start=Date.now();
    }
    window.addEventListener("beforeunload", save);
    setInterval(save, 30000);
  })();
</script>
</body>
</html>
