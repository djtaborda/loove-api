<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Loove • Music App</title>
<style>
  :root{
    --bg:#0b0f14;
    --card:#121826;
    --muted:#9aa4b2;
    --text:#e6ecf2;
    --accent:#ff2fb3;
    --amber:#ff9f1a;
    --amber-2:#ffb02e;
    --amber-3:#ff7a00;
  }

  /* ===== Temas ===== */
  body.theme-default{
    --bg:#0b0f14; --card:#121826; --text:#e6ecf2; --muted:#9aa4b2;
    --accent:#ff2fb3; --amber:#ff9f1a; --amber-2:#ffb02e; --amber-3:#ff7a00;
  }
  body.theme-pink{
    --bg:#0b0810; --card:#141022; --text:#ffeefe; --muted:#caaed0;
    --accent:#ff3ad1; --amber:#ff58ab; --amber-2:#ff63c0; --amber-3:#ff2fb3;
  }
  body.theme-green{
    --bg:#05110d; --card:#0d1714; --text:#e8fff6; --muted:#a5c7b8;
    --accent:#31ff9c; --amber:#25f5a0; --amber-2:#2cf0b6; --amber-3:#12c98d;
  }
  body.theme-black{
    --bg:#000000; --card:#0c0c0c; --text:#f1f1f1; --muted:#a0a0a0;
    --accent:#e0e0e0; --amber:#777; --amber-2:#666; --amber-3:#555;
  }

  /* ================== CHANGELOG ==================
     Edição 11 — Configurações: Preferência musical, Idioma, Mix DJ (crossfade), Temas
  ================================================= */

  *{box-sizing:border-box}
  body{
    margin:0;background:
      radial-gradient(1000px 600px at 10% -10%, rgba(49,225,255,.08), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, rgba(255,47,179,.07), transparent 60%),
      var(--bg); color:var(--text);
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    min-height:100dvh; padding-bottom:170px;
  }
  .wrap{width:100%; max-width:1060px; margin:0 auto; padding:16px}

  /* ======= HEADER ======= */
  header{position:relative; padding-top:12px; margin-bottom:12px}
  .userbox{position:absolute; top:10px; right:10px; display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none}
  .avatar{width:44px; height:44px; display:grid; place-items:center; border-radius:50%}
  .avatar svg{width:30px; height:30px; stroke:#ffffff; opacity:.95}

  /* ===== Drawer lateral ===== */
  .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; z-index:60}
  .backdrop.open{display:block}
  .menu{position:fixed; top:0; right:0; height:100%; width:320px; background:linear-gradient(180deg,#0f1624,#0b101a);
        border-left:1px solid rgba(255,255,255,.1); box-shadow:0 20px 60px rgba(0,0,0,.6);
        padding:14px; transform:translateX(110%); transition:.25s ease; z-index:70}
  .menu.open{transform:translateX(0)}
  .menu h4{margin:4px 6px 10px; font-size:13px; color:#9aa4b2; font-weight:700}
  .menu .mi{width:100%; text-align:left; padding:12px 12px; border-radius:14px; background:#0c1117; border:1px solid rgba(255,255,255,.08);
            color:#e6ecf2; font-weight:800; display:flex; align-items:center; gap:10px; cursor:pointer}
  .menu .mi:hover{filter:brightness(1.1); box-shadow:0 6px 18px rgba(0,0,0,.35)}
  .menu .mi svg{width:22px; height:22px; stroke:#ffffff; opacity:.95}
  .menu .sep{height:1px; background:rgba(255,255,255,.08); margin:10px 6px}

  /* logo */
  .logo-wrap{ display:flex; align-items:center; justify-content:center; margin-top:20px; text-align:center;}
  .logo{ width:min(300px, 40%); filter:drop-shadow(0 6px 24px rgba(0,0,0,.45)); margin: 0 auto; }
  @media(max-width:600px){ .logo{ width:min(190px, 32vw); margin: 0 auto; } }

  .tagline{
    margin-top:8px; text-align:center; font-weight:900; letter-spacing:.4px;
    color:#fff; font-size:clamp(18px, 4.5vw, 28px);
  }

  /* busca */
  .search{display:flex; align-items:center; gap:10px; margin:16px auto 8px; max-width:820px}
  .s-ico{display:grid; place-items:center; width:24px; height:24px; opacity:.95}
  .s-ico svg{width:22px; height:22px; stroke:#ffffff}
  .search input{flex:1; padding:16px 16px; border-radius:18px; border:1px solid rgba(255,255,255,.1); background:#0d1320; color:var(--text); font-size:16px}
  .search input:focus{outline:none; box-shadow:0 0 0 2px rgba(49,225,255,.35)}

  /* chips premium + seleção de preferências */
  .chips{display:flex; gap:10px; flex-wrap:wrap; margin:10px auto 14px; justify-content:center}
  .chip-premium{background:#0d1320; color:var(--text); border:2px solid var(--amber-3); padding:10px 14px; border-radius:999px; font-weight:900; letter-spacing:.2px; box-shadow: 0 4px 16px rgba(255,140,0,.15)}
  .chip-premium:hover{ box-shadow: 0 0 0 2px rgba(255,140,0,.35), 0 8px 20px rgba(255,140,0,.25); transform:translateY(-1px) }
  .chip-premium.active{ outline:2px solid rgba(49,225,255,.35); box-shadow:0 0 0 2px rgba(49,225,255,.25), 0 8px 20px rgba(49,225,255,.18); }

  .muted{color:var(--muted)}
  .card{background:linear-gradient(180deg, var(--card), #0c111b); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px}

  /* grid */
  .grid{display:grid; gap:12px; margin-top:10px}
  @media(min-width:1024px){ .grid{grid-template-columns: repeat(4, 1fr);} }
  @media(min-width:740px) and (max-width:1023px){ .grid{grid-template-columns: repeat(3, 1fr);} }
  @media(max-width:739px){ .grid{grid-template-columns: repeat(2, 1fr);} }
  .folderBtn{display:flex; align-items:center; justify-content:center; text-align:center; min-height:92px; padding:10px; border-radius:18px; cursor:pointer; background:linear-gradient(180deg, var(--amber-2), var(--amber-3)); color:#0b0f14; font-weight:900; font-size:20px; text-transform:uppercase; border:2px solid #ffcc6b; box-shadow: 0 6px 20px rgba(255,140,0,.25); position:relative}
  .folderBtn::after{ content:"›"; position:absolute; right:10px; top:8px; font-size:22px; font-weight:900; opacity:.9; }

  /* ===== LISTA ===== */
  .list{margin:0; padding:0}
  .track{
    list-style:none; position:relative; display:flex; align-items:center; gap:10px;
    background:#0f1726; border:1px solid rgba(255,255,255,.06);
    border-radius:16px; padding:10px 8px 10px 10px; margin:6px 0;
    box-shadow:0 3px 12px rgba(0,0,0,.14)
  }
  .t-left{display:grid; place-items:center}
  .t-play{ width:40px; height:40px; border-radius:999px; background:linear-gradient(180deg,var(--amber),var(--amber-3)); border:none; color:#fff; display:grid; place-items:center; cursor:pointer; box-shadow:0 6px 18px rgba(255,140,0,.26); font-weight:900 }
  .t-titleBox{min-width:0; display:flex; flex-direction:column; gap:2px}
  .t-title{font-weight:900; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .t-sub{font-size:11px; color:var(--muted); margin-top:0}
  .t-right{margin-left:auto; display:flex; align-items:center; gap:6px}
  .t-kebab{width:36px; height:36px; background:transparent; border:none; display:grid; place-items:center; cursor:pointer}

  .loadmore-wrap{display:flex; justify-content:center; margin:12px 0 4px}
  .btn{appearance:none; border:1px solid rgba(255,255,255,.12); background:#121b2b; color:#e6ecf2; padding:12px 16px; border-radius:14px; cursor:pointer; font-weight:700}
  .btn-primary{border:none; background:linear-gradient(180deg,var(--amber),var(--amber-3)); color:#0b0f14}

  /* =================== PLAYER =================== */
  footer.player{position:fixed; left:0; right:0; bottom:0; z-index:20; background:transparent}
  .player-shell{max-width:980px; margin:0 auto 16px; padding:14px 16px; background:#0c1117; border:1px solid rgba(255,255,255,.08); border-radius:24px; box-shadow:0 24px 60px rgba(0,0,0,.55)}
  .p-top{display:flex; align-items:center; gap:10px; margin-bottom:8px}
  .track-title{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .track-right{margin-left:auto; display:flex; align-items:center; gap:8px}
  .kebab{width:34px; height:34px; border-radius:10px; background:transparent; border:none; color:#e6ecf2; display:grid;place-items:center; cursor:pointer}
  .track-sub{font-size:12px; color:#9aa4b2; margin-top:-2px}
  .progress{width:100%; margin-bottom:10px}
  .seek{appearance:none; width:100%; height:6px; border-radius:999px; background:#2a3342; outline:none}
  .seek::-webkit-slider-thumb{appearance:none; width:18px; height:18px; border-radius:50%; background:#fff; border:2px solid #bbb}
  .seek::-moz-range-thumb{width:18px; height:18px; border-radius:50%; background:#fff; border:2px solid #bbb}

  .p-controls{display:flex; align-items:center; justify-content:space-between}
  .p-btn{width:44px; height:44px; border:none; background:transparent; color:#fff; display:grid; place-items:center; cursor:pointer; padding:0}
  .p-btn svg{width:28px; height:28px; stroke:#ffffff; opacity:.9}
  .p-play{width:62px; height:62px; border-radius:999px; background:linear-gradient(180deg,var(--amber),var(--amber-3)); color:#0b0f14; border:none; display:grid; place-items:center; box-shadow:0 8px 30px rgba(255,140,0,.35)}
  .p-play svg{width:28px; height:28px; stroke:#ffffff}

  .vol-pop{position:absolute; bottom:64px; right:16px; background:#0f1720; border:1px solid rgba(255,255,255,.12); padding:8px; border-radius:12px; display:none}
  .vol-pop.open{display:block}
  .vol-range{appearance:none; width:160px; height:6px; border-radius:999px; background:#2a3342}
  .vol-range::-webkit-slider-thumb{appearance:none; width:14px; height:14px; border-radius:50%; background:#fff; border:2px solid #bbb}
  .vol-range::-moz-range-thumb{width:14px; height:14px; border-radius:50%; background:#fff; border:2px solid #bbb}

  .menu-pop{position:absolute; bottom:64px; right:54px; background:#0f1720; border:1px solid rgba(255,255,255,.12); padding:8px; border-radius:12px; display:none; min-width:240px}
  .menu-pop.open{display:block}
  .menu-pop .menu-item{width:100%; text-align:left; padding:10px 10px; border-radius:10px; color:#e6ecf2; background:transparent; border:1px solid transparent; cursor:pointer}
  .menu-pop .menu-item:hover{background:#141e2e; border-color:rgba(255,255,255,.06)}

  /* ===== Configurações ===== */
  select, input[type="range"]{accent-color:var(--accent)}
</style>
</head>
<body class="theme-default">
  <div class="wrap" id="app">
    <header>
      <div class="userbox" id="userBtn" title="Abrir menu">
        <div class="avatar" id="avatarIcon">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Z" stroke-width="2.2"/><path d="M4 21a8 8 0 0 1 16 0" stroke-width="2.2" stroke-linecap="round"/></svg>
        </div>
      </div>

      <div id="menuBackdrop" class="backdrop"></div>
      <div class="menu" id="userMenu" aria-hidden="true">
        <h4>MENU</h4>
        <button class="mi" data-act="home"      id="miHome">Início</button>
        <button class="mi" data-act="settings"  id="miSettings">Configurações</button>
      </div>

      <div class="logo-wrap">
        <picture>
          <source srcset="/logolove.webp" type="image/webp">
          <img class="logo" src="/loove-logo.png" alt="Loove music">
        </picture>
      </div>
      <div class="tagline">TODO MUNDO AMA MÚSICA</div>

      <div class="search">
        <span id="searchIco" class="s-ico">
          <svg viewBox='0 0 24 24' fill='none'><circle cx='11' cy='11' r='7' stroke-width='2.2'/><path d='M20 20l-3.5-3.5' stroke-width='2.2' stroke-linecap='round'/></svg>
        </span>
        <input id="q" type="search" placeholder="Qual música você quer ouvir?" />
      </div>

      <!-- chips só como exemplo visual -->
      <div class="chips" id="chipsPremium">
        <button class="chip-premium">TOP-1.000</button>
        <button class="chip-premium">SUMMER ELETRO HITS</button>
        <button class="chip-premium">JOVEM PAN</button>
      </div>
    </header>

    <!-- HOME (placeholder) -->
    <section id="viewHome">
      <div class="grid" id="foldersGrid">
        <button class="folderBtn">POP</button>
        <button class="folderBtn">ELETRÔNICA</button>
        <button class="folderBtn">ROCK</button>
        <button class="folderBtn">SERTANEJO</button>
      </div>
    </section>

    <!-- LISTA (placeholder simples) -->
    <section id="viewList" class="card" style="display:none">
      <ul id="list" class="list"></ul>
      <div class="loadmore-wrap"><button id="btnMore" class="btn">Carregar mais</button></div>
    </section>

    <!-- CONFIGURAÇÕES -->
    <section id="viewSettings" class="card" style="display:none">
      <h3 style="margin-top:0" data-i18n="settings_title">Configurações</h3>

      <div style="display:flex; flex-direction:column; gap:14px; max-width:560px">
        <!-- Tema -->
        <div>
          <label class="muted" for="cfgTheme">Tema (cores do app)</label><br>
          <select id="cfgTheme" style="width:260px; padding:10px 12px; border-radius:12px;
                   border:1px solid rgba(255,255,255,.12); background:#0d1320; color:#e6ecf2">
            <option value="default">Cor Atual</option>
            <option value="pink">Rosa Neon</option>
            <option value="green">Verde Neon</option>
            <option value="black">Black</option>
          </select>
        </div>

        <!-- Preferência musical -->
        <div>
          <label class="muted" data-i18n="music_pref">Preferência musical</label>
          <div id="prefChips" class="chips" style="justify-content:flex-start; margin-top:8px">
            <button class="chip-premium" data-genre="Pop">Pop</button>
            <button class="chip-premium" data-genre="Eletrônica">Eletrônica</button>
            <button class="chip-premium" data-genre="Sertanejo">Sertanejo</button>
            <button class="chip-premium" data-genre="Funk">Funk</button>
            <button class="chip-premium" data-genre="Rock">Rock</button>
            <button class="chip-premium" data-genre="Pagode">Pagode</button>
            <button class="chip-premium" data-genre="Forró">Forró</button>
            <button class="chip-premium" data-genre="Hip Hop">Hip Hop</button>
            <button class="chip-premium" data-genre="MPB">MPB</button>
            <button class="chip-premium" data-genre="Gospel">Gospel</button>
          </div>
          <div class="muted" id="prefSummary" style="font-size:12px; margin-top:6px"></div>
        </div>

        <!-- Idioma -->
        <label class="muted" for="cfgLang" data-i18n="lang_label">Idioma do App</label>
        <select id="cfgLang" style="width:260px; padding:10px 12px; border-radius:12px;
                 border:1px solid rgba(255,255,255,.12); background:#0d1320; color:#e6ecf2">
          <option value="pt">Português</option>
          <option value="es">Español</option>
          <option value="en">English</option>
        </select>

        <!-- Mix DJ -->
        <div>
          <label class="muted" for="cfgMix" data-i18n="mix_label">Mix DJ (crossfade)</label>
          <div style="display:flex; align-items:center; gap:12px; margin-top:6px">
            <input id="cfgMix" type="range" min="0" max="12" step="1" style="width:260px">
            <strong id="cfgMixVal">0s</strong>
          </div>
          <p class="muted" data-i18n="mix_hint" style="margin:6px 0 0; font-size:12px">
            Dica: 6–8s costuma soar natural em músicas pop/eletrônica.
          </p>
        </div>

        <!-- Volume -->
        <label class="muted" data-i18n="app_volume">Volume do app
          <input id="cfgVol" type="range" min="0" max="1" step="0.01" style="width:260px; display:block; margin-top:6px" value="1">
        </label>

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:4px">
          <button id="btnClearPlayback" class="btn" data-i18n="clear_memory">Limpar memória de reprodução</button>
        </div>
      </div>
    </section>
  </div>

  <!-- =================== PLAYER =================== -->
  <footer class="player">
    <div class="player-shell">
      <div class="p-top">
        <div>
          <div class="track-title" id="nowTitle">Nada tocando</div>
          <div class="track-sub" id="nowFolder">—</div>
        </div>
        <div class="track-right">
          <div id="nowTime" class="muted">0:00 / 0:00</div>
          <button id="btnKebab" class="kebab" title="Opções">⋯</button>
        </div>
      </div>
      <div class="progress"><input id="seek" class="seek" type="range" min="0" max="1000" value="0" /></div>
      <div class="p-controls">
        <button id="pHome"   class="p-btn" title="Início">
          <svg viewBox="0 0 24 24" fill="none"><path d="M3 10.5 12 3l9 7.5M5 9.5v11h5v-6h4v6h5v-11" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.2"/></svg>
        </button>
        <button id="pSearch" class="p-btn" title="Buscar">
          <svg viewBox='0 0 24 24' fill='none'><circle cx='11' cy='11' r='7' stroke-width='2.2'/><path d='M20 20l-3.5-3.5' stroke-width='2.2' stroke-linecap='round'/></svg>
        </button>
        <button id="pPrev"   class="p-btn" title="Voltar">
          <svg viewBox='0 0 24 24' fill='none'><path d='M11 6l-7 6 7 6V6zM20 5v14' stroke-width='2.2' stroke-linejoin='round' stroke-linecap='round'/></svg>
        </button>
        <button id="pPlay"   class="p-play" title="Play/Pause">
          <svg viewBox='0 0 24 24' fill='none'><path d='M8 5l11 7-11 7V5z' stroke-width='2.2' stroke-linejoin='round' stroke='#ffffff'/></svg>
        </button>
        <button id="pNext"   class="p-btn" title="Avançar">
          <svg viewBox='0 0 24 24' fill='none'><path d='M13 6l7 6-7 6V6zM4 5v14' stroke-width='2.2' stroke-linejoin='round' stroke-linecap='round'/></svg>
        </button>
        <button id="pVolume" class="p-btn" title="Volume">
          <svg viewBox='0 0 24 24' fill='none'><path d='M4 10v4h4l6 5V5l-6 5H4z' stroke-width='2.2' stroke-linejoin='round' stroke-linecap='round'/><path d='M18 9a3 3 0 0 1 0 6M20 7a6 6 0 0 1 0 10' stroke-width='2.2' stroke-linecap='round'/></svg>
        </button>
        <div style="position:relative">
          <div id="volPop" class="vol-pop">
            <input id="volRange" class="vol-range" type="range" min="0" max="1" step="0.01" value="1" />
          </div>
        </div>
      </div>
      <div id="menuPop" class="menu-pop">
        <button class="menu-item" id="miShare">Compartilhar</button>
      </div>
    </div>
    <!-- Players A/B para crossfade (Mix DJ) -->
    <audio id="audioA" crossorigin="anonymous"></audio>
    <audio id="audioB" crossorigin="anonymous" style="display:none"></audio>
  </footer>

<script>
/* ============================
   Loove • App JS (unificado)
   ============================ */

/* ===== Helpers & Keys ===== */
const el = (id) => document.getElementById(id);
const THEME_KEY = "loove_theme_v1";
const PREF_MUSIC_KEY = "loove_pref_music_v1";
const LANG_KEY = "loove_lang_v1";
const MIX_KEY = "loove_mix_v1";
const PLAYBACK_KEY = "loove_playback_v2";

/* ===== Navegação do menu ===== */
const userBtn = el("userBtn"), userMenu = el("userMenu"), backdrop = el("menuBackdrop");
function closeMenu(){ userMenu.classList.remove("open"); userMenu.setAttribute("aria-hidden","true"); backdrop.classList.remove("open"); }
function openMenu(){ userMenu.classList.add("open"); userMenu.setAttribute("aria-hidden","false"); backdrop.classList.add("open"); }
userBtn?.addEventListener("click", (e)=>{ e.stopPropagation(); userMenu.classList.contains("open") ? closeMenu() : openMenu(); });
backdrop?.addEventListener("click", closeMenu);
document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeMenu(); });
const VIEWS = ["viewHome","viewList","viewSettings"];
function showOnly(v){ VIEWS.forEach(id=>{ const n=el(id); if(n) n.style.display = (id===v?"":"none"); }); }
userMenu?.addEventListener("click",(e)=>{
  const btn = e.target.closest(".mi"); if(!btn) return;
  const act = btn.getAttribute("data-act"); closeMenu();
  if(act==="home") showOnly("viewHome");
  if(act==="settings") showOnly("viewSettings");
});

/* ===== i18n básico ===== */
const I18N = {
  pt: {
    settings_title: "Configurações",
    music_pref: "Preferência musical",
    lang_label: "Idioma do App",
    mix_label: "Mix DJ (crossfade)",
    mix_hint: "Dica: 6–8s costuma soar natural em músicas pop/eletrônica.",
    app_volume: "Volume do app",
    clear_memory: "Limpar memória de reprodução",
    nothing_playing: "Nada tocando",
  },
  es: {
    settings_title: "Configuraciones",
    music_pref: "Preferencia musical",
    lang_label: "Idioma de la app",
    mix_label: "DJ Mix (crossfade)",
    mix_hint: "Tip: 6–8s suele sonar natural en pop/electrónica.",
    app_volume: "Volumen de la app",
    clear_memory: "Limpiar memoria de reproducción",
    nothing_playing: "Nada sonando",
  },
  en: {
    settings_title: "Settings",
    music_pref: "Music preference",
    lang_label: "App Language",
    mix_label: "DJ Mix (crossfade)",
    mix_hint: "Tip: 6–8s usually sounds natural for pop/electronic.",
    app_volume: "App volume",
    clear_memory: "Clear playback memory",
    nothing_playing: "Nothing playing",
  }
};
function applyI18n(lang){
  const dict = I18N[lang] || I18N.pt;
  document.querySelectorAll("[data-i18n]").forEach(node=>{
    const k = node.getAttribute("data-i18n");
    if(dict[k]) node.textContent = dict[k];
  });
  const q = el("q");
  if(q){
    if(lang==="es") q.placeholder = "¿Qué canción quieres escuchar?";
    else if(lang==="en") q.placeholder = "What song do you want to hear?";
    else q.placeholder = "Qual música você quer ouvir?";
  }
}

/* ===== Tema ===== */
function setTheme(theme){
  const body = document.body;
  body.classList.remove("theme-default","theme-pink","theme-green","theme-black");
  body.classList.add(`theme-${theme}`);
  localStorage.setItem(THEME_KEY, theme);
  const sel = el("cfgTheme"); if(sel) sel.value = theme;
}
function initTheme(){
  const saved = localStorage.getItem(THEME_KEY) || "default";
  setTheme(saved);
  const sel = el("cfgTheme");
  if(sel){
    sel.value = saved;
    sel.addEventListener("change", ()=> setTheme(sel.value));
  }
}

/* ===== Preferência musical (chips múltiplos) ===== */
function loadMusicPrefs(){
  try{ return JSON.parse(localStorage.getItem(PREF_MUSIC_KEY)||"[]"); }catch{return [];}
}
function saveMusicPrefs(arr){ localStorage.setItem(PREF_MUSIC_KEY, JSON.stringify(arr||[])); }
function refreshPrefUI(){
  const saved = new Set(loadMusicPrefs());
  const chips = document.querySelectorAll("#prefChips .chip-premium");
  chips.forEach(c=>{
    const g = c.getAttribute("data-genre");
    c.classList.toggle("active", saved.has(g));
  });
  const sum = el("prefSummary");
  if(sum){
    if(saved.size===0) sum.textContent = "Nenhum estilo selecionado.";
    else sum.textContent = "Preferências: " + Array.from(saved).join(", ");
  }
}
function initMusicPrefs(){
  const chipsWrap = el("prefChips"); if(!chipsWrap) return;
  chipsWrap.addEventListener("click",(ev)=>{
    const btn = ev.target.closest(".chip-premium"); if(!btn) return;
    const g = btn.getAttribute("data-genre");
    const set = new Set(loadMusicPrefs());
    if(set.has(g)) set.delete(g); else set.add(g);
    saveMusicPrefs(Array.from(set));
    refreshPrefUI();
  });
  refreshPrefUI();
}

/* ===== Idioma ===== */
function initLang(){
  const sel = el("cfgLang");
  const saved = localStorage.getItem(LANG_KEY) || "pt";
  if(sel) sel.value = saved;
  applyI18n(saved);
  if(sel){
    sel.addEventListener("change", ()=>{
      localStorage.setItem(LANG_KEY, sel.value);
      applyI18n(sel.value);
    });
  }
}

/* ====== Player com Crossfade (audioA/audioB) ====== */
const aA = el("audioA");
const aB = el("audioB");
let active = aA;       // elemento em uso
let standby = aB;      // próximo a tocar
let crossfadeSec = parseInt(localStorage.getItem(MIX_KEY)||"0",10) || 0;
let userPaused = false;

const nowTitle = el("nowTitle");
const nowFolder = el("nowFolder");
const nowTime = el("nowTime");
const seek = el("seek");
const pPlay = el("pPlay");
const pPrev = el("pPrev");
const pNext = el("pNext");
const pVolume = el("pVolume");
const volRange = el("volRange");

function fmt(t){ if(!isFinite(t)||t<0) return "0:00"; const m=Math.floor(t/60), s=Math.floor(t%60); return m+":"+(s<10?"0":"")+s; }
function updateTimeUI(){
  const cur = active;
  const dur = cur.duration||0, pos = cur.currentTime||0;
  if(nowTime) nowTime.textContent = `${fmt(pos)} / ${fmt(dur)}`;
  if(seek){
    seek.value = (dur>0 && !isNaN(dur)) ? Math.round((pos/dur)*1000) : 0;
  }
}
[aA,aB].forEach(a=>{
  a.addEventListener("timeupdate", updateTimeUI);
  a.addEventListener("loadedmetadata", updateTimeUI);
  a.addEventListener("ended", ()=>{ setPlayIcon(false); });
});

function setPlayIcon(isPlaying){
  if(!pPlay) return;
  pPlay.innerHTML = isPlaying
    ? `<svg viewBox="0 0 24 24" fill="none"><path d="M8 5v14M16 5v14" stroke="#ffffff" stroke-width="2.6" stroke-linecap="round"/></svg>`
    : `<svg viewBox='0 0 24 24' fill='none'><path d='M8 5l11 7-11 7V5z' stroke-width='2.2' stroke-linejoin='round' stroke='#ffffff'/></svg>`;
}

function setMeta(meta){
  if(meta?.title && nowTitle) nowTitle.textContent = meta.title;
  if(meta?.folder && nowFolder) nowFolder.textContent = meta.folder;
  if(!meta?.title && nowTitle){
    const lang = localStorage.getItem(LANG_KEY)||"pt";
    nowTitle.textContent = (I18N[lang]||I18N.pt).nothing_playing;
  }
}

function setVolume(v){
  [aA,aB].forEach(a=> a.volume = v);
  if(volRange) volRange.value = String(v);
  const cfgVol = el("cfgVol");
  if(cfgVol) cfgVol.value = String(v);
}

function crossfadeTo(src, meta){
  // se não estiver tocando nada, apenas carrega no ativo
  if(!active.src){
    active.src = src;
    setMeta(meta);
    active.play().then(()=>{ setPlayIcon(true); userPaused=false; savePlaybackState(true); }).catch(()=>{});
    return;
  }

  // Troca standby ↔ ativo
  const old = active, next = standby;
  next.src = src;
  next.currentTime = 0;
  next.volume = 0;
  next.muted = false;
  setMeta(meta);

  const doStart = ()=> next.play().catch(()=>{});

  if(crossfadeSec <= 0){
    old.pause();
    doStart();
    active = next; standby = old;
    setPlayIcon(true); userPaused=false; savePlaybackState(true);
    return;
  }

  doStart();
  const steps = 30;
  let i = 0;
  const iv = setInterval(()=>{
    i++;
    const t = Math.min(1, i/steps);
    next.volume = t * (volRange ? Number(volRange.value||1) : 1);
    old.volume = (1 - t) * (volRange ? Number(volRange.value||1) : 1);
    if(i >= steps){
      clearInterval(iv);
      old.pause(); old.currentTime = 0; old.src = "";
      next.volume = volRange ? Number(volRange.value) : 1;
      active = next; standby = old;
      setPlayIcon(true); userPaused=false; savePlaybackState(true);
    }
  }, (crossfadeSec*1000)/steps);
}

function savePlaybackState(playing){
  try{
    const meta = {
      title: nowTitle?.textContent || "",
      folder: nowFolder?.textContent || "",
      pos: Math.floor(active?.currentTime || 0),
      playing: !!playing
    };
    localStorage.setItem(PLAYBACK_KEY, JSON.stringify(meta));
  }catch{}
}

function restorePlaybackState(){
  try{
    const st = JSON.parse(localStorage.getItem(PLAYBACK_KEY)||"{}");
    if(st.title) setMeta({title: st.title, folder: st.folder});
    setPlayIcon(!!st.playing);
  }catch{}
}

/* ===== API global para você tocar qualquer URL ===== */
window.Loove = {
  playUrl: (url, meta={})=> crossfadeTo(url, meta),
  setCrossfade: (sec)=>{ crossfadeSec = Math.max(0, Number(sec)||0); localStorage.setItem(MIX_KEY, String(crossfadeSec)); el("cfgMix") && (el("cfgMix").value = crossfadeSec); el("cfgMixVal") && (el("cfgMixVal").textContent = crossfadeSec+"s"); },
  setVolume,
  getCurrentAudio: ()=> active
};

/* ===== Controles do player ===== */
seek && seek.addEventListener("input", ()=>{
  const dur = active.duration||0;
  if(dur>0) active.currentTime = (Number(seek.value)/1000)*dur;
  updateTimeUI();
});
pPlay && (pPlay.onclick = ()=>{
  if(!active.src) return;
  if(active.paused){ active.play().then(()=>{ setPlayIcon(true); userPaused=false; savePlaybackState(true);}).catch(()=>{}); }
  else { active.pause(); setPlayIcon(false); userPaused=true; savePlaybackState(false); }
});
pPrev && (pPrev.onclick = ()=>{ if(typeof window.LoovePrevHandler==="function") window.LoovePrevHandler(); });
pNext && (pNext.onclick = ()=>{ if(typeof window.LooveNextHandler==="function") window.LooveNextHandler(); });

/* Volume */
volRange && volRange.addEventListener("input", ()=> setVolume(Number(volRange.value)));
const cfgVol = el("cfgVol");
cfgVol && cfgVol.addEventListener("input", ()=> setVolume(Number(cfgVol.value)));

/* Mix DJ (config) */
function initMix(){
  const mix = el("cfgMix");
  const val = el("cfgMixVal");
  crossfadeSec = parseInt(localStorage.getItem(MIX_KEY)||"0",10) || 0;
  if(mix){
    mix.value = String(crossfadeSec);
    val && (val.textContent = crossfadeSec + "s");
    mix.addEventListener("input", ()=>{
      crossfadeSec = Math.max(0, parseInt(mix.value||"0",10));
      localStorage.setItem(MIX_KEY, String(crossfadeSec));
      val && (val.textContent = crossfadeSec + "s");
    });
  }
}

/* Limpar memória */
const btnClear = el("btnClearPlayback");
btnClear && (btnClear.onclick = ()=>{ localStorage.removeItem(PLAYBACK_KEY); alert("Memória de reprodução limpa."); });

/* Volume inicial */
(function initVolumeOnce(){
  const v = cfgVol ? Number(cfgVol.value||1) : 1;
  setVolume(v);
})();

/* Preferências musicais */
function refreshPrefUI(){
  const saved = new Set(loadMusicPrefs());
  const chips = document.querySelectorAll("#prefChips .chip-premium");
  chips.forEach(c=>{
    const g = c.getAttribute("data-genre");
    c.classList.toggle("active", saved.has(g));
  });
  const sum = el("prefSummary");
  if(sum){
    if(saved.size===0) sum.textContent = "Nenhum estilo selecionado.";
    else sum.textContent = "Preferências: " + Array.from(saved).join(", ");
  }
}

/* Inicialização geral */
(function boot(){
  initTheme();
  initMusicPrefs();
  initLang();
  initMix();
  restorePlaybackState();
  setPlayIcon(false);
  showOnly("viewHome");
})();

/* ===== DEMO RÁPIDO (opcional)
   Você pode testar tocando uma URL pública de áudio no console:
   Loove.playUrl("https://www2.cs.uic.edu/~i101/SoundFiles/StarWars60.wav", {title:"Star Wars 60", folder:"Demo"})
*/
</script>
</body>
</html>
