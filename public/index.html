<!doctype html> 
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Loove • Music App</title>
<style>
  :root{
    --bg:#0b0f14; --card:#121826; --muted:#9aa4b2; --text:#e6ecf2;
    --accent:#ff2fb3;
    --amber:#ff9f1a; --amber-2:#ffb02e; --amber-3:#ff7a00;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:
      radial-gradient(1000px 600px at 10% -10%, rgba(49,225,255,.08), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, rgba(255,47,179,.07), transparent 60%),
      var(--bg); color:var(--text);
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    min-height:100vh; display:flex; flex-direction:column;
  }
  .wrap{max-width:980px;margin:0 auto;padding:12px}
  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg, rgba(11,15,20,.95), rgba(11,15,20,.65) 60%, rgba(11,15,20,0));backdrop-filter: blur(6px)}
  .userbox{position:absolute; top:10px; right:10px; display:flex; align-items:center; gap:8px; cursor:pointer}
  .avatar{width:36px;height:36px;border-radius:50%;background:#0d1320;border:1px solid rgba(255,255,255,.08);display:grid;place-items:center}
  .logo-wrap{display:flex;justify-content:center;align-items:center;margin:10px 0 6px}
  .logo{height:64px;display:block}
  @media(max-width:739px){ .logo{height:44px} }

  .tagline{text-align:center;color:#9aa4b2;font-size:12px;margin-bottom:10px}
  .search{display:flex;gap:8px;align-items:center;padding:0 6px 10px}
  .s-ico{width:18px;height:18px;display:inline-block;filter:drop-shadow(0 0 8px rgba(49,225,255,.3))}
  .search input{flex:1; padding:16px 16px; border-radius:18px; border:1px solid rgba(255,255,255,.1); background:#0d1320; color:var(--text); font-size:16px}
  .search input:focus{outline:none; box-shadow:0 0 0 2px rgba(49,225,255,.35)}

  /* chips premium */
  .chips{display:flex; gap:10px; flex-wrap:wrap; margin:10px auto 14px; justify-content:center}
  .chip-premium{background:#0d1320; color:var(--text); border:2px solid rgba(255,255,255,.08); border-radius:999px; padding:8px 14px; font-weight:800; letter-spacing:.2px; box-shadow: 0 4px 16px rgba(255,140,0,.15)}
  .chip-premium:hover{ box-shadow: 0 0 0 2px rgba(255,140,0,.35), 0 8px 20px rgba(255,140,0,.25); transform:translateY(-1px) }

  .muted{color:#9aa4b2}
  .card{background:linear-gradient(180deg,#121826,#0c111b); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px}

  /* grid de pastas (home e subpastas) */
  .grid{display:grid; gap:12px; margin-top:10px}
  @media(min-width:1024px){ .grid{grid-template-columns: repeat(4, 1fr);} }
  @media(min-width:740px) and (max-width:1023px){ .grid{grid-template-columns: repeat(3, 1fr);} }
  @media(max-width:739px){ .grid{grid-template-columns: repeat(2, 1fr);} }
  .folderBtn{
    border-radius:16px; padding:14px 12px; font-weight:900; text-transform:uppercase;
    background:#0e1422; color:#e6ecf2; border:1px solid rgba(255,255,255,.08); cursor:pointer;
  }
  .folderBtn:hover{background:#121a2b}

  /* lista de músicas */
  .track{display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px; padding:8px; border-bottom:1px solid rgba(255,255,255,.06)}
  .t-left{display:flex;align-items:center;gap:10px}
  .t-play{width:36px;height:36px;border-radius:50%;border:1px solid rgba(255,255,255,.1);background:#0c111b;color:#e6ecf2;cursor:pointer}
  .t-titleBox{display:flex;flex-direction:column}
  .t-title{font-weight:900}
  .t-sub{font-size:12px;color:#9aa4b2}
  .t-right{display:flex;align-items:center;gap:8px}
  .like{width:32px;height:32px;border-radius:50%;border:1px solid rgba(255,255,255,.1);background:#0c111b;color:#e6ecf2;cursor:pointer}
  .t-kebab{width:32px;height:32px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#0c111b;color:#e6ecf2;cursor:pointer}
  .t-menu{position:absolute;background:#0f1720;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:6px;display:none;z-index:6}
  .t-menu.open{display:block}
  .t-menu .menu-item{width:100%;text-align:left;padding:8px 10px;border-radius:10px;background:transparent;border:1px solid transparent;color:#e6ecf2;cursor:pointer;font-weight:700}
  .t-menu .menu-item:hover{background:#141e2e;border-color:rgba(255,255,255,.06)}

  /* menu principal */
  .menu{position:fixed; right:10px; top:54px; background:#0f1720; border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:10px; z-index:30; display:none; width:220px}
  .menu.open{display:block}
  .menu h4{margin:6px 4px 8px; color:#9aa4b2}
  .mi{width:100%; text-align:left; padding:10px 10px; border-radius:12px; background:transparent; border:1px solid transparent; cursor:pointer; color:#e6ecf2; font-weight:800}
  .mi:hover{background:#141e2e; border-color:rgba(255,255,255,.06)}
  .sep{height:1px;background:rgba(255,255,255,.08);margin:6px 2px}

  /* popups */
  .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.3); display:none; z-index:25}

  /* ====== MINHAS PLAYLISTS ====== */
  .pl-head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin:6px 0 8px}
  .pl-grid{display:grid; gap:12px; margin-top:8px}
  @media(min-width:1024px){ .pl-grid{grid-template-columns: repeat(4, 1fr);} }
  @media(min-width:740px) and (max-width:1023px){ .pl-grid{grid-template-columns: repeat(3, 1fr);} }
  @media(max-width:739px){ .pl-grid{grid-template-columns: repeat(2, 1fr);} }

  /* NOVO ESTILO (pedido): fundo cinza escuro, texto laranja neon e bordas neon */
  .pl-item{
    min-height:92px; padding:10px; border-radius:18px; cursor:pointer;
    display:flex; align-items:center; justify-content:center; text-align:center;
    background:#1a1f27; color:#ff9f1a; font-weight:900; font-size:18px; text-transform:uppercase;
    border:2px solid #ff9f1a; 
    box-shadow: 0 0 10px rgba(255,159,26,.45), 0 4px 18px rgba(255,159,26,.25);
    text-shadow:0 0 8px rgba(255,159,26,.35);
    position:relative;
  }
  .pl-item::after{ content:"›"; position:absolute; right:10px; top:6px; font-size:22px; font-weight:900; opacity:.95; color:#ffb02e }
  .pl-dot{
    position:absolute; top:6px; right:34px; width:28px; height:28px; display:grid; place-items:center;
    background:transparent; border:none; cursor:pointer; color:#ffcf8a; opacity:.95
  }
  .pl-menu{
    position:absolute; right:8px; top:34px; background:#0f1720; border:1px solid rgba(255,255,255,.12);
    border-radius:12px; padding:6px; min-width:160px; display:none; z-index:6;
  }
  .pl-menu.open{display:block}
  .pl-menu button{width:100%; text-align:left; padding:8px 10px; border-radius:10px; background:transparent; border:1px solid transparent; color:#e6ecf2; cursor:pointer; font-weight:700}
  .pl-menu button:hover{background:#141e2e; border-color:rgba(255,255,255,.06)}

  .pl-modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:80}
  .pl-modal.open{display:flex}
  .pl-card{width:min(92vw,420px); background:#0f1720; border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:12px}
  .pl-title{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px}
  .pl-close{background:transparent; border:none; color:#e6ecf2; font-size:18px; cursor:pointer}
  .pl-row{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border:1px solid rgba(255,255,255,.08); border-radius:12px; margin:6px 0; background:#0c1117; cursor:pointer}
  .pl-row strong{font-weight:900}

  /* ====== PLAYER ====== */
  footer{position:sticky; bottom:0; z-index:40; background:linear-gradient(0deg, rgba(11,15,20,.95), rgba(11,15,20,.65) 60%, rgba(11,15,20,0))}
  .player{display:grid; grid-template-columns:1fr auto; align-items:center; gap:8px; padding:10px}
  .now{display:flex; align-items:center; gap:10px}
  .cover{width:44px;height:44px;border-radius:10px;background:#0e1422;border:1px solid rgba(255,255,255,.08)}
  .p-title{font-weight:900}
  .p-sub{font-size:12px; color:#9aa4b2}
  .p-controls{display:flex; align-items:center; gap:8px; justify-content:center}
  .p-btn,.p-play{
    width:36px;height:36px; border-radius:12px; border:1px solid rgba(255,255,255,.1);
    background:#0c111b; color:#e6ecf2; cursor:pointer;
  }
  .p-play{width:44px;height:44px;border-radius:18px}
  .progress{padding:0 10px}
  .seek{width:100%}

  /* Downloads: lista de singles simples */
  .dl-singles .t-sub small{opacity:.7}
</style>
</head>
<body>
  <div class="wrap" id="app" style="display:none">
    <header>
      <div class="userbox" id="userBtn" title="Abrir menu">
        <div class="avatar" id="avatarIcon"></div>
      </div>

      <div id="menuBackdrop" class="backdrop"></div>
      <div class="menu" id="userMenu" aria-hidden="true">
        <h4>MENU</h4>
        <button class="mi" data-act="home"      id="miHome"></button>
        <button class="mi" data-act="account"   id="miAccount"></button>
        <button class="mi" data-act="search"    id="miSearch"></button>
        <button class="mi" data-act="playlists" id="miPlaylists"></button>
        <button class="mi" data-act="downloads" id="miDowns"></button>
        <button class="mi" data-act="favs"      id="miFavs"></button>
        <button class="mi" data-act="billing"   id="miBilling"></button>
        <button class="mi" data-act="settings"  id="miSettings"></button>
        <button class="mi" data-act="notify"    id="miNotify"></button>
        <div class="sep"></div>
        <button class="mi" data-act="help"      id="miHelp"></button>
        <div class="sep"></div>
        <button class="mi" data-act="logout"    id="miLogout"></button>
      </div>

      <div class="logo-wrap">
        <picture>
          <source srcset="/logolove.webp" type="image/webp">
          <img class="logo" src="/loove-logo.png" alt="Loove music">
        </picture>
      </div>
      <div class="tagline">TODO MUNDO AMA MÚSICA</div>

      <div class="search">
        <span id="searchIco" class="s-ico"></span>
        <input id="q" type="search" placeholder="Qual música você quer ouvir?" />
      </div>

      <div class="chips" id="chipsPremium">
        <button class="chip-premium" data-p="top1000">TOP-1.000</button>
        <button class="chip-premium" data-p="summer">SUMMER ELETRO HITS</button>
        <button class="chip-premium" data-p="jovempan">JOVEM PAN</button>
        <button class="chip-premium" data-p="setsremix">SETS REMIX</button>
        <button class="chip-premium" data-p="secret">PLAYLIST SECRETA</button>
        <button class="chip-premium" data-p="flashbackgold">FLASHBACK GOLD</button>
      </div>
    </header>

    <!-- HOME -->
    <section id="viewHome" class="card">
      <h3 style="margin:0">Navegar</h3>
      <div id="foldersGrid" class="grid"></div>
    </section>

    <!-- LISTAGEM DE MÚSICAS -->
    <section id="viewList" class="card" style="display:none">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <h3 id="listTitle" style="margin:0">Músicas</h3>
        <div style="display:flex;gap:8px">
          <button id="btnBack" class="btn btn-secondary">⬅ Voltar</button>
          <button id="btnMore" class="btn btn-primary">Carregar mais</button>
        </div>
      </div>
      <ul id="list" style="list-style:none;margin:10px 0 0;padding:0;position:relative"></ul>
    </section>

    <!-- FAVORITOS -->
    <section id="viewFavs" class="card" style="display:none">
      <div class="pl-head">
        <h3 style="margin:0">Favoritos</h3>
        <button id="btnFavPlayAll" class="btn btn-primary" title="Escutar todas">▶ Escutar todas</button>
      </div>
      <div id="favList"></div>
    </section>

    <!-- MINHAS PLAYLISTS -->
    <section id="viewPlaylists" class="card" style="display:none">
      <div class="pl-head">
        <h3 style="margin:0">Minhas playlists</h3>
        <button id="btnCreatePl" class="btn btn-primary">+ Criar playlist</button>
      </div>
      <div id="myPlGrid" class="pl-grid"></div>
    </section>

    <!-- DOWNLOADS (NOVO) -->
    <section id="viewDownloads" class="card" style="display:none">
      <div class="pl-head">
        <h3 style="margin:0">Downloads</h3>
        <div class="muted">Off-line dentro do aplicativo</div>
      </div>
      <div id="dlPlGrid" class="pl-grid"></div>
      <h4 style="margin:12px 0 6px">Músicas baixadas</h4>
      <div id="dlSingles" class="dl-singles"></div>
    </section>

    <!-- MODAL: Seletor de Playlist -->
    <div id="plModal" class="pl-modal" aria-hidden="true">
      <div class="pl-card">
        <div class="pl-title">
          <h3 style="margin:0">Adicionar à playlist</h3>
          <button id="plClose" class="pl-close" title="Fechar">✕</button>
        </div>
        <div id="plList"></div>
      </div>
    </div>

    <!-- PLAYER -->
    <footer class="card">
      <div class="player">
        <div class="now">
          <div class="cover"></div>
          <div>
            <div class="p-title" id="nowTitle">Nada tocando</div>
            <div class="p-sub" id="nowSub"></div>
          </div>
        </div>
        <div class="p-controls">
          <button id="pHome"   class="p-btn" title="Início"></button>
          <button id="pSearch" class="p-btn" title="Buscar"></button>
          <button id="pPrev"   class="p-btn" title="Voltar"></button>
          <button id="pPlay"   class="p-play" title="Play/Pause"></button>
          <button id="pNext"   class="p-btn" title="Avançar"></button>
          <button id="pShuffle" class="p-btn" title="Shuffle"></button>
          <button id="pRepeat"  class="p-btn" title="Repeat"></button>
          <div style="position:relative">
            <button id="pVolume"  class="p-btn" title="Volume"></button>
            <div id="volPop" class="vol-pop">
              <input id="volRange" type="range" min="0" max="1" step="0.01" value="1" />
            </div>
          </div>

          <div style="position:relative">
            <button id="btnKebab" class="p-btn" title="Menu"></button>
            <div id="menuPop" class="menu-pop">
              <button class="menu-item" id="miShare">Compartilhar</button>
              <button class="menu-item" id="miFav">Favoritar</button>
              <button class="menu-item" id="miDown">Download (off-line)</button>
              <button class="menu-item" id="miCreatePl">Criar playlist</button>
              <button class="menu-item" id="miSavePl">Adicionar na playlist</button>
            </div>
          </div>
        </div>
      </div>
      <div class="progress"><input id="seek" class="seek" type="range" min="0" max="1000" value="0" /></div>
    </footer>
  </div>

  <!-- LOGIN -->
  <section id="viewLogin" class="wrap card" style="display:none">
    <h3 style="margin:0 0 8px">Entrar</h3>
    <form id="formLogin" onsubmit="return false;">
      <input id="pin" type="password" placeholder="PIN" style="width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0c111b;color:#e6ecf2" />
      <div id="msg" class="muted" style="margin-top:6px"></div>
      <button id="btnLogin" class="btn btn-primary" style="margin-top:10px">Entrar</button>
    </form>
  </section>

<script>
  const TOKEN_KEY = "loove_token_v1";
  const DL_KEY    = "loove_dl_manifest_v1";     // playlists e singles baixados
  const CACHE_AUD = "loove_audio_v1";

  const el = (id)=> document.getElementById(id);
  function icoUser(){return "👤"} function icoHome(){return "🏠"} function icoAccount(){return "👛"}
  function icoSearch(){return "🔎"} function icoPlaylist(){return "🎛️"} function icoDownload(){return "⬇️"}
  function icoStar(){return "⭐"} function icoCard(){return "💳"} function icoSettings(){return "⚙️"}
  function icoBell(){return "🔔"} function icoHelp(){return "❓"} function icoLogout(){return "🚪"}
  function icoVolume(){return "🔊"} function icoPlay(){return "▶"} function icoPause(){return "⏸"}
  function icoRepeat(){return "🔁"}

  /* ====== INICIAL ====== */
  function show(id){ const n=el(id); if(n) n.style.display=""; }
  function hide(id){ const n=el(id); if(n) n.style.display="none"; }
  async function api(path, opts = {}) {
    const headers = Object.assign(
      { "Content-Type":"application/json" },
      opts.headers || {},
      localStorage.getItem(TOKEN_KEY) ? { Authorization: "Bearer " + localStorage.getItem(TOKEN_KEY) } : {}
    );
    const res = await fetch(path, Object.assign({}, opts, { headers }));
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw data || { error: "HTTP " + res.status };
    return data;
  }

  let currentPrefix = "", nextToken = null, items = [];
  let premiumFolders = [];

  async function ensureAuth(){
    try { await api("/api/me"); show("app"); hide("viewLogin"); }
    catch { hide("app"); show("viewLogin"); }
  }
  el("formLogin").addEventListener("submit", async ()=>{
    const pin = el("pin").value.trim();
    if(pin.length<3){ el("msg").textContent="Digite pelo menos 3 dígitos."; return; }
    el("msg").textContent="Entrando...";
    try{
      const d = await api("/api/login",{ method:"POST", body: JSON.stringify({ pin }) });
      if(!d.token) throw d;
      localStorage.setItem(TOKEN_KEY, d.token);
      el("msg").textContent = "Login OK!";
      await goHome();
    }catch(e){ el("msg").textContent = e?.error || "Falha no login"; }
  });

  async function goHome(){
    currentPrefix = "";
    hide("viewList"); hide("viewFavs"); hide("viewPlaylists"); hide("viewDownloads"); show("viewHome");
    await loadRootFolders();
  }

  async function loadRootFolders(){
    const g = el("foldersGrid"); g.innerHTML = "";
    const d = await api("/api/folders?prefix=");
    const folders = (d.folders || []);
    if(!folders.length){ g.innerHTML = `<div class="card">Nenhuma pasta encontrada na raiz do bucket.</div>`; return; }
    folders.forEach(f=>{
      const b = document.createElement("button");
      b.className = "folderBtn";
      b.textContent = (f.name || f.prefix || "pasta").replace(/\/$/,"");
      b.onclick = ()=> enterFolder(f.prefix);
      g.appendChild(b);
    });
  }

  function slug(s){ return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""); }

  /* ===== LISTAGEM ===== */
  async function enterFolder(prefix="", token=null){
    currentPrefix = prefix || "";
    hide("viewHome"); hide("viewFavs"); hide("viewPlaylists"); hide("viewDownloads"); show("viewList");
    el("listTitle").textContent = (prefix || "/").replace(/\/$/,"");
    const d = await api("/api/list?prefix="+encodeURIComponent(prefix)+(token?("&token="+encodeURIComponent(token)):""));
    items = d.items || []; nextToken = d.nextToken || null; renderList();
    el("btnBack").onclick = ()=> goHome();
    el("btnMore").disabled = !nextToken;
    el("btnMore").onclick = async ()=>{
      if(!nextToken) return;
      const more = await api("/api/list?prefix="+encodeURIComponent(currentPrefix)+"&token="+encodeURIComponent(nextToken));
      items = items.concat(more.items||[]); nextToken = more.nextToken || null; renderList();
      el("btnMore").disabled = !nextToken;
    };
  }

  function formatTitle(filename=""){ let name = filename.replace(/\.[a-z0-9]{2,5}$/i,""); name = name.replace(/\s*[-–—]\s*/," – "); return name; }
  function parentFolderFromKey(key=""){ const path = key.split("/"); path.pop(); return path.join("/") || "/"; }

  function renderList(){
    const UL = el("list"); UL.innerHTML = "";
    if(!items.length){
      UL.innerHTML = `<li class="muted" style="list-style:none;padding:8px 2px">Nenhuma música nesta pasta.</li>`;
      return;
    }
    items.forEach(m=>{
      const LI = document.createElement("li");
      LI.className = "track";
      LI.setAttribute("data-key", m.key);

      const left = document.createElement("div");
      left.className = "t-left";
      const btPlay = document.createElement("button");
      btPlay.className = "t-play";
      btPlay.innerHTML = "▶";
      btPlay.onclick = ()=> playKey(m.key, m.name);
      left.appendChild(btPlay);

      const mid = document.createElement("div");
      mid.className="t-titleBox";
      const t1 = document.createElement("div");
      t1.className="t-title";
      t1.textContent = formatTitle(m.name);
      const t2 = document.createElement("div");
      t2.className="t-sub";
      t2.textContent = parentFolderFromKey(m.key);
      mid.appendChild(t1); mid.appendChild(t2);

      const right = document.createElement("div");
      right.className="t-right";
      const like = document.createElement("button"); like.className="like"; like.title="Favoritar"; like.textContent="♥"; like.onclick = ()=> toggleFav(m.key);
      const keb  = document.createElement("button"); keb.className="t-kebab"; keb.textContent="⋮";
      const menu = document.createElement("div");
      menu.className="t-menu";
      menu.innerHTML = `
        <button class="menu-item miShare">Compartilhar</button>
        <button class="menu-item miFav">${isFav(m.key)?"Remover dos favoritos":"Favoritar"}</button>
        <button class="menu-item miDown">Download (off-line)</button>
        <button class="menu-item miCreatePl">Criar playlist</button>
        <button class="menu-item miAddPl">Adicionar na playlist</button>
      `;

      keb.onclick = (e)=>{
        e.stopPropagation();
        const was = menu.classList.contains("open");
        closeAllItemMenus();
        if(!was) menu.classList.add("open");
      };
      menu.querySelector(".miShare").onclick = async ()=>{
        menu.classList.remove("open");
        try{
          const url = location.href;
          if(navigator.share){ await navigator.share({ title: 'Loove', url }); }
          else{ await navigator.clipboard.writeText(url); alert("Link copiado!"); }
        }catch{}
      };
      menu.querySelector(".miFav").onclick = ()=>{
        toggleFav(m.key);
        like.classList.toggle("active");
        menu.classList.remove("open");
      };
      menu.querySelector(".miCreatePl").onclick = ()=>{
        menu.classList.remove("open");
        const name = prompt("Nome da nova playlist:");
        if(!name) return;
        const pl = createPlaylistInternal(name.trim());
        if(pl){ alert("Playlist criada!"); renderMyPlaylists(); }
      };
      menu.querySelector(".miAddPl").onclick = ()=>{
        menu.classList.remove("open");
        openPlaylistPicker(m.key);
      };
      menu.querySelector(".miDown").onclick = async ()=>{
        menu.classList.remove("open");
        const def = "Downloads";
        const pname = prompt("Salvar em qual playlist off-line?", def) || def;
        try{
          await downloadTrack(m.key, m.name, pname.trim());
          alert("Baixada para uso off-line!");
          renderDownloads();
        }catch(e){
          console.error(e);
          alert("Não foi possível baixar agora.");
        }
      };

      right.appendChild(like);
      right.appendChild(keb);

      LI.appendChild(left);
      LI.appendChild(mid);
      LI.appendChild(right);
      LI.appendChild(menu);
      UL.appendChild(LI);
    });
  }

  function closeAllItemMenus(){ document.querySelectorAll(".t-menu.open").forEach(m=>m.classList.remove("open")); }
  document.addEventListener("click",(ev)=>{
    if(!ev.target.closest(".t-menu") && !ev.target.closest(".t-kebab")){
      closeAllItemMenus();
    }
  });

  /* ===== FAVORITOS ===== */
  function favs(){ try{ return JSON.parse(localStorage.getItem("loove_favs")||"[]"); }catch{return []} }
  function setFavs(v){ localStorage.setItem("loove_favs", JSON.stringify(v)); }
  function isFav(k){ return favs().includes(k); }
  function toggleFav(k){
    const f = favs(); const i=f.indexOf(k);
    if(i>=0) f.splice(i,1); else f.push(k);
    setFavs(f);
  }

  /* ===== BUSCA ===== */
  async function doSearch(){
    const q = el("q").value.trim();
    if(q.length<3){ alert("Digite pelo menos 3 letras."); return; }
    hide("viewHome"); hide("viewFavs"); hide("viewPlaylists"); hide("viewDownloads"); show("viewList");
    const d = await api("/api/search?q="+encodeURIComponent(q)+"&prefix="+encodeURIComponent(currentPrefix||""));
    items = d.items || []; nextToken = null; renderList();
  }
  el("q").addEventListener("keydown", e=>{ if(e.key==="Enter") doSearch(); });

  /* ===== PLAYER ===== */
  const audio = new Audio();
  let currentKey="", currentName="", shuffleOn=false, repeatOn=false;
  const seek = el("seek");
  function setNow(name,key){ el("nowTitle").textContent = formatTitle(name||""); el("nowSub").textContent = parentFolderFromKey(key); }
  function updateTimeUI(){ const dur=audio.duration||0, cur=(audio.currentTime||0); el("seek").value = Math.floor((cur/(dur||1))*1000); }
  audio.addEventListener("timeupdate", updateTimeUI);
  audio.addEventListener("loadedmetadata", updateTimeUI);
  audio.addEventListener("ended", ()=>{
    setPlayIcon(false);
    if(repeatOn){ audio.currentTime=0; audio.play(); setPlayIcon(true); return; }
    if(items.length){
      let idx = items.findIndex(it => it.key===currentKey); if(idx<0) idx=0;
      if(shuffleOn){ const r = Math.floor(Math.random()*items.length); playKey(items[r].key, items[r].name); }
      else if(idx < items.length-1){ playKey(items[idx+1].key, items[idx+1].name); }
    }
  });
  seek.addEventListener("input", ()=>{ const dur=audio.duration||0; audio.currentTime = (Number(seek.value)/1000)*dur; updateTimeUI(); });

  function setPlayIcon(isPlaying){ el("pPlay").innerHTML = isPlaying ? icoPause() : icoPlay(); }
  pPlay.onclick = ()=>{ if(!audio.src) return; if(audio.paused){ audio.play(); setPlayIcon(true); } else { audio.pause(); setPlayIcon(false); } };
  pPrev.onclick = ()=>{ if(items.length){ let idx=items.findIndex(it=>it.key===currentKey); if(idx>0) playKey(items[idx-1].key, items[idx-1].name); } };
  pNext.onclick = ()=>{ if(items.length){ let idx=items.findIndex(it=>it.key===currentKey); if(idx<items.length-1) playKey(items[idx+1].key, items[idx+1].name); } };
  pHome.onclick = goHome;
  pSearch.onclick = ()=> el("q").focus();
  pShuffle.onclick = ()=>{ shuffleOn=!shuffleOn; pShuffle.classList.toggle("active", shuffleOn); };
  pRepeat.onclick  = ()=>{ repeatOn =!repeatOn; pRepeat.classList.toggle("active", repeatOn); audio.loop = repeatOn; };

  const volPop = el("volPop"), volRange=el("volRange"), menuPop=el("menuPop"), btnKebab=el("btnKebab");
  pVolume.onclick = (e)=>{ e.stopPropagation(); menuPop.classList.remove("open"); volPop.classList.toggle("open"); };
  volRange.addEventListener("input", ()=>{ audio.volume = Number(volRange.value); });
  document.addEventListener("click", (ev)=>{
    if(!volPop.contains(ev.target) && !pVolume.contains(ev.target)) volPop.classList.remove("open");
    if(!menuPop.contains(ev.target) && !btnKebab.contains(ev.target)) menuPop.classList.remove("open");
  });
  btnKebab.onclick = (e)=>{ e.stopPropagation(); menuPop.classList.toggle("open"); volPop.classList.remove("open"); };

  el("miShare").onclick = async ()=>{ try{ if(navigator.share){ await navigator.share({ title:"Loove", url:location.href }); } else { await navigator.clipboard.writeText(location.href); alert("Link copiado!"); } }catch{} };
  el("miFav").onclick = ()=>{ if(currentKey) { toggleFav(currentKey); alert("Favorito atualizado."); } };
  // Player menu Download -> baixa a música atual
  el("miDown").onclick = async ()=>{
    if(!currentKey){ alert("Nada tocando."); return; }
    const def="Downloads"; const pname = prompt("Salvar em qual playlist off-line?", def) || def;
    try{ await downloadTrack(currentKey, currentName||currentKey.split('/').pop(), pname.trim()); alert("Baixada para uso off-line!"); renderDownloads(); }
    catch(e){ console.error(e); alert("Não foi possível baixar agora."); }
  };
  el("miCreatePl").onclick = ()=>{ const n=prompt("Nome da nova playlist:"); if(!n) return; createPlaylistInternal(n.trim()); renderMyPlaylists(); alert("Playlist criada!"); };
  el("miSavePl").onclick   = ()=>{ if(!currentKey){ alert("Nada tocando."); return; } openPlaylistPicker(currentKey); };

  async function playKey(key,name){
    // Se baixado, tocar do cache (off-line)
    const blob = await getCachedBlob(key);
    if(blob){
      audio.src = URL.createObjectURL(blob);
      currentKey = key; currentName=name; setNow(name,key);
      audio.play(); setPlayIcon(true);
      return;
    }
    // Senão, streaming normal
    const d = await api("/api/stream?key="+encodeURIComponent(key));
    audio.src = d.url; currentKey = key; currentName = name; setNow(name,key);
    audio.play(); setPlayIcon(true);
  }

  /* ===== PLAYLISTS (existentes) ===== */
  function myPlaylists(){ try{ return JSON.parse(localStorage.getItem("loove_playlists_v1")||"[]"); }catch{return []} }
  function saveMyPlaylists(v){ localStorage.setItem("loove_playlists_v1", JSON.stringify(v)); }
  function createPlaylistInternal(name){
    const pls = myPlaylists();
    if(pls.find(p=>p.name.toLowerCase()===name.toLowerCase())) return null;
    const pl = { id: Date.now().toString(36), name, items: [] };
    pls.push(pl); saveMyPlaylists(pls); return pl;
  }
  function openPlaylistPicker(key){
    const modal = el("plModal"), list = el("plList");
    list.innerHTML="";
    const pls = myPlaylists();
    if(!pls.length){ list.innerHTML = `<div class="muted">Você ainda não tem playlists.</div>`; }
    pls.forEach(pl=>{
      const r = document.createElement("div");
      r.className="pl-row";
      r.innerHTML = `<strong>${pl.name}</strong><span class="muted">${pl.items.length} músicas</span>`;
      r.onclick = ()=>{ pl.items.push(key); saveMyPlaylists(pls); modal.classList.remove("open"); alert("Adicionada!"); };
      list.appendChild(r);
    });
    modal.classList.add("open");
  }
  el("plClose").onclick = ()=> el("plModal").classList.remove("open");

  function renderMyPlaylists(){
    const g = el("myPlGrid"); g.innerHTML = "";
    const pls = myPlaylists();
    if(!pls.length){ g.innerHTML = `<div class="muted">Você ainda não criou playlists.</div>`; return; }
    pls.forEach(pl=>{
      const it = document.createElement("div");
      it.className="pl-item";
      it.textContent = pl.name;
      const dot = document.createElement("button");
      dot.className="pl-dot"; dot.textContent="⋯";
      const menu = document.createElement("div");
      menu.className="pl-menu";
      menu.innerHTML = `
        <button class="miPlay">Escutar Playlist</button>
        <button class="miRename">Renomear</button>
        <button class="miDelete">Excluir</button>
      `;
      it.appendChild(dot); it.appendChild(menu);
      it.onclick = ()=> alert(`${pl.name} • ${pl.items.length} músicas`);
      dot.onclick = (e)=>{ e.stopPropagation(); menu.classList.toggle("open"); };

      menu.querySelector(".miPlay").onclick = (e)=>{ e.stopPropagation(); menu.classList.remove("open");
        // tocar sequência da playlist (online)
        const seq = pl.items.slice();
        if(!seq.length){ alert("Playlist vazia."); return; }
        items = seq.map(k=>({key:k, name:k.split('/').pop()}));
        hide("viewHome"); hide("viewFavs"); hide("viewDownloads"); show("viewList"); renderList();
      };
      menu.querySelector(".miRename").onclick = (e)=>{ e.stopPropagation(); const n=prompt("Novo nome:", pl.name); if(!n) return; pl.name=n.trim(); saveMyPlaylists(pls); renderMyPlaylists(); };
      menu.querySelector(".miDelete").onclick = (e)=>{ e.stopPropagation(); if(!confirm("Excluir playlist?")) return; const idx=pls.findIndex(p=>p.id===pl.id); if(idx>=0){ pls.splice(idx,1); saveMyPlaylists(pls); renderMyPlaylists(); } };

      g.appendChild(it);
    });
  }

  /* ===== DOWNLOADS (NOVO) ===== */
  function getDL(){
    try{
      const d = JSON.parse(localStorage.getItem(DL_KEY)||"{}");
      return { playlists: d.playlists||[], singles: d.singles||[] };
    }catch{return {playlists:[], singles:[]}}
  }
  function setDL(v){ localStorage.setItem(DL_KEY, JSON.stringify(v)); }
  function isDownloaded(key){ const d=getDL(); return !!d.singles.find(s=>s.key===key); }

  async function getCache(){ return await caches.open(CACHE_AUD); }
  async function getCachedBlob(key){
    const c = await getCache();
    const req = new Request("https://loove-cache/"+encodeURIComponent(key));
    const match = await c.match(req);
    if(!match) return null;
    return await match.blob();
  }

  async function downloadTrack(key, name, plName="Downloads"){
    // 1) Obter URL assinada e baixar
    const d = await api("/api/stream?key="+encodeURIComponent(key));
    const res = await fetch(d.url, { credentials:"omit" });
    if(!res.ok) throw new Error("Falha no download");
    const blob = await res.blob();

    // 2) Guardar no Cache Storage com chave estável por key
    const c = await getCache();
    const req = new Request("https://loove-cache/"+encodeURIComponent(key));
    await c.put(req, new Response(blob, { headers:{ "Content-Type": res.headers.get("Content-Type")||"audio/mpeg" }}));

    // 3) Atualizar manifesto (localStorage)
    const man = getDL();
    if(plName){
      let pl = man.playlists.find(p=>p.name.toLowerCase()===plName.toLowerCase());
      if(!pl){ pl = { id: Date.now().toString(36), name: plName, items: [] }; man.playlists.push(pl); }
      if(!pl.items.includes(key)) pl.items.push(key);
    }
    if(!man.singles.find(s=>s.key===key)){
      man.singles.push({ key, name, ts: Date.now() });
    }
    setDL(man);
  }

  async function removeDownload(key){
    const man = getDL();
    man.singles = man.singles.filter(s=>s.key!==key);
    man.playlists.forEach(pl=> pl.items = pl.items.filter(k=>k!==key));
    // Se playlist ficou vazia, manter visível (pode renomear)? vamos remover vazias:
    man.playlists = man.playlists.filter(pl=>pl.items.length>0);
    setDL(man);
    // Remover do cache
    const c = await getCache();
    await c.delete(new Request("https://loove-cache/"+encodeURIComponent(key)));
  }

  function renderDownloads(){
    // Grid de playlists
    const g = el("dlPlGrid"); g.innerHTML = "";
    const man = getDL();
    if(!(man.playlists||[]).length){
      g.innerHTML = `<div class="muted">Nenhuma playlist off-line.</div>`;
    }else{
      man.playlists.forEach(pl=>{
        const it = document.createElement("div");
        it.className="pl-item";
        it.textContent = `${pl.name}`;
        const dot = document.createElement("button"); dot.className="pl-dot"; dot.textContent="⋯";
        const menu = document.createElement("div"); menu.className="pl-menu";
        menu.innerHTML = `
          <button class="miPlay">Escutar Playlist</button>
          <button class="miRename">Renomear</button>
          <button class="miDelete">Excluir</button>
        `;
        it.appendChild(dot); it.appendChild(menu);
        it.onclick = ()=> alert(`${pl.name} • ${pl.items.length} baixadas`);
        dot.onclick = (e)=>{ e.stopPropagation(); menu.classList.toggle("open"); };

        menu.querySelector(".miPlay").onclick = async (e)=>{
          e.stopPropagation(); menu.classList.remove("open");
          const seq = pl.items.slice();
          if(!seq.length){ alert("Playlist vazia."); return; }
          // montar lista local off-line
          items = seq.map(k=>({key:k, name: (man.singles.find(s=>s.key===k)?.name)||k.split('/').pop()}));
          hide("viewHome"); hide("viewFavs"); hide("viewPlaylists"); hide("viewDownloads"); show("viewList");
          renderList();
          // auto play a primeira via cache
          playKey(items[0].key, items[0].name);
        };
        menu.querySelector(".miRename").onclick = (e)=>{
          e.stopPropagation();
          const n = prompt("Novo nome:", pl.name); if(!n) return;
          pl.name = n.trim(); setDL(man); renderDownloads();
        };
        menu.querySelector(".miDelete").onclick = async (e)=>{
          e.stopPropagation();
          if(!confirm("Excluir playlist off-line?")) return;
          // remover entradas e cache dos itens
          for(const k of pl.items){ await removeDownload(k); }
          renderDownloads();
        };

        g.appendChild(it);
      });
    }

    // Singles baixadas
    const cont = el("dlSingles"); cont.innerHTML = "";
    if(!(man.singles||[]).length){
      cont.innerHTML = `<div class="muted">Nenhuma música baixada.</div>`;
    }else{
      const UL = document.createElement("ul");
      UL.style.listStyle="none"; UL.style.padding="0"; UL.style.margin="0";
      man.singles.slice().reverse().forEach(s=>{
        const LI = document.createElement("li");
        LI.className = "track";
        const left = document.createElement("div"); left.className="t-left";
        const bt = document.createElement("button"); bt.className="t-play"; bt.textContent="▶";
        bt.onclick = ()=> playKey(s.key, s.name);
        left.appendChild(bt);
        const mid = document.createElement("div"); mid.className="t-titleBox";
        const t1 = document.createElement("div"); t1.className="t-title"; t1.textContent=formatTitle(s.name);
        const t2 = document.createElement("div"); t2.className="t-sub"; t2.innerHTML=`<small>off-line</small>`;
        mid.appendChild(t1); mid.appendChild(t2);
        const right = document.createElement("div"); right.className="t-right";
        const rm = document.createElement("button"); rm.className="like"; rm.title="Excluir download"; rm.textContent="🗑️";
        rm.onclick = async ()=>{ if(!confirm("Excluir este download?")) return; await removeDownload(s.key); renderDownloads(); };
        right.appendChild(rm);
        LI.appendChild(left); LI.appendChild(mid); LI.appendChild(right);
        UL.appendChild(LI);
      });
      cont.appendChild(UL);
    }
  }

  /* ===== ÍCONES E MENU ===== */
  (function initUI(){
    el("searchIco").textContent = "🔎";
    el("pPrev").innerHTML = "⏮"; el("pNext").innerHTML = "⏭";
    el("pShuffle").innerHTML = "🔀"; el("pRepeat").innerHTML = icoRepeat();
    el("pVolume").innerHTML = icoVolume();
    el("pPlay").innerHTML = icoPlay();
    const av = document.getElementById("avatarIcon"); if(av) av.innerHTML = icoUser();

    el("miHome").innerHTML      = icoHome()     + ' Início';
    el("miAccount").innerHTML   = icoAccount()  + ' Conta';
    el("miSearch").innerHTML    = icoSearch()   + ' Buscar';
    el("miPlaylists").innerHTML = icoPlaylist() + ' Minhas playlists';
    el("miDowns").innerHTML     = icoDownload() + ' Downloads';
    el("miFavs").innerHTML      = icoStar()     + ' Favoritos';
    el("miBilling").innerHTML   = icoCard()     + ' Assinatura';
    el("miSettings").innerHTML  = icoSettings() + ' Configurações';
    el("miNotify").innerHTML    = icoBell()     + ' Notificações';
    el("miHelp").innerHTML      = icoHelp()     + ' Ajuda';
    el("miLogout").innerHTML    = icoLogout()   + ' Sair';

    el("userBtn").onclick = ()=>{ document.getElementById("userMenu").classList.toggle("open"); document.getElementById("menuBackdrop").style.display="block"; };
    document.getElementById("menuBackdrop").onclick = ()=>{ document.getElementById("userMenu").classList.remove("open"); document.getElementById("menuBackdrop").style.display="none"; };

    el("miHome").onclick=()=>{ document.getElementById("userMenu").classList.remove("open"); goHome(); };
    el("miPlaylists").onclick=()=>{ document.getElementById("userMenu").classList.remove("open"); hide("viewHome"); hide("viewList"); hide("viewFavs"); hide("viewDownloads"); show("viewPlaylists"); renderMyPlaylists(); };
    el("miDowns").onclick=()=>{ document.getElementById("userMenu").classList.remove("open"); hide("viewHome"); hide("viewList"); hide("viewFavs"); hide("viewPlaylists"); show("viewDownloads"); renderDownloads(); };
    el("miFavs").onclick=()=>{ document.getElementById("userMenu").classList.remove("open"); hide("viewHome"); hide("viewList"); hide("viewPlaylists"); hide("viewDownloads"); show("viewFavs"); };
  })();

  /* ===== ESTATÍSTICAS LOCAIS (mantido) ===== */
  (function(){
    const KEY = "loove_stats_v1";
    let start = Date.now();
    function save(){
      const sec = Math.floor((Date.now()-start)/1000);
      const d = new Date().toISOString().slice(0,10);
      let st={firstAt:d, secondsTotal:0, days:0, byDay:{}};
      try{ st=Object.assign(st, JSON.parse(localStorage.getItem(KEY)||"{}")); }catch{}
      st.secondsTotal = (st.secondsTotal||0) + sec;
      st.byDay[d] = (st.byDay?.[d]||0) + sec;
      st.days = Object.keys(st.byDay||{}).length;
      localStorage.setItem(KEY, JSON.stringify(st));
      start=Date.now();
    }
    window.addEventListener("beforeunload", save);
    setInterval(save, 30000);
  })();

  /* ===== BOOT ===== */
  ensureAuth();
</script>
</body>
</html>
