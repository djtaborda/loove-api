<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Loove ‚Ä¢ Notifica√ß√µes</title>
<style>
  :root{ --bg:#0b0f14; --card:#121826; --line:#ffffff1f; --text:#e6ecf2; --muted:#9aa4b2; --amber1:#ff9f1a; --amber2:#ff6a00; --ok:#29e36a; --red:#ff5a6b; }
  *{box-sizing:border-box}
  body{ margin:0; color:var(--text); background:var(--bg); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .wrap{max-width:900px; margin:0 auto; padding:18px 16px 80px}
  .btn{appearance:none; border:1px solid var(--line); background:#121b2b; color:#fff; padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer; text-decoration:none}
  .btn-primary{border:none; background:linear-gradient(180deg,var(--amber1),var(--amber2)); color:#0b0f14; box-shadow:0 10px 28px rgba(255,140,0,.35)}
  .btn-ghost{background:transparent}
  .card{background:linear-gradient(180deg,#121826,#0c111b); border:1px solid var(--line); border-radius:16px; padding:14px; margin:12px 0}
  h2,h3{margin:6px 0 10px}
  .grid{display:grid; grid-template-columns:1fr; gap:12px}
  @media(min-width:840px){ .grid{grid-template-columns:1fr 1fr} }
  .list{list-style:none; margin:0; padding:0}
  .li{padding:10px 0; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:10px}
  .kv{display:flex; align-items:center; gap:8px}
  label{font-size:12px; color:var(--muted); font-weight:800}
  input[type="time"], select{padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0d1320; color:#fff}
  .chip{padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#0e1522; color:#cfe3ff; cursor:pointer; font-weight:800}
  .chip.active{background:linear-gradient(180deg,var(--amber1),var(--amber2)); color:#0b0f14; border:none}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .note{color:var(--muted); font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
      <a class="btn" href="/">‚üµ App</a>
      <div style="display:flex; gap:8px">
        <button id="btnTest" class="btn">üîî Testar push</button>
        <button id="btnSave" class="btn btn-primary">Salvar Prefer√™ncias</button>
      </div>
    </div>

    <section class="grid">
      <!-- Canais -->
      <div class="card">
        <h3>Canais</h3>
        <div class="li"><span>Push (navegador)</span><input id="chPush" type="checkbox"></div>
        <div class="li"><span>E-mail</span><input id="chEmail" type="checkbox" checked></div>
        <div class="li"><span>SMS</span><input id="chSms" type="checkbox"></div>
        <div class="note">Para receber push, aceite a permiss√£o do navegador e registre o Service Worker.</div>
        <div style="display:flex; gap:8px; margin-top:10px">
          <button id="btnEnablePush" class="btn">Ativar Push</button>
          <button id="btnDisablePush" class="btn btn-ghost">Desativar Push</button>
        </div>
      </div>

      <!-- Categorias -->
      <div class="card">
        <h3>Quero receber sobre</h3>
        <div id="chipsCats" class="chips"></div>
        <div class="note">Use as categorias para personalizar: enviaremos s√≥ o que importa pra voc√™.</div>
      </div>

      <!-- Frequ√™ncia -->
      <div class="card">
        <h3>Frequ√™ncia</h3>
        <div class="li"><span>Entrega</span>
          <select id="freq">
            <option value="instant">Imediata</option>
            <option value="daily">Di√°ria</option>
            <option value="weekly">Semanal</option>
            <option value="monthly">Mensal</option>
            <option value="mute">Silenciada</option>
          </select>
        </div>
        <div class="li"><span>Resumo di√°rio (hor√°rio)</span><input id="dailyTime" type="time" value="09:00"></div>
      </div>

      <!-- N√£o incomodar -->
      <div class="card">
        <h3>N√£o incomodar</h3>
        <div class="li"><span>Ativar per√≠odo silencioso</span><input id="dndOn" type="checkbox"></div>
        <div class="li"><span>Das</span><input id="dndStart" type="time" value="22:00"> <span>√†s</span> <input id="dndEnd" type="time" value="08:00"></div>
        <div class="li"><span>Dias</span>
          <div class="chips" id="dndDays"></div>
        </div>
        <div class="note">Se um push chegar dentro do per√≠odo, n√≥s seguramos e mostramos depois.</div>
      </div>

      <!-- Assinatura & Marketing -->
      <div class="card">
        <h3>Assinatura e promo√ß√µes</h3>
        <div class="li"><span>Ofertas e descontos</span><input id="mkDeals" type="checkbox" checked></div>
        <div class="li"><span>Lembretes de renova√ß√£o</span><input id="mkBilling" type="checkbox" checked></div>
      </div>
    </section>
  </div>

<script>
  const NOTIFY_KEY = "loove_notifications_v2";
  const SW_PATH = "/sw.js";
  const CATEGORIES = ["Lan√ßamentos","Novas playlists","Atualiza√ß√µes do app","Recomenda√ß√µes","Shows & eventos","Dicas & recursos"];
  const DND_DAYS = ["Seg","Ter","Qua","Qui","Sex","S√°b","Dom"];

  const $ = id => document.getElementById(id);
  const chipsCats = $("chipsCats");
  const dndDays = $("dndDays");

  // render chips
  function renderChips(container, items, selected){
    container.innerHTML="";
    items.forEach(txt=>{
      const b=document.createElement("button");
      b.type="button"; b.className="chip"+(selected.includes(txt)?" active":""); b.textContent=txt;
      b.onclick=()=> b.classList.toggle("active");
      container.appendChild(b);
    });
  }

  function loadPrefs(){
    let p = {
      chPush:false, chEmail:true, chSms:false,
      categories:["Lan√ßamentos","Novas playlists"],
      freq:"instant", dailyTime:"09:00",
      dndOn:false, dndStart:"22:00", dndEnd:"08:00", dndDays:["S√°b","Dom"],
      mkDeals:true, mkBilling:true
    };
    try{ p = {...p, ...JSON.parse(localStorage.getItem(NOTIFY_KEY)||"{}")} }catch{}
    return p;
  }
  function savePrefs(P){
    localStorage.setItem(NOTIFY_KEY, JSON.stringify(P));
  }

  // UI <-> State
  const P = loadPrefs();
  renderChips(chipsCats, CATEGORIES, P.categories);
  renderChips(dndDays, DND_DAYS, P.dndDays);

  $("chPush").checked = P.chPush;
  $("chEmail").checked = P.chEmail;
  $("chSms").checked = P.chSms;
  $("freq").value = P.freq;
  $("dailyTime").value = P.dailyTime;
  $("dndOn").checked = P.dndOn;
  $("dndStart").value = P.dndStart;
  $("dndEnd").value = P.dndEnd;

  // Save
  $("btnSave").onclick = ()=>{
    const cats = [...chipsCats.querySelectorAll(".chip.active")].map(b=>b.textContent);
    const days = [...dndDays.querySelectorAll(".chip.active")].map(b=>b.textContent);
    const next = {
      chPush:$("chPush").checked,
      chEmail:$("chEmail").checked,
      chSms:$("chSms").checked,
      categories:cats,
      freq:$("freq").value,
      dailyTime:$("dailyTime").value,
      dndOn:$("dndOn").checked,
      dndStart:$("dndStart").value,
      dndEnd:$("dndEnd").value,
      dndDays:days,
      mkDeals:$("mkDeals").checked,
      mkBilling:$("mkBilling").checked
    };
    savePrefs(next);
    alert("Prefer√™ncias salvas!");
  };

  // Push helpers
  async function ensureSW(){
    if(!("serviceWorker" in navigator)) throw new Error("Service Worker n√£o suportado");
    const reg = await navigator.serviceWorker.register(SW_PATH);
    return reg;
  }
  async function askPermission(){
    if(!("Notification" in window)) throw new Error("Notifica√ß√£o n√£o suportada");
    if(Notification.permission==="granted") return "granted";
    const res = await Notification.requestPermission();
    return res;
  }
  $("btnEnablePush").onclick = async ()=>{
    try{
      const perm = await askPermission();
      if(perm!=="granted"){ alert("Permiss√£o de notifica√ß√£o negada."); return; }
      await ensureSW();
      $("chPush").checked = true;
      alert("Push habilitado neste dispositivo.");
    }catch(e){ alert("Falha ao habilitar push: "+(e.message||e)); }
  };
  $("btnDisablePush").onclick = async ()=>{
    try{
      if("serviceWorker" in navigator){
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r=>r.unregister()));
      }
      $("chPush").checked = false;
      alert("Push desativado neste dispositivo.");
    }catch{ alert("N√£o foi poss√≠vel desativar push."); }
  };

  // Test notification (respeita DND)
  function inDND(){
    if(!$("dndOn").checked) return false;
    const now = new Date();
    const dayNames = ["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];
    const today = dayNames[now.getDay()];
    const sel = [...dndDays.querySelectorAll(".chip.active")].map(b=>b.textContent);
    if(sel.length && !sel.includes(today)) return false;
    const toMinutes = (t)=>{ const [h,m]=t.split(":").map(Number); return h*60+m; };
    const cur = now.getHours()*60 + now.getMinutes();
    let a = toMinutes($("dndStart").value), b = toMinutes($("dndEnd").value);
    if(a<b){ return cur>=a && cur<b; } // mesmo dia
    return (cur>=a || cur<b); // atravessa meia-noite
  }
  $("btnTest").onclick = async ()=>{
    try{
      const perm = await askPermission();
      if(perm!=="granted"){ alert("Permiss√£o negada."); return; }
      const reg = await ensureSW();
      if(inDND()){
        alert("Agora est√° dentro do per√≠odo silencioso (N√£o incomodar). Notifica√ß√£o real seria adiada.");
        return;
      }
      reg.showNotification("Loove", { body:"Seu push est√° funcionando! üîä", icon:"/loove-logo.png" });
    }catch(e){ alert("N√£o foi poss√≠vel enviar a notifica√ß√£o de teste: "+(e.message||e)); }
  };
</script>
</body>
</html>
